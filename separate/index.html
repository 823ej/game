<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#121418">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Midnight Detective RPG</title>
    
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="utility-dock">
    <div class="utility-dock-inner">
        <div id="game-info" class="utility-pill">Lv.1 | 0 | 30/30 | 100/100</div>

        <div id="top-scenario-info" class="scenario-pill hidden">
            <span id="sc-title-mini">의뢰명 | 0%</span>
        </div>

        <div id="doom-pill" class="utility-pill hidden">Doom 0%</div>

        <div class="utility-buttons">
            <button id="btn-player-stats" class="small-btn" onclick="openPlayerStats()">🧬</button>
            <button id="btn-card-collection" class="small-btn" onclick="openAllCards()">🃏</button>
            <button id="btn-main-inventory" class="small-btn" onclick="openInventory()">🎒</button>
            <button class="small-btn" onclick="toggleFullScreen()">⛶</button>
            <button class="small-btn" style="background:#c0392b; border-color:#e74c3c;" onclick="confirmReset()">🗑️</button>
        </div>
    </div>
</div>

<div class="container">
    <div id="char-creation-scene" class="scene hidden char-creation-scene">
        <div id="char-creation-content" class="char-creation-content">
        </div>
    </div>
    <div id="inventory-overlay" class="inventory-overlay hidden" onclick="closeInventory()">
        <div class="inventory-panel" onclick="event.stopPropagation()">
            
            <div class="inventory-header-tabs">
                <button id="tab-consume" class="inv-tab active" onclick="switchInvTab('consume')">
                    🎒 소모품 <span id="cnt-consume" style="font-size:0.8em">(0/6)</span>
                </button>
                <button id="tab-relic" class="inv-tab" onclick="switchInvTab('relic')">
                    💍 유물 <span id="cnt-relic" style="font-size:0.8em">(0)</span>
                </button>
                <button class="small-btn close-inv-btn" onclick="closeInventory()">✖</button>
            </div>

            <div class="inventory-body">
                <div class="item-list" id="inventory-list">
                    </div>
            </div>
            
            <div style="font-size:0.8em; color:#777; margin-top:5px;">
                아이템을 클릭하여 사용하거나 정보를 확인하세요.
            </div>
        </div>
    </div>
    <div id="card-collection-overlay" class="inventory-overlay hidden" onclick="closeCardCollection()">
        <div class="inventory-panel" onclick="event.stopPropagation()" style="height: 600px;"> <div class="inventory-header-tabs">
                <button id="tab-col-battle" class="inv-tab active" onclick="switchCollectionTab('battle')">
                    ⚔️ 전투 덱 <span id="cnt-col-battle" style="font-size:0.8em">(0)</span>
                </button>
                <button id="tab-col-social" class="inv-tab" onclick="switchCollectionTab('social')">
                    💬 소셜 덱 <span id="cnt-col-social" style="font-size:0.8em">(0)</span>
                </button>
                <button class="small-btn close-inv-btn" onclick="closeCardCollection()">✖</button>
            </div>

            <div class="inventory-body">
                <div class="card-list-grid" id="collection-list">
                    </div>
            </div>
        </div>
    </div>
    <div id="minimap-overlay" class="inventory-overlay hidden" onclick="toggleMinimap()">
    <div class="inventory-panel" style="height:auto; max-width:600px; padding:20px;" onclick="event.stopPropagation()">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:#f1c40f;">🗺️ 지역 지도</h3>
            <button class="small-btn" onclick="toggleMinimap()">✖</button>
        </div>

        <div style="background:#111; padding:20px; border-radius:10px; border:2px solid #444; overflow:auto;">
            <div id="minimap-grid" class="minimap-grid"></div>
        </div>

        <div style="margin-top:10px; font-size:0.9em; color:#aaa;">
            <span style="color:#f1c40f">■</span> 현재 위치 / <span style="color:#555">■</span> 미방문 / <span style="color:#ddd">■</span> 방문함
        </div>
    </div>
</div>
    <div id="hub-scene" class="scene hidden hub-scene">
        <div class="hub-illustration"></div>
        <div class="hub-overlay-gradient"></div>

        <div class="hub-content">
            <div class="hub-hero">
                <div class="hub-copy">
                    <p class="hub-tag">MIDNIGHT OFFICE</p>
                    <h1>🕵️ 심야 탐정 사무소</h1>
                    <p class="hub-sub">도시의 어둠을 밝히는 유일한 불빛</p>
                </div>
            </div>

            <div class="hub-actions">
                <div class="hub-grid">
                    <button class="hub-card" onclick="openCaseFiles()">
                        <div class="hub-card-title">📁 사건 파일 (출동)</div>
                        <div class="hub-card-desc">의뢰를 선택하고 현장으로 나갑니다.</div>
                    </button>
                    <button class="hub-card" onclick="renderCityMap()">
                        <div class="hub-card-title">🗺️ 도시로 외출</div>
                        <div class="hub-card-desc">사건 현장이나 상점으로 이동합니다.</div>
                    </button>
                    <button class="hub-card" onclick="hubRest()">
                        <div class="hub-card-title">☕ 커피 한 잔 (회복)</div>
                        <div class="hub-card-desc">체력과 이성을 회복합니다. (500원)</div>
                    </button>
                    <button class="hub-card" onclick="renderShopScreen('shop_internet')">
                        <div class="hub-card-title">📦 인터넷 주문 (상점)</div>
                        <div class="hub-card-desc">장비를 구매합니다.</div>
                    </button>
                    <button class="hub-card" onclick="openDeckManager()">
                        <div class="hub-card-title">🃏 덱 정비 (카드)</div>
                        <div class="hub-card-desc">전투용/대화용 덱을 편집합니다.</div>
                    </button>
                    <button class="hub-card" onclick="openStorage()">
                        <div class="hub-card-title">📦 창고 (보관함)</div>
                        <div class="hub-card-desc">아이템과 유물을 보관합니다.<br><span style="color:#777; font-size:0.9em;">(보관 중인 유물은 효과가 꺼집니다)</span></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
<div id="deck-scene" class="scene hidden" style="background:#222;">
    <div style="padding:10px; background:#333; box-shadow:0 2px 5px rgba(0,0,0,0.5); display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0; color:#eee;">🃏 덱 관리</h2>
        <div>
            <button id="tab-battle" class="small-btn" style="background:#e74c3c; font-weight:bold;" onclick="switchDeckMode('battle')">⚔️ 전투 덱</button>
            <button id="tab-social" class="small-btn" style="background:#8e44ad; font-weight:bold; opacity:0.5;" onclick="switchDeckMode('social')">💬 소셜 덱</button>
        </div>
        <button class="small-btn" onclick="renderHub()">❌ 닫기</button>
    </div>

    <div class="deck-builder-container">
        <div class="deck-column">
            <div class="deck-header">
                <h3>장착 중 (<span id="deck-count">0</span>)</h3>
                <span style="font-size:0.8em; color:#aaa;">전투에 가져갈 카드입니다.</span>
            </div>
            <div id="active-deck-list" class="card-grid"></div>
        </div>

        <div style="display:flex; align-items:center; color:#555; font-size:2em;">⇄</div>

        <div class="deck-column" style="background:#2c3e50;">
            <div class="deck-header">
                <h3>보관함 (<span id="storage-count">0</span>)</h3>
                <span style="font-size:0.8em; color:#aaa;">대기 중인 카드입니다.</span>
            </div>
            <div id="storage-list" class="card-grid"></div>
        </div>
    </div>
</div>
<div id="storage-scene" class="scene hidden" style="background:#222;">
    <div style="padding:10px; background:#333; box-shadow:0 2px 5px rgba(0,0,0,0.5); display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0; color:#f39c12; font-size:1.2em;">📦 개인 창고</h2>
        
        <div>
            <button id="tab-storage-consume" class="small-btn" style="background:#27ae60; font-weight:bold;" onclick="switchStorageMode('consume')">🎒 소모품</button>
            <button id="tab-storage-relic" class="small-btn" style="background:#e67e22; font-weight:bold; opacity:0.5;" onclick="switchStorageMode('relic')">💍 유물</button>
        </div>

        <button class="small-btn" onclick="renderHub()">❌ 나가기</button>
    </div>

    <div class="deck-builder-container">
        <div class="deck-column">
            <div class="deck-header">
                <h3 id="storage-bag-title">🎒 가방</h3>
                <span style="font-size:0.8em; color:#aaa;">현재 소지 중</span>
            </div>
            <div id="storage-bag-list" class="card-grid" style="display:flex; flex-wrap:wrap; align-content:flex-start; gap:5px;"></div>
        </div>

        <div style="display:flex; align-items:center; justify-content:center; color:#555; font-size:2em; width:40px;">⇄</div>

        <div class="deck-column" style="background:#1f2a36;">
            <div class="deck-header">
                <h3 id="storage-wh-title">📦 창고</h3>
                <span style="font-size:0.8em; color:#aaa;">보관 중 (유물 효과 꺼짐)</span>
            </div>
            <div id="storage-warehouse-list" class="card-grid" style="display:flex; flex-wrap:wrap; align-content:flex-start; gap:5px;"></div>
        </div>
    </div>
</div>

<div id="city-scene" class="scene hidden" style="background:#111; align-items:center;">
    <h2 style="color:#f1c40f; margin-bottom:10px;">🌃 나이트 시티 지도</h2>
    <p style="color:#777; margin-bottom:20px;">이동할 구역을 선택하세요.</p>
    
    <div id="district-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; width:100%; max-width:700px; padding:10px;">
        </div>

    <button class="action-btn" style="margin-top:20px; background:#7f8c8d;" onclick="renderHub()">🏠 사무소 복귀</button>
</div>
<div id="exploration-scene" class="scene hidden">
   <div class="stage-view" id="dungeon-stage">
        <div id="layer-bg" class="parallax-layer"></div>
        
       <div id="layer-char" class="parallax-layer" style="z-index:20; display:flex; align-items:flex-end; justify-content:center; height:100%;">
    
            <div id="dungeon-player-wrapper" style="transition:0.3s; display:flex; flex-direction:column; align-items:center;">
                <img id="dungeon-player" src="assets/player.png" alt="Player" style="width:130px; object-fit: contain;">
                <div id="player-hud" style="width:120px; margin-top:5px; text-shadow: 1px 1px 2px black;"></div>
            </div>

            <div id="dungeon-object" class="room-object hidden" onclick="DungeonSystem.interactWithObject()">
                <div id="dungeon-obj-icon">📦</div>
                <div id="dungeon-obj-label">조사하기</div>
            </div>

            <div id="dungeon-enemies" class="enemies-wrapper" style="display:flex; gap:10px;"></div>
    
            <div id="interaction-bubble" class="hidden" style="position:absolute; bottom:150px; background:#f1c40f; color:#000; padding:5px 10px; border-radius:10px; font-weight:bold; cursor:pointer;" onclick="triggerInteraction()">! 조사하기</div>
        </div>
    
        <div id="layer-fg" class="parallax-layer"></div>
        <button onclick="toggleMinimap()" style="position:absolute; top:10px; right:10px; z-index:100;" class="small-btn">🗺️ 지도</button>
    </div>

    <div class="move-controls" style="display:flex; justify-content:space-between; align-items:center; padding:0 20px; margin-top:-30px; position:relative; z-index:50;">
        <button class="move-btn" onmousedown="startMove(-1)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startMove(-1)" ontouchend="stopMove()">⬅</button>
        
        <div style="text-align:center; background:rgba(0,0,0,0.7); padding:5px 15px; border-radius:15px; border:1px solid #555;">
            <div id="loc-name" style="color:#f1c40f; font-weight:bold;">던전 입구</div>
            <div id="loc-coords" style="font-size:0.8em; color:#aaa;">1F (0,0)</div>
        </div>

        <button class="move-btn" onmousedown="startMove(1)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startMove(1)" ontouchend="stopMove()">➡</button>
    </div>
    <div id="loc-desc" class="loc-text exploration-ui" style="position:relative; background:#222; border-radius:5px; margin-bottom:10px; border:1px solid #444;">
        주변을 둘러봅니다.
    </div>
         <div id="turn-timeline" class="timeline-container battle-ui hidden"></div>
             <div class="pile-buttons battle-ui hidden">
        <button id="btn-draw-pile-floating" class="small-btn pile-btn" onclick="openPileView('draw')">덱(0)</button>
        <div class="pile-btn-stack">
            <button id="btn-exhaust-pile-floating" class="small-btn pile-btn" onclick="openPileView('exhaust')">소멸(0)</button>
            <button id="btn-discard-pile-floating" class="small-btn pile-btn" onclick="openPileView('discard')">버림(0)</button>
        </div>
    </div>
    <div class="action-grid exploration-ui" id="dungeon-actions">
       <button class="action-btn" onclick="DungeonSystem.checkRoomEvent()">조사</button>
        <button class="action-btn" onclick="openInventory()">🎒 가방</button>
        <button class="action-btn" onclick="confirmRetreat()">🏃 탈출</button>
    </div>
      <div class="control-group battle-ui hidden">
        
        <div id="ap-indicator">
            <div class="ap-inner">
                <span id="ap-val">3</span>
                <span class="ap-sep">/</span>
                <span id="ap-max">3</span>
            </div>
            <div class="ap-label">AP</div>
        </div>
        <div class="log-area" id="log-box"></div>
        <button id="end-turn-btn" class="action-btn btn-end-turn-side" onclick="endPlayerTurn()">
            턴<br>종료
        </button>
    </div>

    <div class="hand-area battle-ui hidden" id="hand-container"></div>

</div>

<!-- 이벤트/휴식/기타 전용 장면 (switchScene('event')) -->
<div id="event-scene" class="scene hidden" style="background:#111; padding:20px;">
    <div id="event-content-box" class="event-box"></div>
</div>


    <div id="result-scene" class="scene hidden" style="background:#111; justify-content:center; align-items:center;">
        <div style="text-align:center; animation: fadeIn 1s;">
            <h1 style="color:#f1c40f; font-size:3em; margin-bottom:10px; text-shadow:0 0 10px #f1c40f;">MISSION COMPLETE</h1>
            <p style="color:#aaa; margin-bottom:40px;">의뢰를 성공적으로 완수했습니다.</p>
            
            <div style="background:#222; padding:30px; border-radius:10px; border:1px solid #444; width:300px; margin:0 auto; text-align:left;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>💰 의뢰비:</span> <span id="res-gold" style="color:#f1c40f; font-weight:bold;">0 원</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>✨ 경험치:</span> <span id="res-xp" style="color:#3498db; font-weight:bold;">0 XP</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>🎁 특별 보상:</span> <span id="res-item" style="color:#2ecc71;">없음</span>
                </div>
            </div>

            <button class="action-btn" style="margin-top:40px; width:200px;" onclick="returnToHub()">🏠 사무소로 복귀</button>
        </div>
    </div>
    </div> ```


<div id="story-scene" class="scene hidden" style="background:#000; position:relative; overflow:hidden;">
        <div id="story-bg" style="position:absolute; top:0; left:0; width:100%; height:100%; background-size:cover; background-position:center; opacity:0.5;"></div>
        
        <div id="story-standing" style="position:absolute; bottom:0; width:100%; height:100%; display:flex; justify-content:center; align-items:flex-end; pointer-events:none;">
            </div>

        <div class="dialog-container" onclick="nextDialog()">
            <div id="story-name" class="name-tag">이름</div>
            <div id="story-text" class="dialog-text">대사가 출력됩니다.</div>
            <div class="next-icon">▼</div>
        </div>

        <div id="story-choice-overlay" style="display:none;">
        </div>
</div>

<div id="popup-layer">
    <div class="popup-box" onclick="event.stopPropagation()">
        <h2 id="popup-title" style="color:#f1c40f;">제목</h2>
        <div id="popup-desc" style="font-size:1.1em; color:#ddd; margin:10px 0;">내용</div>
        <div id="popup-content"></div>
        <div class="popup-btns" id="popup-buttons"></div>
    </div>
</div>

    <script src="data.js"></script>
    <script src="dungeon.js"></script>
    <script src="game.js"></script>
    <script src="story.js"></script>
    <script>
        // file://에서는 ServiceWorker/PWA가 막히므로 http/https에서만 등록
        const proto = location.protocol;
        const canUseSW = proto === 'https:' || proto === 'http:';
        if (canUseSW && 'serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(console.error);
            });
        } else {
            console.log('ServiceWorker skipped (requires http/https)');
        }
    </script>
<svg id="drag-layer" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; display:none;">
    <path id="drag-path" d="" stroke="#f1c40f" stroke-width="4" fill="none" stroke-dasharray="10,5" stroke-linecap="round" />
    <circle id="drag-head" cx="0" cy="0" r="8" fill="#e74c3c" stroke="#fff" stroke-width="2" />
</svg>
</body>
</html>
