<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#121418">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Midnight Detective RPG</title>

    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="stylesheet" href="style.css?v=7">
</head>

<body>
    <div class="utility-dock">
        <div class="utility-dock-inner">
            <div id="game-info" class="utility-pill"></div>

            <div id="top-scenario-info" class="scenario-pill hidden">
                <span id="sc-title-mini"></span>
            </div>

            <div id="doom-pill" class="utility-pill hidden"></div>

            <div class="utility-buttons">
                <button id="btn-game-menu" class="small-btn" onclick="openGameMenu()">≡</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="start-scene" class="scene hidden start-scene">
            <div class="start-content">
                <h1 class="game-title">MIDNIGHT DETECTIVE</h1>
                <p class="game-subtitle">The City of Shadows</p>

                <div class="start-menu">
                    <button id="btn-continue" class="action-btn hidden" onclick="loadGame()"></button>
                    <button id="btn-new-game" class="action-btn" onclick="startCharacterCreation()"></button>
                    <button id="btn-infinite-mode" class="action-btn" onclick="startInfiniteJobSelection()"></button>
                </div>
                <div class="version-info">Ver 2.5</div>
            </div>
        </div>
        <div id="char-creation-scene" class="scene hidden char-creation-scene">
            <div id="char-creation-content" class="char-creation-content">
            </div>
        </div>
        <div id="inventory-overlay" class="inventory-overlay hidden" onclick="closeInventory()">
            <div class="inventory-panel" onclick="event.stopPropagation()">

                <div class="inventory-header-tabs">
                    <button id="tab-consume" class="inv-tab active" onclick="switchInvTab('consume')"></button>
                    <button id="tab-equip" class="inv-tab" onclick="switchInvTab('equip')"></button>
                    <button id="tab-relic" class="inv-tab" onclick="switchInvTab('relic')"></button>
                    <button class="small-btn close-inv-btn" onclick="closeInventory()">✖</button>
                </div>

                <div class="inventory-body">
                    <div id="inventory-equipment-panel" class="equipment-panel" style="display:none;"></div>
                    <div class="item-list" id="inventory-list">
                    </div>
                </div>

                <div id="inventory-hint" style="font-size:0.8em; color:#777; margin-top:5px;"></div>
            </div>
        </div>
        <div id="game-menu-overlay" class="game-menu-overlay hidden" onclick="closeGameMenu()">
            <div class="game-menu-panel" onclick="event.stopPropagation()">
                <div class="game-menu-header">
                    <div id="game-menu-title" class="game-menu-title">GAME MENU</div>
                </div>
                <div class="game-menu-nav-row">
                    <button id="game-menu-prev" class="small-btn hidden" onclick="showGameMenuPrev()">←</button>
                    <button id="game-menu-next" class="small-btn hidden" onclick="showGameMenuNext()">→</button>
                </div>
                <div class="game-menu-body">
                    <div id="game-menu-home" class="game-menu-grid menu-home-vertical">
                        <button id="menu-tile-status" class="menu-tile" onclick="openGameMenuAction('status')">
                            <div class="menu-tile-icon">🧬</div>
                            <div id="menu-tile-status-title" class="menu-tile-title"></div>
                            <div id="menu-tile-status-desc" class="menu-tile-desc"></div>
                        </button>
                        <button id="menu-tile-inventory" class="menu-tile" onclick="openGameMenuAction('inventory')">
                            <div class="menu-tile-icon">🎒</div>
                            <div id="menu-tile-inventory-title" class="menu-tile-title"></div>
                            <div id="menu-tile-inventory-desc" class="menu-tile-desc"></div>
                        </button>
                        <button id="menu-tile-cards" class="menu-tile" onclick="openGameMenuAction('cards')">
                            <div class="menu-tile-icon">🃏</div>
                            <div id="menu-tile-cards-title" class="menu-tile-title"></div>
                            <div id="menu-tile-cards-desc" class="menu-tile-desc"></div>
                        </button>
                        <button id="menu-tile-missions" class="menu-tile" onclick="openGameMenuAction('missions')">
                            <div class="menu-tile-icon">📌</div>
                            <div id="menu-tile-missions-title" class="menu-tile-title"></div>
                            <div id="menu-tile-missions-desc" class="menu-tile-desc"></div>
                        </button>
                        <button id="menu-tile-options" class="menu-tile" onclick="openGameMenuAction('options')">
                            <div class="menu-tile-icon">⚙️</div>
                            <div id="menu-tile-options-title" class="menu-tile-title"></div>
                            <div id="menu-tile-options-desc" class="menu-tile-desc"></div>
                        </button>
                        <button id="menu-tile-reset" class="menu-tile danger" onclick="openGameMenuAction('reset')">
                            <div class="menu-tile-icon">🗑️</div>
                            <div id="menu-tile-reset-title" class="menu-tile-title"></div>
                            <div id="menu-tile-reset-desc" class="menu-tile-desc"></div>
                        </button>
                        <button id="menu-tile-fullscreen" class="menu-tile" onclick="openGameMenuAction('fullscreen')">
                            <div class="menu-tile-icon">⛶</div>
                            <div id="menu-tile-fullscreen-title" class="menu-tile-title"></div>
                            <div id="menu-tile-fullscreen-desc" class="menu-tile-desc"></div>
                        </button>
                    </div>
                    <div id="game-menu-content" class="game-menu-content hidden"></div>
                </div>
                <div class="game-menu-footer">
                    <button id="game-menu-back" class="small-btn hidden" onclick="showGameMenuHome()">←</button>
                    <button class="small-btn" onclick="closeGameMenu()">✖</button>
                </div>
            </div>
        </div>
        <div id="card-collection-overlay" class="inventory-overlay hidden" onclick="closeCardCollection()">
            <div class="inventory-panel" onclick="event.stopPropagation()" style="height: 600px;">
                <div class="inventory-header-tabs">
                    <button id="tab-col-battle" class="inv-tab active" onclick="switchCollectionTab('battle')">
                        <span id="tab-col-battle-label"></span> <span id="cnt-col-battle" style="font-size:0.8em">(0)</span>
                    </button>
                    <button id="tab-col-social" class="inv-tab" onclick="switchCollectionTab('social')">
                        <span id="tab-col-social-label"></span> <span id="cnt-col-social" style="font-size:0.8em">(0)</span>
                    </button>
                    <button class="small-btn close-inv-btn" onclick="closeCardCollection()">✖</button>
                </div>

                <div class="inventory-body">
                    <div class="card-list-grid" id="collection-list">
                    </div>
                </div>
            </div>
        </div>
        <div id="minimap-overlay" class="inventory-overlay hidden" onclick="toggleMinimap()">
            <div class="inventory-panel" style="height:auto; max-width:600px; padding:20px;"
                onclick="event.stopPropagation()">

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 id="minimap-title" style="margin:0; color:#f1c40f;"></h3>
                    <button class="small-btn" onclick="toggleMinimap()">✖</button>
                </div>

                <div style="background:#111; padding:20px; border-radius:10px; border:2px solid #444; overflow:auto;">
                    <div id="minimap-grid" class="minimap-grid"></div>
                </div>

                <div id="minimap-legend" style="margin-top:10px; font-size:0.9em; color:#aaa;"></div>
            </div>
        </div>
        <div id="hub-scene" class="scene hidden hub-scene">
            <div id="hub-shell" class="city-hybrid-shell panel-hidden">
                <div class="city-left-info">
                    <div id="hub-left-title" class="city-left-title"></div>
                    <div id="hub-left-desc" class="city-left-desc"></div>
                </div>
                <div id="hub-map" class="city-area-map hub-map">
                    <div id="hub-object-layer" class="city-area-object-layer"></div>
                </div>
                <div class="city-detail-panel is-hidden" id="hub-detail-panel">
                    <div class="city-dialogue">
                        <div class="city-dialogue-log" id="hub-dialogue-log"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="deck-scene" class="scene hidden" style="background:#222;">
            <div
                style="padding:10px; background:#333; box-shadow:0 2px 5px rgba(0,0,0,0.5); display:flex; justify-content:space-between; align-items:center;">
                <h2 id="deck-title" style="margin:0; color:#eee;"></h2>
                <div>
                    <button id="tab-battle" class="small-btn" style="background:#e74c3c; font-weight:bold;"
                        onclick="switchDeckMode('battle')"></button>
                    <button id="tab-social" class="small-btn" style="background:#8e44ad; font-weight:bold; opacity:0.5;"
                        onclick="switchDeckMode('social')"></button>
                </div>
                <button id="deck-close" class="small-btn" onclick="renderHub()"></button>
            </div>

            <div class="deck-builder-container">
                <div class="deck-column">
                    <div class="deck-header">
                        <h3><span id="deck-active-label"></span> (<span id="deck-count">0</span>)</h3>
                        <span id="deck-active-help" style="font-size:0.8em; color:#aaa;"></span>
                    </div>
                    <div id="active-deck-list" class="card-grid"></div>
                </div>

                <div style="display:flex; align-items:center; color:#555; font-size:2em;">⇄</div>

                <div class="deck-column" style="background:#2c3e50;">
                    <div class="deck-header">
                        <h3><span id="deck-storage-label"></span> (<span id="storage-count">0</span>)</h3>
                        <span id="deck-storage-help" style="font-size:0.8em; color:#aaa;"></span>
                    </div>
                    <div id="storage-list" class="card-grid"></div>
                </div>
            </div>
        </div>
        <div id="storage-scene" class="scene hidden" style="background:#222;">
            <div
                style="padding:10px; background:#333; box-shadow:0 2px 5px rgba(0,0,0,0.5); display:flex; justify-content:space-between; align-items:center;">
                <h2 id="storage-title" style="margin:0; color:#f39c12; font-size:1.2em;"></h2>

                <div>
                    <button id="tab-storage-consume" class="small-btn" style="background:#27ae60; font-weight:bold;"
                        onclick="switchStorageMode('consume')"></button>
                    <button id="tab-storage-equip" class="small-btn"
                        style="background:#3498db; font-weight:bold; opacity:0.5;"
                        onclick="switchStorageMode('equip')"></button>
                    <button id="tab-storage-relic" class="small-btn"
                        style="background:#e67e22; font-weight:bold; opacity:0.5;"
                        onclick="switchStorageMode('relic')"></button>
                </div>

                <button id="storage-exit" class="small-btn" onclick="renderHub()"></button>
            </div>

            <div class="deck-builder-container">
                <div class="deck-column">
                    <div class="deck-header">
                        <h3 id="storage-bag-title"></h3>
                        <span id="storage-bag-desc" style="font-size:0.8em; color:#aaa;"></span>
                    </div>
                    <div id="storage-bag-list" class="card-grid"
                        style="display:flex; flex-wrap:wrap; align-content:flex-start; gap:5px;"></div>
                </div>

                <div
                    style="display:flex; align-items:center; justify-content:center; color:#555; font-size:2em; width:40px;">
                    ⇄</div>

                <div class="deck-column" style="background:#1f2a36;">
                    <div class="deck-header">
                        <h3 id="storage-wh-title"></h3>
                        <span id="storage-wh-desc" style="font-size:0.8em; color:#aaa;"></span>
                    </div>
                    <div id="storage-warehouse-list" class="card-grid"
                        style="display:flex; flex-wrap:wrap; align-content:flex-start; gap:5px;"></div>
                </div>
            </div>
        </div>

        <div id="city-scene" class="scene hidden city-scene">
            <div id="city-map-mode" class="city-hybrid-shell">
                <div class="city-left-info">
                    <div class="city-left-title" id="city-map-left-title"></div>
                    <div class="city-left-desc" id="city-map-left-desc"></div>
                </div>
                <div id="city-map" class="city-map-canvas"></div>
                <div class="city-detail-panel is-hidden" id="city-detail-panel">
                    <div class="city-dialogue" id="city-dialogue-panel-map">
                        <div class="city-dialogue-log" id="city-dialogue-log-map"></div>
                    </div>
                    <div class="city-detail-actions hidden">
                        <button class="action-btn" id="city-action-explore" disabled></button>
                        <button id="city-back-office" class="action-btn city-back-btn" style="background:#7f8c8d;" onclick="renderHub()"></button>
                    </div>
                </div>
            </div>

            <div id="city-area-mode" class="hidden city-hybrid-shell">
                <div class="city-left-info">
                    <div class="city-left-title" id="city-area-left-title"></div>
                    <div class="city-left-desc" id="city-area-left-desc"></div>
                </div>
                <div id="city-area-map" class="city-area-map">
                    <svg class="city-area-lines" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
                    <div class="city-area-node-layer"></div>
                </div>
                <div class="city-detail-panel city-area-detail is-hidden">
                    <div class="city-dialogue hidden" id="city-dialogue-panel">
                        <div class="city-dialogue-log" id="city-dialogue-log"></div>
                        <div class="city-dialogue-choices" id="city-dialogue-choices"></div>
                    </div>
                    <div class="city-case-panel hidden" id="city-case-panel">
                        <div class="city-case-list" id="city-case-list"></div>
                        <div class="city-case-actions">
                            <button class="action-btn" id="btn-case-close"></button>
                        </div>
                    </div>
                    <div class="city-spot-actions hidden">
                        <button class="action-btn" id="btn-area-enter"></button>
                        <button class="action-btn hidden" id="btn-area-back-area"></button>
                        <button class="action-btn" id="btn-area-back-map" onclick="exitCityAreaMode()"></button>
                    </div>
                </div>
            </div>
        </div>
        <div id="exploration-scene" class="scene hidden">

            <div id="exploration-shell" class="explore-hybrid-shell">
                <div class="explore-main">
                    <div class="stage-view" id="dungeon-stage">
                        <div id="layer-bg" class="parallax-layer"></div>

                        <div id="layer-char" class="parallax-layer" style="z-index:20;">

                            <div id="turn-timeline" class="timeline-container battle-ui hidden"></div>

                            <div id="dungeon-player-wrapper">
                                <img id="dungeon-player" src="assets/player.png" alt="Player">
                                <div id="player-hud"></div>
                            </div>
                            <div id="dungeon-objects" class="room-objects hidden"></div>

                            <div id="dungeon-doors"></div>
                            <div id="dungeon-enemies" class="enemies-wrapper"></div>

                            <div class="pile-buttons battle-ui hidden">
                                <button id="btn-draw-pile-floating" class="small-btn pile-btn"
                                    onclick="openPileView('draw')"></button>
                                <div class="pile-btn-stack">
                                    <button id="btn-exhaust-pile-floating" class="small-btn pile-btn"
                                        onclick="openPileView('exhaust')"></button>
                                    <button id="btn-discard-pile-floating" class="small-btn pile-btn"
                                        onclick="openPileView('discard')"></button>
                                </div>
                            </div>

                            <div id="interaction-bubble" class="hidden"></div>
                        </div>

                        <div id="layer-fg" class="parallax-layer"></div>
                    </div>

                    <div class="control-group battle-ui hidden">
                        <div id="ap-indicator">
                            <div class="ap-inner">
                                <span id="ap-val">3</span><span class="ap-sep">/</span><span id="ap-max">3</span>
                            </div>
                            <div id="ap-label" class="ap-label"></div>
                        </div>

                        <div id="btn-group-right" class="btn-group-right">
                            <button id="end-turn-btn" class="action-btn btn-end-turn-side" onclick="endPlayerTurn()"></button>
                        </div>
                    </div>

                    <div class="hand-area battle-ui hidden" id="hand-container"></div>
                </div>

                <div class="city-detail-panel explore-detail-panel" id="explore-detail-panel">
                    <div class="explore-minimap-panel">
                        <div id="explore-minimap-title" class="explore-minimap-header"></div>
                        <div class="explore-minimap-body">
                            <div id="minimap-right-grid" class="minimap-grid mini"></div>
                        </div>
                    </div>
                    <div class="city-dialogue">
                        <div class="city-dialogue-log" id="explore-dialogue-log"></div>
                    </div>
                    <div class="explore-log-actions" id="explore-log-actions">
                        <button id="explore-btn-status" class="action-btn" onclick="openPlayerStats()"></button>
                        <button id="explore-btn-inventory" class="action-btn" onclick="openInventory()"></button>
                        <button id="explore-btn-escape" class="action-btn" onclick="confirmRetreat()"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 이벤트/휴식/기타 전용 장면 (switchScene('event')) -->
        <div id="event-scene" class="scene hidden" style="background:#111; padding:20px;">
            <div class="event-shell" id="event-shell">
                <div id="event-content-box" class="event-box"></div>
                <div class="city-detail-panel event-log-panel is-hidden" id="event-log-panel">
                    <div class="city-dialogue-log" id="event-dialogue-log"></div>
                </div>
            </div>
        </div>


        <div id="result-scene" class="scene hidden"
            style="background:#111; justify-content:center; align-items:center;">
            <div style="text-align:center; animation: fadeIn 1s;">
                <h1 style="color:#f1c40f; font-size:3em; margin-bottom:10px; text-shadow:0 0 10px #f1c40f;">MISSION
                    COMPLETE</h1>
                <p id="event-clear-desc" style="color:#aaa; margin-bottom:40px;"></p>

                <div
                    style="background:#222; padding:30px; border-radius:10px; border:1px solid #444; width:300px; margin:0 auto; text-align:left;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span id="res-gold-label"></span> <span id="res-gold" style="color:#f1c40f; font-weight:bold;"></span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span id="res-xp-label"></span> <span id="res-xp" style="color:#3498db; font-weight:bold;"></span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span id="res-item-label"></span> <span id="res-item" style="color:#2ecc71;"></span>
                    </div>
                </div>

                <button id="event-return-office" class="action-btn" style="margin-top:40px; width:200px;" onclick="returnToHub()"></button>
            </div>
        </div>
    </div>


    <div id="story-scene" class="scene hidden" style="background:#fff; position:relative; overflow:hidden;">
        <div id="story-bg"
            style="position:absolute; top:0; left:0; width:100%; height:100%; background-size:cover; background-position:center; opacity:0.5;">
        </div>

        <div id="story-standing"
            style="position:absolute; bottom:0; width:100%; height:100%; display:flex; justify-content:center; align-items:flex-end; pointer-events:none;">
        </div>

        <div class="dialog-container" onclick="nextDialog()">
            <div id="story-name" class="name-tag"></div>
            <div id="story-text" class="dialog-text"></div>
            <div class="next-icon">▼</div>
        </div>

        <div id="story-choice-overlay" style="display:none;">
        </div>
    </div>

    <div id="popup-layer">
        <div class="popup-box" onclick="event.stopPropagation()">
            <h2 id="popup-title" style="color:#f1c40f;"></h2>
            <div id="popup-desc" style="font-size:1.1em; color:#222; margin:10px 0;"></div>
            <div id="popup-content"></div>
            <div class="popup-btns" id="popup-buttons"></div>
        </div>
    </div>

    <script src="data.js"></script>
    <script src="dungeon.js"></script>
    <script src="game.js?v=7"></script>
    <script src="story.js"></script>
    <script>
        // file://에서는 ServiceWorker/PWA가 막히므로 http/https에서만 등록
        const proto = location.protocol;
        const canUseSW = proto === 'https:' || proto === 'http:';
        if (canUseSW && 'serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(console.error);
            });
        } else {
            console.log('ServiceWorker skipped (requires http/https)');
        }
    </script>
    <svg id="drag-layer"
        style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; display:none;">
        <path id="drag-path" d="" stroke="#f1c40f" stroke-width="4" fill="none" stroke-dasharray="10,5"
            stroke-linecap="round" />
        <circle id="drag-head" cx="0" cy="0" r="8" fill="#e74c3c" stroke="#fff" stroke-width="2" />
    </svg>

    <div id="global-log-panel" class="global-log-panel hidden">
        <div class="city-dialogue-log" id="global-log"></div>
    </div>
</body>

</html>
