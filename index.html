<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Slay the Spire-like RPG (Exhaust Update)</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: #222; color: #eee; text-align: center; user-select: none; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; position: relative; min-height: 100vh; display: flex; flex-direction: column; }
        
       /* [ìˆ˜ì •] ìƒë‹¨ ë°”: ì•„ì£¼ ì–‡ê²Œ, ë²„íŠ¼ í†µí•© */
        .top-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;       /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
            margin-bottom: 5px;        /* ê°„ê²© ìµœì†Œí™” */
            background: #333; 
            padding: 5px 15px;         /* íŒ¨ë”© ì¤„ì„ */
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); 
            z-index: 10; 
            height: 40px;              /* ë†’ì´ ê³ ì • (ì‘ê²Œ) */
        }

        /* [ì¶”ê°€] ìƒë‹¨ ìš°ì¸¡ ë²„íŠ¼ ê·¸ë£¹ */
        .top-right-group {
            display: flex;
            gap: 5px;
        }        
        /* ì¸ë²¤í† ë¦¬ ì˜ì—­ */
        .inventory-area { background: #2c3e50; padding: 10px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; min-height: 50px; border: 1px solid #444; }
        .inv-label { font-size: 0.8em; color: #aaa; margin-right: 5px; }
        .item-list { display: flex; gap: 5px; flex-wrap: wrap; }
        .item-icon { 
            width: 40px; height: 40px; border-radius: 4px; display: flex; justify-content: center; align-items: center; 
            font-size: 1.2em; cursor: pointer; position: relative; border: 2px solid #555; transition: 0.2s;
        }
        .item-icon:hover { transform: scale(1.1); z-index: 5; }
        .item-relic { background: #e67e22; border-color: #d35400; color: #fff; }
        .item-consumable { background: #27ae60; border-color: #2ecc71; color: #fff; }
        .item-rank-2 { box-shadow: 0 0 5px #3498db; }
        .item-rank-3 { box-shadow: 0 0 8px #f1c40f; border-color: #f1c40f; }

        /* [ì¶”ê°€] ì•„ì´í…œ í´ë¦­ ì‹œ ë‚˜ì˜¤ëŠ” ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .item-actions {
            position: absolute;
            bottom: -35px; /* ì•„ì´ì½˜ ë°”ë¡œ ì•„ë˜ */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            background: #222;
            padding: 3px;
            border-radius: 5px;
            border: 1px solid #555;
            z-index: 200;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        .item-btn {
            font-size: 0.8em;
            padding: 2px 6px;
            cursor: pointer;
            border: none;
            border-radius: 3px;
            color: white;
        }
        .btn-confirm { background: #27ae60; }
        .btn-cancel { background: #c0392b; }

        /* ì•„ì´í…œì´ ì„ íƒë˜ì—ˆì„ ë•Œ ê°•ì¡° */
        .item-icon.selected {
            border-color: #f1c40f;
            box-shadow: 0 0 10px #f1c40f;
            z-index: 150;
        }
        /* íˆ´íŒ */
        /* [ìˆ˜ì •] íˆ´íŒ ìœ„ì¹˜ ë³€ê²½ (ì•„ì´í…œ ì˜¤ë¥¸ìª½) */
        .tooltip { 
            visibility: hidden; 
            width: 160px; 
            background-color: #111; 
            color: #fff; 
            text-align: center; 
            border-radius: 6px; 
            padding: 10px; 
            
            /* ìœ„ì¹˜: ì•„ì´ì½˜ì˜ ì˜¤ë¥¸ìª½ */
            top: 50%;
            left: 120%; /* ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°€ì–´ëƒ„ */
            transform: translateY(-50%); /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
            
            /* ê¸°ì¡´ ìœ„ì¹˜ ì†ì„± ì´ˆê¸°í™” */
            bottom: auto;
            margin-left: 0;

            position: absolute; 
            z-index: 9999; /* ìµœìƒë‹¨ */
            
            font-size: 13px; 
            font-weight: normal; 
            line-height: 1.4;    
            
            border: 1px solid #777; 
            opacity: 0; 
            transition: opacity 0.3s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.5); 
            
            pointer-events: none; /* í´ë¦­ í†µê³¼ */
        }

        /* [ì¶”ê°€] íˆ´íŒ í™”ì‚´í‘œ (ì™¼ìª½ì„ ê°€ë¦¬í‚´) */
        .tooltip::after {
            content: "";
            position: absolute;
            top: 50%;
            right: 100%; /* íˆ´íŒì˜ ì™¼ìª½ */
            margin-top: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent #111 transparent transparent;
        }

        /* [ì¶”ê°€] ì‚¬ìš© ë¶ˆê°€ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .item-icon.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(80%);
        }
        .item-icon:hover .tooltip { visibility: visible; opacity: 1; }

        /* ì¥ë©´(Scene) ê´€ë¦¬ */
        .scene { width: 100%; flex: 1; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* ì „íˆ¬ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .battle-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; min-height: 200px; }
/* [ìˆ˜ì •] ê¸°ì¡´ .character ìŠ¤íƒ€ì¼ì„ ì´ê±¸ë¡œ ë®ì–´ì”Œìš°ì„¸ìš” (ë°°ê²½ìƒ‰ ì œê±°, í…Œë‘ë¦¬ ì •ë¦¬) */
        .character { 
            width: 40%; 
            padding: 10px; 
            border-radius: 10px; 
            position: relative; 
            transition: 0.2s; 
            text-align: center;
            /* ë°°ê²½ìƒ‰ ì œê±° (ì´ë¯¸ì§€ ê°•ì¡°) */
        }
        /* í„´ í™œì„±í™” ì‹œ í…Œë‘ë¦¬ë§Œ ê°•ì¡° */
        .character.turn-active { 
            border: 2px solid #f1c40f; 
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); 
            background: rgba(255, 255, 255, 0.05); /* ì•„ì£¼ ì˜…ì€ ë°°ê²½ */
        }

        /* [ì¶”ê°€] ìºë¦­í„° ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .char-img {
            width: 120px;
            height: 120px;
            object-fit: cover; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ì›€ */
            border-radius: 10px;
            border: 2px solid #555;
            background: #000;
            margin-bottom: 5px;
        }
        
                /* [1ë‹¨ê³„ ì¶”ê°€] ì ë“¤ì´ ì„œ ìˆì„ ê³µê°„ */
        .enemies-wrapper {
            flex: 1;                /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
            display: flex;          /* ê°€ë¡œ ë°°ì¹˜ */
            justify-content: center; 
            gap: 15px;              /* ì  ì‚¬ì´ ê°„ê²© */
            align-items: flex-end;  /* ë°”ë‹¥ ë¼ì¸ ë§ì¶¤ */
            padding-left: 20px;
        }

        /* ê°œë³„ ì  ìºë¦­í„° ë°•ìŠ¤ (ê¸°ì¡´ .characterë³´ë‹¤ ì¡°ê¸ˆ ì‘ê²Œ) */
        .enemy-unit {
            width: 140px;           /* ê³ ì • ë„ˆë¹„ */
            background: transparent;
            border-radius: 10px;
            text-align: center;
            position: relative;
            transition: 0.2s;
            border: 2px solid transparent; /* í‰ì†Œì—” íˆ¬ëª… í…Œë‘ë¦¬ */
        }

        /* ì ì´ ì£½ì—ˆì„ ë•Œ ìŠ¤íƒ€ì¼ */
        .enemy-unit.dead {
            opacity: 0.4;
            filter: grayscale(100%);
            pointer-events: none;   /* í´ë¦­/ë“œë˜ê·¸ ë¶ˆê°€ */
        }

        /* íƒ€ê²ŸíŒ… ëì„ ë•Œ ê°•ì¡° */
        .enemy-unit.selected-target {
            border-color: #e74c3c;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.6);
            background: rgba(255, 255, 255, 0.05);
        }

        /* [ì¶”ê°€] ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ ì •ì˜ */

        /* 1. ê³µê²© (ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì³¤ë‹¤ê°€ ë³µê·€ - í”Œë ˆì´ì–´ìš©) */
        @keyframes atk-p {
            0% { transform: translateX(0); }
            30% { transform: translateX(50px) scale(1.1); } /* ì•ìœ¼ë¡œ íŒ! */
            100% { transform: translateX(0); }
        }
        /* 1-2. ê³µê²© (ì™¼ìª½ìœ¼ë¡œ ì³¤ë‹¤ê°€ ë³µê·€ - ì ìš©) */
        @keyframes atk-e {
            0% { transform: translateX(0); }
            30% { transform: translateX(-50px) scale(1.1); }
            100% { transform: translateX(0); }
        }

        /* 2. í”¼ê²© (ë’¤ë¡œ ë°€ë ¸ë‹¤ê°€ ë³µê·€ + ë¹¨ê°„ ë²ˆì©ì„) */
        @keyframes hit-anim {
            0% { transform: translateX(0); filter: brightness(1); }
            20% { transform: translateX(-10px); filter: brightness(0.5) sepia(1) hue-rotate(-50deg) saturate(5); } /* ë¹¨ê°›ê²Œ */
            40% { transform: translateX(10px); } /* ëœëœ ë–¨ë¦¼ */
            60% { transform: translateX(-5px); }
            100% { transform: translateX(0); filter: brightness(1); }
        }

        /* 3. ìŠ¤í‚¬/ë²„í”„ (ìœ„ë¡œ ë‘ ë²ˆ ì½©ì½©) */
        @keyframes bounce-double {
            0% { transform: translateY(0); }
            25% { transform: translateY(-20px); } /* ì í”„ 1 */
            50% { transform: translateY(0); }
            75% { transform: translateY(-10px); } /* ì í”„ 2 (ì‘ê²Œ) */
            100% { transform: translateY(0); }
        }
                /* [ì¶”ê°€] ëŒ€ë¯¸ì§€ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .damage-number {
            position: absolute;
            top: 10%;           /* ìºë¦­í„° ë¨¸ë¦¬ ê·¼ì²˜ */
            left: 50%;
            transform: translateX(-50%);
            color: #ff3333;     /* ê°•ë ¬í•œ ë¹¨ê°„ìƒ‰ */
            font-size: 2.5em;   /* í¬ê²Œ! */
            font-weight: 900;   /* ì•„ì£¼ êµµê²Œ! */
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000; /* ê²€ì€ í…Œë‘ë¦¬ë¡œ ê°€ë…ì„± í™•ë³´ */
            z-index: 999;
            pointer-events: none; /* ë§ˆìš°ìŠ¤ í´ë¦­ ë°©í•´ ì•ˆ í•˜ê²Œ */
            animation: float-up 0.8s ease-out forwards;
        }

        /* [ì¶”ê°€] ìˆ«ìê°€ ìœ„ë¡œ ì˜¬ë¼ê°€ë©° ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes float-up {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -20px) scale(1.2); opacity: 1; } /* íŒ íŠ€ì–´ë‚˜ì˜´ */
            100% { transform: translate(-50%, -80px) scale(1); opacity: 0; }  /* ìœ„ë¡œ ì‚¬ë¼ì§ */
        }

        /* ì• ë‹ˆë©”ì´ì…˜ ì ìš© í´ë˜ìŠ¤ (JSì—ì„œ ë¶™ì˜€ë‹¤ ë—„ ê²ƒì„) */
        .anim-atk-p { animation: atk-p 0.4s ease-out; }
        .anim-atk-e { animation: atk-e 0.4s ease-out; }
        .anim-hit { animation: hit-anim 0.4s ease-in-out; }
        .anim-bounce { animation: bounce-double 0.6s ease-in-out; }
        .hp-bar-bg { background: #222; height: 20px; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #555; }
        .hp-bar-fill { background: #e74c3c; height: 100%; width: 100%; transition: 0.5s; }
        
        /* [ìˆ˜ì •] í•¸ë“œ ì˜ì—­: ì¤„ë°”ê¿ˆ ê¸ˆì§€(nowrap) ë° ì˜¤ë²„í”Œë¡œìš° í—ˆìš© */
        .hand-area { 
            display: flex; 
            justify-content: center; 
            flex-wrap: nowrap;      /* [í•µì‹¬] ì¤„ë°”ê¿ˆ ì•ˆ í•¨ */
            align-items: flex-end;  /* ì•„ë˜ìª½ ì •ë ¬ */
            
            height: 160px;          /* ë†’ì´ ê³ ì • (ì¹´ë“œ íŒì—… ê³µê°„ í™•ë³´) */
            padding: 10px;
            margin-top: 20px;
            
            overflow: visible;      /* ì¹´ë“œê°€ ìœ„ë¡œ íŠ€ì–´ ì˜¬ë¼ë„ ì˜ë¦¬ì§€ ì•Šê²Œ */
            pointer-events: none;   /* ë¹ˆ ê³µê°„ í´ë¦­ ë°©ì§€ (ì¹´ë“œë§Œ í´ë¦­ë˜ê²Œ) */
        }

        .hand-area::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        /* [ìˆ˜ì •] ë¡œê·¸ ì˜ì—­: ê°€ìš´ë° ë°°ì¹˜ */
        .log-area { 
            height: 100%;       
            flex: 1;            /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
            overflow-y: auto; 
            background: #111; 
            border: 1px solid #444; 
            padding: 5px;       /* íŒ¨ë”© ì¤„ì„ */
            text-align: left; 
            font-size: 0.85em;  /* ê¸€ì í¬ê¸° ì‚´ì§ ì¤„ì„ */
            color: #bbb; 
            border-radius: 5px; 
            margin: 0;          /* ë§ˆì§„ ì œê±° */
        }
        /* [ìˆ˜ì •] ì»¨íŠ¸ë¡¤ ê·¸ë£¹: 3ë‹¨ ë¶„í•  (ìƒíƒœ | ë¡œê·¸ | ë²„íŠ¼) */
        .control-group {
            display: flex;          
            gap: 5px;              /* ê°„ê²© ì¢ê²Œ */
            height: 100px;         /* ì „ì²´ ë†’ì´ 120px -> 100pxë¡œ ì¶•ì†Œ */
            margin-bottom: 5px;    
            align-items: stretch;   
        }
        /* [ì¶”ê°€] ìƒíƒœ íŒ¨ë„ (ì™¼ìª½: í„´/AP ì •ë³´) */
        .status-panel {
            width: 110px;          /* ê³ ì • ë„ˆë¹„ */
            background: #2c3e50;
            border: 1px solid #34495e;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px;
            color: #fff;
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
            flex-shrink: 0;        /* í¬ê¸° ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
        }
        /* [ìˆ˜ì •] í„´ ì¢…ë£Œ ë²„íŠ¼: ì˜¤ë¥¸ìª½ ë°°ì¹˜ */
        .btn-end-turn-side {
            width: 80px;        /* ë„ˆë¹„ ì•½ê°„ ì¤„ì„ */
            font-size: 1.1em;
            font-weight: bold;
            word-break: keep-all;
            line-height: 1.2;
            padding: 0;         /* íŒ¨ë”© ì œê±° */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            background: #ecf0f1; color: #2c3e50; width: 100px; height: 140px; 
            border-radius: 8px; padding: 8px; cursor: pointer; font-size: 0.8em;
            display: flex; flex-direction: column; justify-content: space-between;
            border: 2px solid #bdc3c7; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        /* [ë³€ê²½] ê¸°ë³¸ ìƒíƒœëŠ” ê²¹ì¹˜ì§€ ì•Šê³  ê°„ê²©ì„ ë‘  */
            flex-shrink: 0;         
            margin: 0 5px;          /* ì–‘ì˜†ì— 5pxì”© ì—¬ìœ  */
            transition: all 0.2s ease-out; 
            pointer-events: auto;   
            transform-origin: bottom center;
        }
        /* [ì¶”ê°€] ê²¹ì¹˜ê¸° ëª¨ë“œ (.compact)ì¼ ë•Œì˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .hand-area.compact .card {
            margin: 0;              /* ê¸°ë³¸ ë§ˆì§„ ì œê±° */
            margin-left: -30px;     /* ì™¼ìª½ìœ¼ë¡œ ê²¹ì¹˜ê¸° */
        }

        /* ê²¹ì¹˜ê¸° ëª¨ë“œì—¬ë„ ì²« ë²ˆì§¸ ì¹´ë“œëŠ” ë°€ë¦¬ì§€ ì•ŠìŒ */
        .hand-area.compact .card:first-child {
            margin-left: 0;
        }
        /* ì²« ë²ˆì§¸ ì¹´ë“œëŠ” ì™¼ìª½ìœ¼ë¡œ ë°€ë¦¬ì§€ ì•Šê²Œ */
        .card:first-child {
            margin-left: 0;
        }
        /* [ìˆ˜ì •] ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ (Hover) */
        .card:hover { 
            transform: translateY(-5px) scale(1.1) !important; 
            z-index: 100;           
            border-color: #f1c40f; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);

            /* í˜¸ë²„ ì‹œì—ëŠ” ëª¨ë“œ ìƒê´€ì—†ì´ ì–‘ì˜† ê³µê°„ í™•ë³´ */
            margin-left: 10px !important;
            margin-right: 10px !important;
        }
        .card.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); transform: none; }
        .card-cost { background: #3498db; color: white; width: 25px; height: 25px; border-radius: 50%; text-align: center; line-height: 25px; font-weight: bold; position: absolute; top: -10px; left: -10px; }
        .card-name { font-weight: bold; margin-top: 10px; font-size: 1.1em; }
        .card-desc { font-size: 0.8em; color: #555; line-height: 1.3; }
      
        /* [ì¶”ê°€] ì¹´ë“œ ë“±ê¸‰(ë³„) ìŠ¤íƒ€ì¼ */
        .card-rank { 
            position: absolute; 
            top: 2px; 
            right: 5px; 
            color: #f1c40f; /* ê¸ˆìƒ‰ */
            font-weight: bold; 
            font-size: 1.2em; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.8); /* ì˜ ë³´ì´ê²Œ ê·¸ë¦¼ì ì¶”ê°€ */
        }
                /* [ì¶”ê°€] ìˆ˜ì¹˜ ë³€ê²½ ì‹œ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .mod-val-buff { color: #2ecc71; font-weight: bold; } /* ìˆ˜ì¹˜ ì¦ê°€ (ì´ˆë¡) */
        .mod-val-debuff { color: #e74c3c; font-weight: bold; } /* ìˆ˜ì¹˜ ê°ì†Œ (ë¹¨ê°•) */
        /* [ì¶”ê°€] ëª¨ë°”ì¼ ê°€ë¡œ ëª¨ë“œ ê°•ì œ ì˜¤ë²„ë ˆì´ */
        #rotate-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            color: #fff;
            z-index: 9999;
            display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        /* í™”ë©´ ë„ˆë¹„ê°€ 768px ì´í•˜(ëª¨ë°”ì¼)ì´ê³ , ì„¸ë¡œ ëª¨ë“œ(portrait)ì¼ ë•Œë§Œ ë³´ì„ */
        @media screen and (max-width: 768px) and (orientation: portrait) {
            #rotate-overlay { display: flex; }
            .container { display: none; } /* ê²Œì„ í™”ë©´ ìˆ¨ê¹€ */
        }
        /* ì´ë²¤íŠ¸(ìƒì /íœ´ì‹) ì „ì²´ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #event-scene { justify-content: center; align-items: center; text-align: center; }
        .event-content { background: #2c3e50; padding: 40px; border-radius: 15px; width: 100%; max-width: 600px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border: 1px solid #34495e; }
        .event-title { font-size: 2em; margin-bottom: 10px; color: #f1c40f; }
        .event-desc { font-size: 1.2em; margin-bottom: 30px; color: #ecf0f1; }
        
        .shop-items { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .shop-item { cursor: pointer; transition: 0.2s; position: relative; }
        .shop-item:hover { transform: scale(1.05); }
        .shop-item.sold-out { opacity: 0.4; pointer-events: none; filter: grayscale(100%); }
        .shop-item.sold-out::after { content: "SOLD OUT"; position: absolute; top: 40%; left: 10%; color: red; font-weight: bold; font-size: 1.5em; transform: rotate(-15deg); border: 2px solid red; padding: 5px; }
        .shop-price { background: #111; color: #f1c40f; padding: 5px; border-radius: 4px; margin-top: 5px; font-weight: bold; }

        /* ë²„íŠ¼ë¥˜ */
        .action-btn { background: #e67e22; color: white; border: none; padding: 12px 30px; font-size: 1.1em; cursor: pointer; border-radius: 5px; box-shadow: 0 4px 0 #d35400; transition: 0.1s; }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        .action-btn:disabled { background: #7f8c8d; box-shadow: none; cursor: not-allowed; transform: none; }
        .small-btn { background: #555; color: #fff; border: 1px solid #777; padding: 5px 10px; font-size: 0.8em; cursor: pointer; border-radius: 4px; margin: 0 2px; }

        /* íŒì—… */
        #popup-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 200; }
        .popup-box { background: #333; padding: 30px; border-radius: 10px; width: 500px; max-height: 80%; display: flex; flex-direction: column; text-align: center; border: 1px solid #555; }
        .popup-btns { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .pile-list { flex: 1; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 10px; background: #222; border-radius: 5px; margin-top: 10px; }
        .mini-card { width: 70px; height: 100px; background: #ecf0f1; color: #333; border-radius: 4px; padding: 5px; font-size: 0.6em; display: flex; flex-direction: column; justify-content: center; text-align: center; border: 1px solid #bdc3c7; }
        .mini-card b { display: block; font-size: 1.2em; margin-bottom: 3px; }
        
        .keyword { position: relative; color: #f1c40f; font-weight: bold; cursor: help; text-decoration: underline dotted; }
        .keyword .tip-text { visibility: hidden; width: 180px; background-color: #111; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1000; bottom: 125%; left: 50%; margin-left: -90px; font-size: 0.8em; font-weight: normal; border: 1px solid #777; opacity: 0; transition: opacity 0.2s; pointer-events: none; box-shadow: 0 4px 6px rgba(0,0,0,0.5); white-space: normal; line-height: 1.4; }
        .keyword:hover .tip-text { visibility: visible; opacity: 1; }
    </style>
</head>
<body>
<div class="container">
    <div class="top-bar">
        <span id="game-info" style="font-weight:bold; font-size:1em;">Lv.1 | ğŸ’° 0ì›</span>
        
        <div class="top-right-group">
            <button class="small-btn" onclick="saveGame()">ğŸ’¾ ì €ì¥</button>
            <button class="small-btn" onclick="loadGame()">ğŸ“‚ ë¡œë“œ</button>
        </div>
    </div>

    <div class="inventory-area">
        <div class="inv-label">ğŸ‘‘ ìœ ë¬¼:</div>
        <div class="item-list" id="relic-list"></div>
        <div style="width:20px;"></div> <div class="inv-label">ğŸ§ª ì†Œëª¨í’ˆ:</div>
        <div class="item-list" id="consumable-list"></div>
    </div>

    <div id="battle-scene" class="scene">
        <div class="battle-area">
            <div class="character" id="player-char">
                    <h3 style="margin:2px 0; font-size:1em;">ğŸ‘¤ í”Œë ˆì´ì–´</h3>
                    <img id="p-img" src="https://placehold.co/150x150/3498db/ffffff?text=Hero" alt="Player" class="char-img" style="width:100px; height:100px;"> 
                    <div class="hp-bar-bg"><div class="hp-bar-fill" id="p-hp-bar"></div></div>
                    <div style="font-size:0.9em;">HP: <span id="p-hp">25</span>/<span id="p-max-hp">25</span> <span class="block-icon">ğŸ›¡ï¸<span id="p-block">0</span></span></div>
                    <div class="stats" id="p-stats" style="font-size:0.8em;">ê³µ1 ë°©1 ì†1</div>
                    <div class="buffs" id="p-buffs" style="min-height:20px;"></div>
                    <div style="margin-top: 5px; display: flex; justify-content: center; gap: 3px;">
                        <button id="btn-draw-pile" class="small-btn" style="font-size:0.7em;" onclick="openPileView('draw')">ë±(0)</button>
                        <button id="btn-discard-pile" class="small-btn" style="font-size:0.7em;" onclick="openPileView('discard')">ë²„ë¦¼(0)</button>
                        <button id="btn-exhaust-pile" class="small-btn" style="font-size:0.7em;" onclick="openPileView('exhaust')">ì†Œë©¸(0)</button>
                    </div>
                </div>

            <div id="enemies-area" class="enemies-wrapper"></div>
        </div>

        <div class="control-group">
            <div class="status-panel">
                <div id="turn-info" style="word-break: keep-all;">ê²Œì„ ì‹œì‘</div>
            </div>
            
            <div class="log-area" id="log-box"></div>
            
            <button id="end-turn-btn" class="action-btn btn-end-turn-side" onclick="endPlayerTurn()">
                í„´<br>ì¢…ë£Œ
            </button>
        </div>

    <div class="hand-area" id="hand-container"></div>
</div>

    <div id="event-scene" class="scene hidden">
        <div class="event-content" id="event-content-box"></div>
    </div>
</div>

<div id="popup-layer">
    <div class="popup-box" onclick="event.stopPropagation()">
        <h2 id="popup-title" style="color:#f1c40f;">ì œëª©</h2>
        <div id="popup-desc" style="font-size:1.1em; color:#ddd; margin:10px 0;">ë‚´ìš©</div>
        <div id="popup-content"></div>
        <div class="popup-btns" id="popup-buttons"></div>
    </div>
</div>

<script>
/* --- ë°ì´í„° (ì¹´ë“œ) --- */
const CARD_DATA = {
    // 1ì„± (ê¸°ë³¸)
    "íƒ€ê²©": { rank: 1, cost: 1, type: "attack", desc: "ì  HP -5", dmg: 5 },
    "ìˆ˜ë¹„": { rank: 1, cost: 1, type: "skill", desc: "ë°©ì–´ë„ +4", block: 4 },
   
    
    // 1ì„± (íŠ¹ìˆ˜)
    "ì ìê¸°": { rank: 1, cost: 0, type: "skill", desc: "í™œë ¥(2í„´), ë°©ì–´ë„+2 (ì†Œë©¸)", buff: {name:"í™œë ¥", val:2}, block: 2, isExhaust: true },

    // 2ì„± (ë””ë²„í”„ & ë³µí•©)
    // ê¸°ì¡´: valì´ ë°©ì–´ë„ì˜€ìŒ -> block: 3ìœ¼ë¡œ ëª…ì‹œ
    "ë„ë°œ": { rank: 2, cost: 2, type: "skill", desc: "ì  ì•½í™”(2í„´), ë°©ì–´ë„+3", buff: {name:"ì•½í™”", val:2}, block: 3, target: "enemy" },
    "ë… ë¿Œë¦¬ê¸°": { rank: 2, cost: 2, type: "skill", desc: "ì  ë…(2í„´), ë°©ì–´ë„+3", buff: {name:"ë…", val:2}, block: 3, target: "enemy" },    "íë§ê´‘ì„ ": { rank: 2, cost: 2, type: "skill", desc: "ë‚˜ í™œë ¥(2í„´), ë°©ì–´ë„+3", buff: {name:"í™œë ¥", val:2}, target:"self", block: 3 },
    "ê»´ì…ê¸°": { rank: 2, cost: 2, type: "skill", desc: "ë‚˜ ê±´ê°•(2í„´), ë°©ì–´ë„+4", buff: {name:"ê±´ê°•", val:2}, target:"self", block: 4 },

    // 2ì„± (ê³µê²© + ë””ë²„í”„/ë²„í”„)
    "ë„˜ì–´ëœ¨ë¦¬ê¸°": { rank: 2, cost: 2, type: "attack", desc: "ì  ì·¨ì•½(2í„´), ì  HP -4", buff: {name:"ì·¨ì•½", val:2}, dmg: 4 },
    "ì „ê¸° ì¶©ê²©": { rank: 2, cost: 2, type: "attack", desc: "ì  ë§ˆë¹„(2í„´), ì  HP -4", buff: {name:"ë§ˆë¹„", val:2}, dmg: 4 },
    "ê·¼ìœ¡ìë‘": { rank: 2, cost: 2, type: "attack", desc: "ë‚˜ ê°•í™”(2í„´), ì  HP -4", buff: {name:"ê°•í™”", val:2}, target:"self", dmg: 4 },
    "ë‹¬ë¦¬ê¸°": { rank: 2, cost: 2, type: "attack", desc: "ë‚˜ ì¾Œì†(2í„´), ì  HP -4", buff: {name:"ì¾Œì†", val:2}, target:"self", dmg: 4 },

    "ëŒì§„" : { rank: 2, cost: 2, type: "attack", desc: "ì  8 í”¼í•´, ë°©ì–´ë„ +8", dmg: 8, block: 8},

    // íŠ¹ìˆ˜ ê¸°ëŠ¥ (special íƒœê·¸ ì‚¬ìš©)
    "ë°©íŒ¨ ë¶€ìˆ˜ê¸°": { rank: 2, cost: 2, type: "attack", desc: "ì  ë°©ì–´ë„ ì œê±°, ì  HP -2", special: "break_block", dmg: 2 },
    "ì£¼ë¨¸ë‹ˆ ë’¤ì§€ê¸°": { rank: 2, cost: 1, type: "skill", desc: "ë°©ì–´ë„ +2, ì¹´ë“œ 2ì¥ ë½‘ê¸°", block: 2, draw: 2 },
    // 3ì„±
    "ì‚¬ê²©": { rank: 3, cost: 1, type: "attack", desc: "ë‚˜ ê°•í™”(2í„´), ì  HP -8", buff: {name:"ê°•í™”", val:2}, target:"self", dmg: 8 },
    "ëŸ­í‚¤í”¼ìŠ¤": { rank: 3, cost: 1, type: "attack", desc: "ì  HP -8, ìƒê¸ˆ 2ë°° (ì†Œë©¸)", special: "lucky", dmg: 8, isExhaust: true },
    "ë§ˆêµ¬ ë½‘ê¸°": { rank: 3, cost: 0, type: "skill", desc: "ì¹´ë“œ 5ì¥ ë½‘ê¸° (ì†Œë©¸)", draw: 5, isExhaust: true }
    
};
/* [NEW] ì  ë°ì´í„° ì •ì˜ */
const ENEMY_DATA = {
    "ë¶ˆëŸ‰ë°°": {
        name: "ë¶ˆëŸ‰ë°°",
        baseHp: 20,
        stats: { atk: 1, def: 0, spd: 3 }, // ê¸°ë³¸ ìŠ¤íƒ¯
        growth: { hp: 4, atk: 0.5, def: 0, spd: 0.1 }, // ë ˆë²¨ë‹¹ ì„±ì¥ ìˆ˜ì¹˜
        deckType: "basic", // ì‚¬ìš©í•˜ëŠ” ë± íƒ€ì…
        img: "https://placehold.co/100x100/c0392b/ffffff?text=Bully"
    },
    "í—ˆìˆ˜ì•„ë¹„": {
        name: "í—ˆìˆ˜ì•„ë¹„",
        baseHp: 30, // ì¡°ê¸ˆ ë” íŠ¼íŠ¼í•˜ê²Œ
        stats: { atk: 1, def: 1, spd: 2 }, // 
        growth: { hp: 5, atk: 0.5, def: 0.5, spd: 0.1 }, // ê³¨ê³ ë£¨ ì„±ì¥
        deckType: "player_like", // íƒ€ê²©5+ìˆ˜ë¹„4+2ì„±1
        img: "https://placehold.co/100x100/f39c12/ffffff?text=Scarecrow"
    }
};

/* [NEW] ì  ë± ìƒì„± í—¬í¼ í•¨ìˆ˜ */
function getEnemyDeck(type) {
    let deck = [];
    if (type === "basic") {
        // ë¶ˆëŸ‰ë°°: ë‹¨ìˆœ ê³µê²© ìœ„ì£¼
        deck = ["íƒ€ê²©", "íƒ€ê²©", "ìˆ˜ë¹„"];
    } 
    else if (type === "player_like") {
        // í—ˆìˆ˜ì•„ë¹„: í”Œë ˆì´ì–´ ì´ˆê¸° ë± êµ¬ì„± (íƒ€ê²©5, ìˆ˜ë¹„4, 2ì„± 1ì¥)
        for(let i=0; i<5; i++) deck.push("íƒ€ê²©");
        for(let i=0; i<4; i++) deck.push("ìˆ˜ë¹„");
        // ëœë¤ 2ì„± ì¹´ë“œ 1ì¥ ì¶”ê°€ (í•¨ìˆ˜ ì¬ì‚¬ìš©)
        let randomRank2 = getRandomCardByRank(2);
        deck.push(randomRank2);
    }
    return deck;
}

/* [NEW] ë­í¬ë³„ ëœë¤ ì¹´ë“œ ë½‘ê¸° ìœ í‹¸ë¦¬í‹° (ê¸°ì¡´ getRandomCard ë³´ì™„) */
function getRandomCardByRank(rank) {
    let pool = Object.keys(CARD_DATA).filter(k => CARD_DATA[k].rank === rank);
    return pool[Math.floor(Math.random() * pool.length)];
}
const TOOLTIPS = {
    "ì•½í™”": "ê³µê²© ìŠ¤íƒ¯ì´ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.",
    "ì·¨ì•½": "ë°©ì–´ ìŠ¤íƒ¯ì´ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.",
    "ë§ˆë¹„": "ì†ë„ ìŠ¤íƒ¯ì´ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.",
    "ë…": "í„´ ì‹œì‘ ì‹œ ì¤‘ì²©ëœ ìˆ˜ì¹˜ë§Œí¼ í”¼í•´ë¥¼ ì…ê³ , 1 ì¤„ì–´ë“­ë‹ˆë‹¤.",
    "ê°•í™”": "ê³µê²© ìŠ¤íƒ¯ì´ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.",
    "ê±´ê°•": "ë°©ì–´ ìŠ¤íƒ¯ì´ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.",
    "ì¾Œì†": "ì†ë„ ìŠ¤íƒ¯ì´ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.",
    "í™œë ¥": "í„´ ì‹œì‘ ì‹œ ì¤‘ì²©ëœ ìˆ˜ì¹˜ë§Œí¼ ì²´ë ¥ì„ íšŒë³µí•˜ê³ , 1 ì¤„ì–´ë“­ë‹ˆë‹¤.",
    // [ì¶”ê°€ëœ ë¶€ë¶„] ì†Œë©¸ ì„¤ëª… ì¶”ê°€
    "ì†Œë©¸": "ì¹´ë“œë¥¼ ì‚¬ìš©í•˜ë©´ ë±ì—ì„œ ì œê±°ë˜ì–´, ì´ë²ˆ ì „íˆ¬ ë™ì•ˆ ë‹¤ì‹œ ë‚˜ì˜¤ì§€ ì•ŠìŠµë‹ˆë‹¤."
};

function applyTooltip(text) {
    let res = text;
    for (let key in TOOLTIPS) {
        let regex = new RegExp(key, 'g'); 
        res = res.replace(regex, `<span class="keyword">${key}<span class="tip-text">${TOOLTIPS[key]}</span></span>`);
    }
    return res;
}

/* --- ë°ì´í„° (ì•„ì´í…œ) --- */
/* [ìˆ˜ì •] ITEM_DATA ì „ì²´ë¥¼ ì´ê±¸ë¡œ ì—…ë°ì´íŠ¸í•˜ì„¸ìš” */
const ITEM_DATA = {
    // --- ìœ ë¬¼ ---
    "ì¿ ë³´íƒ„": {type: "relic", rank: 1, price: 2000, icon: "ğŸ¥Š", desc: "ê³µê²©ë ¥ +1 (íŒ¨ì‹œë¸Œ)"},
    "ê°•ì¸í•¨ì˜ ë¶€ì ": {type: "relic", rank: 1, price: 2000, icon: "ğŸ§¿", desc: "ë°©ì–´ë ¥ +1 (íŒ¨ì‹œë¸Œ)"},
    "ì¢‹ì€ ìš´ë™í™”": {type: "relic", rank: 1, price: 2000, icon: "ğŸ‘Ÿ", desc: "ì†ë„ +1 (íŒ¨ì‹œë¸Œ)"},
    "ìš¸ëˆë¶ˆëˆ íŒ¨ë”©": {type: "relic", rank: 2, price: 3000, icon: "ğŸ§¥", desc: "ìµœëŒ€ HP +50 ì¦ê°€"},
    "í™©ê¸ˆ ëŒ€íƒ€": {type: "relic", rank: 3, price: 4000, icon: "ğŸº", desc: "ì‚¬ë§ ì‹œ 1000ì›ì„ ì†Œëª¨í•˜ì—¬ ë¶€í™œ"},

    // --- ì†Œëª¨í’ˆ (target ì¶”ê°€) ---
    // target: "self" (ìì‹  ì‚¬ìš©)
    "íšŒë³µì•½": {type: "consumable", rank: 1, price: 1000, icon: "ğŸ·", desc: "HP 25 íšŒë³µ", effect: "heal", val: 25, target: "self"},
    
    // target: "enemy" (ì ì—ê²Œ ë“œë˜ê·¸)
    "í˜¸ì‹ ìš© ìŠ¤í”„ë ˆì´": {type: "consumable", rank: 1, price: 1000, icon: "ğŸ§´", desc: "ì ì—ê²Œ 10 í”¼í•´", effect: "damage", val: 10, target: "enemy"},
    
    // target: "self" (ì¦‰ì‹œ ë°œë™)
    "í”¼ë‚œì˜ í”¼ë¦¬": {type: "consumable", rank: 2, price: 2000, icon: "ğŸ¼", desc: "ë‹¤ìŒ ì´ë²¤íŠ¸ë¥¼ [íœ´ì‹]ìœ¼ë¡œ ê³ ì •", effect: "event_rest", target: "self"},
    
    // effect: "revive" -> ì‚¬ìš© ë¶ˆê°€(íŒ¨ì‹œë¸Œí˜• ì†Œëª¨í’ˆ)
    "ëŒ€íƒ€ ì¸í˜•": {type: "consumable", rank: 3, price: 3000, icon: "ğŸ§¸", desc: "ì‚¬ë§ ì‹œ ìë™ ë¶€í™œ", effect: "revive", target: "passive"}
};
/* --- ìƒíƒœ ë³€ìˆ˜ --- */
let player = { 
    maxHp: 25, hp: 25, baseAtk: 1, baseDef: 1, baseSpd: 3, 
    gold: 0, deck: [], hand: [], block: 0, buffs: {}, ap: 3, 
    jumadeung: false, lucky: false,
    drawPile: [], discardPile: [], 
    exhaustPile: [], // [NEW] ì†Œë©¸ëœ ì¹´ë“œ ì €ì¥ì†Œ
    relics: [], consumables: [],
    xp: 0, 
    maxXp: 100 // 1ë ˆë²¨ì—… í•„ìš” ê²½í—˜ì¹˜
};
let enemies = [];

/* [ìˆ˜ì •] game ìƒíƒœ ë³€ìˆ˜ */
let game = { 
    level: 1, 
    // turnCountëŠ” ì´ì œ 'ë¼ìš´ë“œ'ê°€ ì•„ë‹ˆë¼ 'ëˆ„ì  í–‰ë™ íšŸìˆ˜' ì •ë„ë¡œ ì”ë‹ˆë‹¤.
    totalTurns: 0, 
    state: "battle", 
    turnOwner: "none", 
    pendingLoot: null,
    winMsg: "",
    // [NEW] í–‰ë™ ê²Œì´ì§€ MAX ìƒìˆ˜ (ì´ ìˆ˜ì¹˜ì— ë„ë‹¬í•˜ë©´ í„´ íšë“)
    AG_MAX: 1000 
};

/* --- ìœ í‹¸ë¦¬í‹° --- */
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
function log(msg) { const box = document.getElementById('log-box'); box.innerHTML += `<div>${msg}</div>`; box.scrollTop = box.scrollHeight; }

/* [NEW] ë§ˆìš°ìŠ¤/í„°ì¹˜ ì¢Œí‘œ í†µí•© ì¶”ì¶œ í•¨ìˆ˜ */
function getClientPos(e) {
    // í„°ì¹˜ ì´ë²¤íŠ¸ì¸ ê²½ìš°
    if (e.touches && e.touches.length > 0) {
        return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }
    // í„°ì¹˜ê°€ ëë‚˜ëŠ” ìˆœê°„(touchend)ì—ëŠ” touchesê°€ ë¹„ì–´ìˆìŒ -> changedTouches í™•ì¸
    if (e.changedTouches && e.changedTouches.length > 0) {
        return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
    }
    // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ì¸ ê²½ìš°
    return { x: e.clientX, y: e.clientY };
}

/* --- ì¥ë©´ ì „í™˜ --- */
function switchScene(sceneName) {
    document.getElementById('battle-scene').classList.add('hidden');
    document.getElementById('event-scene').classList.add('hidden');
    document.getElementById('popup-layer').style.display = 'none';
    if (sceneName === 'battle') document.getElementById('battle-scene').classList.remove('hidden');
    else if (sceneName === 'event') document.getElementById('event-scene').classList.remove('hidden');
    updateUI();
}

/* --- ì´ˆê¸°í™” --- */
function initGame() {
    // 1. ê¸°ë³¸ ë± ì„¤ì •: íƒ€ê²© 5ì¥ + ìˆ˜ë¹„ 4ì¥
    player.deck = ["íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","ìˆ˜ë¹„","ìˆ˜ë¹„","ìˆ˜ë¹„","ìˆ˜ë¹„"];
    
    // 2. ë¬´ì‘ìœ„ 2ì„± ì¹´ë“œ 1ì¥ ì¶”ê°€
    addRandomCard(2); 
    
    // (ì‚­ì œë¨) player.deck.push("ì ìê¸°"); 
    
    updateUI();
    startBattle();
}

/* --- ì¸ë²¤í† ë¦¬ ì‹œìŠ¤í…œ --- */
function addItem(name) {
    const data = ITEM_DATA[name];
    if (data.type === 'relic') {
        if (player.relics.includes(name)) return false; 
        player.relics.push(name);
        if (name === "ìš¸ëˆë¶ˆëˆ íŒ¨ë”©") { player.maxHp += 50; player.hp += 50; log("ğŸ§¥ íŒ¨ë”© ì¥ì°©! ìµœëŒ€ ì²´ë ¥ì´ 50 ì¦ê°€í–ˆìŠµë‹ˆë‹¤."); }
    } else { player.consumables.push(name); }
    updateInventoryUI(); return true;
}
/* [ìˆ˜ì •] ì•„ì´í…œ ì‚¬ìš© í•¨ìˆ˜ */
function useConsumable(index, target) {
    const name = player.consumables[index];
    const data = ITEM_DATA[name];

    // 1. ê²€ì¦
    if (data.effect === "damage" && (game.state !== "battle" || game.turnOwner !== "player")) {
        log("ğŸš« ì „íˆ¬ ì¤‘ ë‚´ í„´ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); 
        return;
    }

    let used = false;
    let targetId = (target === player) ? "player-char" : `enemy-unit-${target.id}`;

    // 2. íš¨ê³¼
    switch (data.effect) {
        case "heal":
            let healAmt = Math.min(target.maxHp - target.hp, data.val);
            target.hp += healAmt;
            log(`ğŸ· [${name}] ì‚¬ìš©! HP +${healAmt}`);
            playAnim(targetId, 'anim-bounce');
            used = true;
            break;

        case "damage":
            log(`ğŸ§´ [${name}] íˆ¬ì²™! ì ì—ê²Œ ${data.val} í”¼í•´`);
            takeDamage(target, data.val);
            used = true;
            break;

        case "event_rest":
            game.forceRest = true;
            log(`ğŸ¼ [${name}] ì‚¬ìš©. ë‹¤ìŒì€ íœ´ì‹ì…ë‹ˆë‹¤.`);
            playAnim("player-char", 'anim-bounce');
            used = true;
            break;

        case "revive":
            log("ğŸš« [ëŒ€íƒ€ ì¸í˜•]ì€ ì£½ì„ ë•Œ ìë™ ì‚¬ìš©ë©ë‹ˆë‹¤.");
            break;
    }

    // 3. ì†Œëª¨
    if (used) {
        player.consumables.splice(index, 1);
        updateInventoryUI(); // UI ê°±ì‹ 
        updateUI();
    }
}
function updateInventoryUI() {
    const rList = document.getElementById('relic-list'); 
    const cList = document.getElementById('consumable-list'); 
    rList.innerHTML = ""; 
    cList.innerHTML = "";

    // ìœ ë¬¼ í‘œì‹œ
    player.relics.forEach(name => { 
        let data = ITEM_DATA[name]; 
        let el = document.createElement('div'); 
        el.className = `item-icon item-relic item-rank-${data.rank}`; 
        el.innerHTML = `${data.icon}<span class="tooltip"><b>${name}</b><br>${data.desc}</span>`; 
        rList.appendChild(el); 
    });

    // ì†Œëª¨í’ˆ í‘œì‹œ
    player.consumables.forEach((name, idx) => { 
        let data = ITEM_DATA[name]; 
        let el = document.createElement('div'); 
        el.className = `item-icon item-consumable item-rank-${data.rank}`; 
        el.id = `item-el-${idx}`;
        
        // HTML êµ¬ì¡°
        el.innerHTML = `
            ${data.icon}
            <span class="tooltip"><b>${name}</b><br>${data.desc}</span>
            <div class="item-actions" id="item-actions-${idx}" style="display:none;">
                <button class="item-btn btn-confirm" onclick="confirmItemUse(event, ${idx})">V</button>
                <button class="item-btn btn-cancel" onclick="toggleItemSelect(event, ${idx})">X</button>
            </div>
        `;
        
        // --- [í•µì‹¬ ë¡œì§ ë³€ê²½] ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬ ---
        
        // 1. ê³µê²© ì•„ì´í…œì¸ë° ì „íˆ¬ ì¤‘ì´ ì•„ë‹ ê²½ìš°
        if (data.effect === "damage" && game.state !== "battle") {
            el.classList.add('disabled'); // íë¦¬ê²Œ í‘œì‹œ
            // í´ë¦­ ì‹œ ê²½ê³  ë©”ì‹œì§€ë§Œ ì¶œë ¥ (ë²„íŠ¼ ì•ˆ ëœ¸)
            el.onclick = () => log("ğŸš« ê³µê²© ì•„ì´í…œì€ ì „íˆ¬ ì¤‘ì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        } 
        // 2. ê·¸ ì™¸ì˜ ê²½ìš° (ì‚¬ìš© ê°€ëŠ¥)
        else {
           
            if (game.state === "battle" && data.target !== "passive") {
                el.onmousedown = (e) => startDrag(e, idx, name, 'item');
                el.ontouchstart = (e) => startDrag(e, idx, name, 'item');
            }
            
            // í´ë¦­ ì‹œ í™•ì¸/ì·¨ì†Œ ë²„íŠ¼ í† ê¸€
            el.onclick = (e) => toggleItemSelect(e, idx);
        }
        cList.appendChild(el); 
    });
}
// [ì¶”ê°€] ì•„ì´í…œ ì„ íƒ í† ê¸€ í•¨ìˆ˜
function toggleItemSelect(e, idx) {
    e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
    // ë‹¤ë¥¸ ì—´ë¦° ì•„ì´í…œ ë‹«ê¸°
    document.querySelectorAll('.item-actions').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.item-icon').forEach(el => el.classList.remove('selected'));

    let actions = document.getElementById(`item-actions-${idx}`);
    let icon = document.getElementById(`item-el-${idx}`);
    
    if (actions.style.display === 'none') {
        actions.style.display = 'flex';
        icon.classList.add('selected');
    } else {
        actions.style.display = 'none';
        icon.classList.remove('selected');
    }
}
// [ì¶”ê°€] ë²„íŠ¼ìœ¼ë¡œ ì•„ì´í…œ ì‚¬ìš© í™•ì •
function confirmItemUse(e, idx) {
    e.stopPropagation();
    let name = player.consumables[idx];
    let data = ITEM_DATA[name];

    // íƒ€ê²Ÿì´ 'enemy'ì¸ë° ì ì´ ì—¬ëŸ¬ ëª…ì´ë©´ ë“œë˜ê·¸ ìœ ë„
    if (data.target === "enemy" && enemies.filter(en => en.hp > 0).length > 1) {
        log("ğŸ–ï¸ ëŒ€ìƒì´ ì—¬ëŸ¬ ëª…ì…ë‹ˆë‹¤. ì ì—ê²Œ ë“œë˜ê·¸í•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”!");
        toggleItemSelect(e, idx); // ë‹«ê¸°
        return;
    }

    // íƒ€ê²Ÿì´ 'self'ì´ê±°ë‚˜ ì ì´ 1ëª…ì´ë©´ ì¦‰ì‹œ ì‚¬ìš©
    // (ì ì´ 1ëª…ì´ë©´ ìë™ íƒ€ê²ŸíŒ…)
    let target = player;
    if (data.target === "enemy") {
        target = enemies.find(en => en.hp > 0);
    }

    useConsumable(idx, target);
    toggleItemSelect(e, idx); // UI ê°±ì‹ ë˜ë¯€ë¡œ ì‚¬ì‹¤ í•„ìš” ì—†ì§€ë§Œ ì•ˆì „í•˜ê²Œ
}

/* [ìˆ˜ì •] ì „íˆ¬ ì‹œì‘ (ë°ì´í„° ê¸°ë°˜ ì  ìƒì„±) */
function startBattle() {
    switchScene('battle'); 
    game.state = "battle"; 
    game.totalTurns = 0;
    
    // ì  ìƒì„± ì´ˆê¸°í™”
    enemies = [];
    
    // 1. ë“±ì¥í•  ì ì˜ ìˆ˜ ê²°ì • (50% í™•ë¥ ë¡œ 1ëª… ë˜ëŠ” 2ëª…)
    let enemyCount = (Math.random() < 0.5) ? 2 : 1; 
    
    // 2. ì  ë°ì´í„° ëª©ë¡ í‚¤ ë°°ì—´
    const enemyKeys = Object.keys(ENEMY_DATA);

    for (let i = 0; i < enemyCount; i++) {
        // ëœë¤ìœ¼ë¡œ ì  ì¢…ë¥˜ ì„ íƒ
        let key = enemyKeys[Math.floor(Math.random() * enemyKeys.length)];
        let data = ENEMY_DATA[key];
        
        // ë ˆë²¨ì— ë”°ë¥¸ ìŠ¤íƒ¯ ì„±ì¥ ê³„ì‚°
        // (ë ˆë²¨ 1ì¼ ë•ŒëŠ” growthê°€ 0ë²ˆ ì ìš©ë˜ë„ë¡ game.level - 1)
        let growthMult = game.level - 1;
        
        let maxHp = Math.floor(data.baseHp + (data.growth.hp * growthMult));
        let atk = Math.floor(data.stats.atk + (data.growth.atk * growthMult));
        let def = Math.floor(data.stats.def + (data.growth.def * growthMult));
        let spd = Math.floor(data.stats.spd + (data.growth.spd * growthMult));
        
        // ìŠ¤í”¼ë“œ ëœë¤ì„± (ì•½ê°„ì˜ ë³€ìˆ˜)
        spd += Math.floor(Math.random() * 2);

        enemies.push({ 
            id: i, 
            name: `${data.name} ${String.fromCharCode(65+i)}`, // ì˜ˆ: ë¶ˆëŸ‰ë°° A
            maxHp: maxHp, 
            hp: maxHp, 
            baseAtk: atk, 
            baseDef: def, 
            baseSpd: spd,
            block: 0, 
            buffs: {}, 
            deck: getEnemyDeck(data.deckType), // ë± íƒ€ì…ì— ë§ì¶° ìƒì„±
            img: data.img, // ë°ì´í„°ì— ìˆëŠ” ì´ë¯¸ì§€ ì‚¬ìš©
            
            // í–‰ë™ ê²Œì´ì§€ (ì„ ê³µ ëœë¤ì„±ì„ ìœ„í•´ 0~20% ë¯¸ë¦¬ ì±„ì›€)
            ag: Math.floor(Math.random() * 150) 
        });
    }

    // í”Œë ˆì´ì–´ ì´ˆê¸°í™”
    player.drawPile = [...player.deck]; shuffle(player.drawPile);
    player.discardPile = []; player.exhaustPile = []; player.hand = [];
    player.buffs = {}; player.block = 0; player.lucky = false; player.jumadeung = false;
    
    player.ag = 0; 

    log(`âš”ï¸ ì „íˆ¬ ì‹œì‘! (Enemy: ${enemies.map(e=>e.name.split(' ')[0]).join(', ')})`); 
    
    renderEnemies();
    updateUI(); 

    // íƒ€ì„ë¼ì¸ ê°€ë™
    processTimeline();
}

async function processTimeline() {
    if (checkGameOver()) return;

    // 1. í˜„ì¬ í„´ì„ ì¡ì„ ìˆ˜ ìˆëŠ” í›„ë³´ ì°¾ê¸° (AG >= 1000)
    // í›„ë³´ê°€ ì—¬ëŸ¬ ëª…ì´ë©´ AGê°€ ê°€ì¥ ë†’ì€ ìˆœì„œëŒ€ë¡œ (ì˜¤ë²„í”Œë¡œìš° ê³ ë ¤)
    let candidates = [];
    
    // í”Œë ˆì´ì–´ ì²´í¬
    if (player.ag >= game.AG_MAX) candidates.push({ unit: player, type: 'player', ag: player.ag });
    // ì  ì²´í¬
    enemies.forEach(e => {
        if (e.hp > 0 && e.ag >= game.AG_MAX) candidates.push({ unit: e, type: 'enemy', ag: e.ag });
    });

    // 2. í„´ ëŒ€ìƒìê°€ ìˆë‹¤ë©´ í–‰ë™ ê°œì‹œ
    if (candidates.length > 0) {
        // AGê°€ ê°€ì¥ ë†’ì€ ìœ ë‹›ì´ ìš°ì„ ê¶Œì„ ê°€ì§
        candidates.sort((a, b) => b.ag - a.ag);
        let winner = candidates[0];

        // í„´ ì‹œì‘ ì²˜ë¦¬
        await startTurn(winner.unit, winner.type);
        return;
    }

    // 3. í„´ ëŒ€ìƒìê°€ ì—†ë‹¤ë©´ ì‹œê°„ì„ í˜ë ¤ë³´ëƒ„ (Tick)
    // ëª¨ë“  ìœ ë‹›ì˜ AGì— ìì‹ ì˜ ì†ë„(Spd)ë¥¼ ë”í•¨
    // ì‹œê°ì  ì—°ì¶œì„ ìœ„í•´ ì¡°ê¸ˆì”© ë”í•˜ëŠ” ê²Œ ì¢‹ì§€ë§Œ, ë¡œì§ ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ í•œ ë²ˆì— ê³„ì‚°
    // "ê°€ì¥ ë¹ ë¥¸ ë…€ì„ì´ ëª©í‘œì— ë„ë‹¬í•  ë•Œê¹Œì§€" ì‹œê°„ì„ ì í”„ì‹œí‚µë‹ˆë‹¤.
    
    // (1) í˜„ì¬ ê°€ì¥ AGê°€ ë†’ì€ ë¹„ìœ¨ì„ ê³„ì‚°í•´ì„œ í•œ ë²ˆì— ì í”„í•  ìˆ˜ë„ ìˆì§€ë§Œ,
    // ê°„ë‹¨í•˜ê²Œ Tick ë‹¨ìœ„(ì˜ˆ: ì†ë„ì˜ 10%)ë¡œ ë°˜ë³µí•´ì„œ ë”í•¨
    while (true) {
        let anyoneReady = false;
        
        // í”Œë ˆì´ì–´ AG ì¦ê°€
        let pSpd = getStat(player, 'spd');
        player.ag += pSpd;
        if (player.ag >= game.AG_MAX) anyoneReady = true;

        // ì  AG ì¦ê°€
        enemies.forEach(e => {
            if (e.hp > 0) {
                let eSpd = getStat(e, 'spd');
                e.ag += eSpd;
                if (e.ag >= game.AG_MAX) anyoneReady = true;
            }
        });

        // ëˆ„êµ°ê°€ ì¤€ë¹„ë˜ì—ˆìœ¼ë©´ ë£¨í”„ ì¢…ë£Œí•˜ê³  ì¬ê·€ í˜¸ì¶œ -> 1ë²ˆ ë‹¨ê³„ì—ì„œ ê±¸ë¦¼
        if (anyoneReady) {
            updateUI(); // ê²Œì´ì§€ ì°¨ëŠ” ê±° ê°±ì‹ 
            processTimeline(); // ë‹¤ì‹œ ì²´í¬
            return;
        }
    }
}
/* [NEW] ìœ ë‹› í„´ ì‹œì‘ í†µí•© ì²˜ë¦¬ */
async function startTurn(unit, type) {
    game.turnOwner = type;
    game.totalTurns++;
    
    // ë¡œê·¸ ë° ê°•ì¡°
    let name = (type === 'player') ? "ë‚˜" : unit.name;
    // log(`â° [${name}]ì˜ í„´! (AG: ${Math.floor(unit.ag)})`);
    
    // 1. ë²„í”„/ë””ë²„í”„ ì²˜ë¦¬ (ì´ì œ ìê¸° í„´ì´ ì˜¬ ë•Œë§ˆë‹¤ í‹±ì´ ëŒì•„ê°)
    tickBuffs(unit); 
    decrementBuffs(unit);
    
    if (checkGameOver()) return;
    if (unit.hp <= 0) { // ë²„í”„ ë€ìœ¼ë¡œ ì£½ì—ˆì„ ê²½ìš°
        processTimeline(); 
        return; 
    }

    // 2. í–‰ë™ ê²Œì´ì§€ ì†Œëª¨ (1000ì„ ëºŒ = ì˜¤ë²„í”Œë¡œìš° ëœ ë§Œí¼ ë‹¤ìŒ í„´ ë¹¨ë¦¬ ì˜´)
    unit.ag -= game.AG_MAX;
    
    // UI ê°±ì‹  (AG ì¤„ì–´ë“  ê²ƒ ë°˜ì˜)
    updateUI();

    // 3. ì‹¤ì œ ì œì–´ê¶Œ ë¶€ì—¬
    if (type === 'player') {
        // í”Œë ˆì´ì–´: ì…ë ¥ ëŒ€ê¸° ìƒíƒœë¡œ ì „í™˜
        startPlayerTurnLogic();
    } else {
        // ì : AI ìë™ í–‰ë™
        game.currentActorId = unit.id;
        await startEnemyTurnLogic(unit);
    }
}
// ì ë“¤ì˜ HTML ë¼ˆëŒ€ë¥¼ ë§Œë“œëŠ” í•¨ìˆ˜
function renderEnemies() {
    const wrapper = document.getElementById('enemies-area');
    wrapper.innerHTML = ""; // ì´ˆê¸°í™”

    enemies.forEach(e => {
        let el = document.createElement('div');
        el.className = 'enemy-unit';
        el.id = `enemy-unit-${e.id}`; // ì˜ˆ: enemy-unit-0
        
        // ë‚´ë¶€ëŠ” updateUIì—ì„œ ìˆ˜ì¹˜ì™€ í•¨ê»˜ ì±„ì›Œì§‘ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” ì´ë¯¸ì§€ íƒœê·¸ ë“± ê¸°ë³¸ êµ¬ì¡°ë§Œ ì¡ì•„ë„ ë˜ì§€ë§Œ, 
        // í¸ì˜ìƒ updateUIê°€ ë‚´ìš©ì„ ë‹¤ ë®ì–´ì“°ë„ë¡ ë¹„ì›Œë‘¡ë‹ˆë‹¤.
        
        wrapper.appendChild(el);
    });
}

/* [ìˆ˜ì •] í”Œë ˆì´ì–´ í–‰ë™ ê°œì‹œ */
function startPlayerTurnLogic() {
    // í„´ ì‹œì‘ ì‹œ ë°©ì–´ë„ ì´ˆê¸°í™” (ì›ë˜ ìê¸° í„´ ì‹œì‘ ë•Œ ì´ˆê¸°í™”ë˜ëŠ” ê²Œ ë§ìŒ)
    player.block = 0; 
    player.ap = 3; 
    drawCards(5); 

    document.getElementById('end-turn-btn').disabled = false;
    document.getElementById('turn-info').innerText = `ë‚˜ì˜ í„´ (AP: ${player.ap})`;
    
    document.getElementById('player-char').classList.add('turn-active'); 
    document.querySelectorAll('.enemy-unit').forEach(e => e.classList.remove('turn-active'));
    
    // ì†ë„ ì˜ˆì¸¡ UI ê°±ì‹  (ì„ íƒì‚¬í•­)
    updateTurnOrderList(); 
}

/* [ìˆ˜ì •] í”Œë ˆì´ì–´ í„´ ì¢…ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ */
function endPlayerTurn() {
    document.getElementById('end-turn-btn').disabled = true;
    
    // íŒ¨ ë²„ë¦¬ê¸°
    if (player.hand.length > 0) { 
        player.discardPile.push(...player.hand); 
        player.hand = []; 
    }
    renderHand(); 
    
    game.turnOwner = "none"; 
    document.getElementById('player-char').classList.remove('turn-active');
    
    // â˜… ì¤‘ìš”: ë‚´ í–‰ë™ì´ ëë‚¬ìœ¼ë‹ˆ ë‹¤ì‹œ íƒ€ì„ë¼ì¸ì„ ëŒë¦½ë‹ˆë‹¤.
    // ë§Œì•½ ë‚´ ì†ë„ê°€ ì••ë„ì ì´ë¼ AGê°€ 1000 ì´ìƒ ë‚¨ì•˜ë‹¤ë©´? processTimelineì´ ì¦‰ì‹œ ë‚˜ë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•¨ (ì—°ì† í„´)
    processTimeline();
}

/* [ìˆ˜ì •] ì  í–‰ë™ ê°œì‹œ (AI) */
async function startEnemyTurnLogic(actor) {
    actor.block = 0; 
    actor.ap = 2; 
    
    let el = document.getElementById(`enemy-unit-${actor.id}`);
    if(el) el.classList.add('turn-active');
    
    // log(`ğŸ‘¿ ${actor.name} í–‰ë™ ì‹œì‘`);

    // ê°„ë‹¨í•œ AI ë™ì‘
    while (actor.ap > 0 && player.hp > 0) {
        await sleep(800);
        if (actor.hp <= 0) break;

        let cName = actor.deck[Math.floor(Math.random() * actor.deck.length)];
        actor.ap--; 
        useCard(actor, player, cName); 
        
        updateUI(); 
        if (checkGameOver()) return;
    }
    
    if(el) el.classList.remove('turn-active');
    await sleep(500);

    // â˜… ì  í–‰ë™ ì¢…ë£Œ í›„ íƒ€ì„ë¼ì¸ ì¬ê°€ë™
    processTimeline();
}

function useCard(user, target, cardName) {
    let data = CARD_DATA[cardName];
    let atk = getStat(user, 'atk');
    let def = getStat(user, 'def');
    
    log(`ğŸƒ ${user===player?"ë‚˜":"ì "}ì˜ [${cardName}]!`);
 // [ë³€ê²½] User ID ì°¾ê¸° (ì ì´ ì—¬ëŸ¬ ëª…ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
    let userId = (user === player) ? "player-char" : `enemy-unit-${user.id}`;

    // 1. ê³µê²©
    if (data.type.includes("attack")) {
        if (user === player) playAnim(userId, 'anim-atk-p');
        else playAnim(userId, 'anim-atk-e');

        if (data.special === "break_block") { target.block = 0; log(`ğŸ”¨ ë°©ì–´êµ¬ íŒŒê´´!`); }
        if (data.special === "lucky" && user === player) { player.lucky = true; log(`ğŸ€ í–‰ìš´ ë°œë™!`); }

        let finalDmg = (data.dmg || 0) + atk;
        takeDamage(target, finalDmg);
    } 
    // 2. ìŠ¤í‚¬
    else {
        playAnim(userId, 'anim-bounce');
    }

    // 3. ë°©ì–´ ë° ë²„í”„
    if (data.block) {
        let finalBlock = data.block + def;
        user.block += finalBlock;
        log(`ğŸ›¡ï¸ ë°©ì–´ë„ +${finalBlock}`);
    }

    if (data.buff) {
        let buffName = data.buff.name;
        let buffVal = data.buff.val;
        let buffTarget = target; 
        
        const selfBuffs = ["ê°•í™”", "ê±´ê°•", "ì¾Œì†", "í™œë ¥"];
        if (data.target === "self" || selfBuffs.includes(buffName)) { 
            buffTarget = user; 
        }
        applyBuff(buffTarget, buffName, buffVal);
    }
    
    // 4. ë“œë¡œìš°
    if (data.draw && user === player) {
        drawCards(data.draw);
        log(`ğŸƒ ì¹´ë“œë¥¼ ${data.draw}ì¥ ë½‘ì•˜ìŠµë‹ˆë‹¤.`);
    }

    // 5. (ì†ë„/ì¶”ê°€í„´ ë¡œì§ì€ ë‹¤ìˆ˜ ì „íˆ¬ì—ì„œ ë³µì¡í•˜ë¯€ë¡œ ì¼ë‹¨ ìƒëµí•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ì¶”ê°€)
}

// [ìˆ˜ì •] ë°ë¯¸ì§€ ì²˜ë¦¬ í•¨ìˆ˜
function takeDamage(target, dmg) {
    // [ë³€ê²½] íƒ€ê²Ÿ ID ì°¾ê¸°
    let targetId = (target === player) ? "player-char" : `enemy-unit-${target.id}`;
    
    playAnim(targetId, 'anim-hit');

    if (target.block > 0) {
        if (target.block >= dmg) {
            target.block -= dmg;
            dmg = 0; 
        } else {
            dmg -= target.block;
            target.block = 0; 
        }
    }

    if (dmg > 0) {
        showDamageText(target, dmg);
    } else {
        showDamageText(target, "BLOCK");
    }

    target.hp -= dmg;
    log(`ğŸ’¥ ${dmg} í”¼í•´! (HP: ${target.hp})`); // (ë¡œê·¸ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì£¼ì„ ì²˜ë¦¬)
    updateUI();
    // 4. [í”Œë ˆì´ì–´ ì‚¬ë§ ìœ„ê¸° ì²˜ë¦¬] HPê°€ 0 ì´í•˜ì¼ ë•Œ ìƒì¡´ ë¡œì§ ê°€ë™
    if (target === player && target.hp <= 0) {

        // (1ë‹¨ê³„) ì•„ì´í…œ ë¶€í™œ ì²´í¬: 'effect'ê°€ 'revive'ì¸ ì•„ì´í…œ ì°¾ê¸°
        // (ì´ë¦„("ëŒ€íƒ€ ì¸í˜•")ìœ¼ë¡œ ì°¾ì§€ ì•Šê³  íš¨ê³¼ë¡œ ì°¾ìœ¼ë¯€ë¡œ, ë‚˜ì¤‘ì— ì•„ì´í…œ ì´ë¦„ì´ ë°”ë€Œì–´ë„ ì‘ë™í•¨)
        let reviveItemIdx = player.consumables.findIndex(name => ITEM_DATA[name].effect === "revive");

        if (reviveItemIdx !== -1) {
            let itemName = player.consumables[reviveItemIdx]; // ì•„ì´í…œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            
            player.hp = player.maxHp; // í’€í”¼ ë¶€í™œ
            player.consumables.splice(reviveItemIdx, 1); // ì•„ì´í…œ ì†Œëª¨

            log(`âœ¨ [${itemName}]ì˜ íš¨ê³¼ë¡œ ë¶€í™œí–ˆìŠµë‹ˆë‹¤!`);
            playAnim(targetId, 'anim-bounce'); // ë¶€í™œí•´ì„œ ê¸°ì˜ë‹ˆê¹Œ ì í”„ ëª¨ì…˜

            updateInventoryUI();
            updateUI();
            return; // ì£½ì§€ ì•Šê³  ì—¬ê¸°ì„œ ì¢…ë£Œ
        }

        // (2ë‹¨ê³„) ìœ ë¬¼ ë¶€í™œ ì²´í¬: 'í™©ê¸ˆ ëŒ€íƒ€' (ê³¨ë“œ ì†Œëª¨)
        if (player.relics.includes("í™©ê¸ˆ ëŒ€íƒ€") && player.gold >= 1000) {
            player.gold -= 1000;
            player.hp = player.maxHp;

            log("ğŸº [í™©ê¸ˆ ëŒ€íƒ€]ê°€ 1000ì›ì„ ì†Œëª¨í•˜ì—¬ ë‹¹ì‹ ì„ ì‚´ë ¸ìŠµë‹ˆë‹¤!");
            playAnim(targetId, 'anim-bounce');

            updateUI();
            return;
        }

        // (3ë‹¨ê³„) ì£¼ë§ˆë“± ì‹œìŠ¤í…œ: ì•„ë¬´ê²ƒë„ ì—†ì„ ë•Œ ë”± í•œ ë²ˆ 1ë¡œ ë²„íŒ€
        if (!target.jumadeung) {
            target.hp = 1;
            target.jumadeung = true; // ì£¼ë§ˆë“± ì‚¬ìš© ì²˜ë¦¬

            log("âš¡ [ì£¼ë§ˆë“±] ì¹˜ëª…ì ì¸ ê³µê²©ì„ ê°„ì‹ íˆ ë²„í…¼ìŠµë‹ˆë‹¤! (HP 1)");
            playAnim(targetId, 'anim-bounce');

            updateUI();
            return;
        }

        // (4ë‹¨ê³„) ì—¬ê¸°ê¹Œì§€ ì™”ìœ¼ë©´ ì§„ì§œ ì‚¬ë§... (checkGameOverì—ì„œ ê²Œì„ ì˜¤ë²„ ì²˜ë¦¬ë¨)
    }
}
        /* [ì¶”ê°€] ëŒ€ë¯¸ì§€ í°íŠ¸ ì¶œë ¥ í•¨ìˆ˜ */
        function showDamageText(target, text) {
            // 1. ë„ìš¸ ìœ„ì¹˜(ìºë¦­í„° ë°•ìŠ¤) ì°¾ê¸°
            let targetId;
                if (target === player) {
                    targetId = "player-char";
                } else {
                    // ì  ê°ì²´(target)ì— ìˆëŠ” idë¥¼ ì‚¬ìš©í•´ HTML ìš”ì†Œ IDë¥¼ êµ¬ì„±
                    targetId = `enemy-unit-${target.id}`; 
                }

                let parentEl = document.getElementById(targetId);
                
                // ë§Œì•½ ìš”ì†Œë¥¼ ëª» ì°¾ìœ¼ë©´(ì´ë¯¸ ì£½ì–´ì„œ ì‚¬ë¼ì¡Œê±°ë‚˜ ì—ëŸ¬) ê·¸ëƒ¥ ì¤‘ë‹¨ (ê²Œì„ ë©ˆì¶¤ ë°©ì§€)
                if (!parentEl) return;

            // 2. í…ìŠ¤íŠ¸ ìš”ì†Œ ìƒì„± (div)
            let el = document.createElement("div");
            el.className = "damage-number";
            el.innerText = text; // ìˆ«ìë‚˜ í…ìŠ¤íŠ¸(BLOCK ë“±)

            // 3. ìºë¦­í„° ë°•ìŠ¤ ì•ˆì— ë¶™ì´ê¸°
            parentEl.appendChild(el);

            // 4. ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„(0.8ì´ˆ) ë’¤ì— HTMLì—ì„œ ì™„ì „ ì œê±° (ì²­ì†Œ)
            setTimeout(() => {
                el.remove();
            }, 800);
        }
/* [ìˆ˜ì •] ìŠ¹íŒ¨ íŒì • ë¡œì§ (ë‹¤ìˆ˜ ì  ëŒ€ì‘) */
function checkGameOver() {
    if (player.hp <= 0) { 
        showPopup("ğŸ’€ ê²Œì„ ì˜¤ë²„", "íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...", [{txt:"ë‹¤ì‹œ í•˜ê¸°", func: ()=>location.reload()}]); 
        return true; 
    }
    
    // [ë³€ê²½] ì‚´ì•„ìˆëŠ” ì ì´ í•˜ë‚˜ë„ ì—†ì–´ì•¼ ìŠ¹ë¦¬ (enemies ë°°ì—´ í™•ì¸)
    if (enemies.every(e => e.hp <= 0)) {
        if(game.state === "win") return true; 
        game.state = "win";
        
        // 1. ë³´ìƒ ê³„ì‚°
        let rewardGold = 1000 * (player.lucky ? 2 : 1); 
        player.gold += rewardGold; 
        
        let gainXp = 40 + (game.level * 10);
        player.xp += gainXp;

        // 2. ë©”ì‹œì§€ ì„¤ì •
        game.winMsg = `ìŠ¹ë¦¬! ${rewardGold}ì›, ${gainXp} XP íšë“.`; 
        if (player.lucky) game.winMsg += " (ëŸ­í‚¤í”¼ìŠ¤ íš¨ê³¼!)";

        // 3. ì•„ì´í…œ ë“œë (í…ŒìŠ¤íŠ¸ìš© í™•ë¥ )
        game.pendingLoot = null;
        if (Math.random() < 1.0) { 
            game.pendingLoot = getRandomItem();
            game.winMsg += `<br>âœ¨ ì „ë¦¬í’ˆì´ ë°”ë‹¥ì— ë–¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.`;
        }
        
        updateUI(); 
        renderWinPopup(); // ìŠ¹ë¦¬ íŒì—… í‘œì‹œ
        return true;
    }
    return false;
}
/* --- ì´ë²¤íŠ¸ ë° ìƒì  --- */
/* [ìˆ˜ì •] runRandomEvent í•¨ìˆ˜ */
function runRandomEvent() {
    if (game.forceRest) {
        game.forceRest = false;
        
        game.hasRested = false; // [NEW] íœ´ì‹ ì—¬ë¶€ ì´ˆê¸°í™”
        renderRestScreen();
        return;
    }

    let rand = Math.random();
    if (rand < 0.6) {
        startBattle();
    } else if (rand < 0.8) {
        game.hasRested = false; // [NEW] íœ´ì‹ ì—¬ë¶€ ì´ˆê¸°í™”
        renderRestScreen();
    } else {
        renderShopScreen();
    }
}
/* [ìˆ˜ì •] renderRestScreen í•¨ìˆ˜ ì „ì²´ êµì²´ */
function renderRestScreen() {
    switchScene('event');
    const container = document.getElementById('event-content-box');
    
    // íœ´ì‹ ë²„íŠ¼ HTML ìƒì„± (ìƒíƒœì— ë”°ë¼ ë‹¤ë¦„)
    let restBtnHTML = "";
    if (!game.hasRested) {
        // ì•„ì§ íœ´ì‹ ì•ˆ í•¨: ë²„íŠ¼ í™œì„±í™”
        restBtnHTML = `<button class="action-btn" onclick="restAction()">ğŸ˜´ ì‰¬ê¸° (50% íšŒë³µ)</button>`;
    } else {
        // ì´ë¯¸ íœ´ì‹ í•¨: ë²„íŠ¼ ëŒ€ì‹  í…ìŠ¤íŠ¸ í‘œì‹œ
        restBtnHTML = `<button class="action-btn" disabled style="background:#555; cursor:default;">âœ… íœ´ì‹ ì™„ë£Œ</button>`;
    }

    container.innerHTML = `
        <div class="event-title">ğŸ”¥ íœ´ì‹ì²˜</div>
        <div class="event-desc">
            ë”°ëœ»í•œ ëª¨ë‹¥ë¶ˆì´ ìˆìŠµë‹ˆë‹¤.<br>
            ì ì‹œ ì‰¬ì–´ê°€ê±°ë‚˜ ì •ë¹„ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>
            <span style="color:#e74c3c">í˜„ì¬ HP: ${player.hp} / ${player.maxHp}</span>
        </div>
        
        <div style="display:flex; justify-content:center; gap:20px;">
            ${restBtnHTML}
            <button class="action-btn" style="background:#7f8c8d" onclick="startBattle()">ğŸ‘£ ë– ë‚˜ê¸°</button>
        </div>
        
        <div style="margin-top:20px; font-size:0.9em; color:#aaa;">
            (ë– ë‚˜ê¸° ì „ì— ì¸ë²¤í† ë¦¬ì˜ ì•„ì´í…œì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
        </div>
    `;
}
/* [ìˆ˜ì •] restAction í•¨ìˆ˜ ì „ì²´ êµì²´ */
function restAction() {
    // 1. íšŒë³µ ë¡œì§
    let maxHeal = Math.floor(player.maxHp / 2);
    let missingHp = player.maxHp - player.hp;
    let actualHeal = Math.min(maxHeal, missingHp);
    
    player.hp += actualHeal;
    game.hasRested = true; // [NEW] íœ´ì‹ ì™„ë£Œ í”Œë˜ê·¸ ì„¸íŒ…
    
    updateUI();
    
    // 2. íŒì—…ì„ ë„ìš°ë˜, í™•ì¸ ëˆ„ë¥´ë©´ 'ë– ë‚˜ê¸°'ê°€ ì•„ë‹ˆë¼ íŒì—…ë§Œ ë‹«í˜
    showPopup("íœ´ì‹ ì™„ë£Œ", `ì²´ë ¥ì´ ${actualHeal}ë§Œí¼ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì´ì œ ì¶œë°œ ì¤€ë¹„ê°€ ë˜ì…¨ë‚˜ìš”?`, [
        {
            txt: "í™•ì¸", 
            func: () => {
                closePopup();
                renderRestScreen(); // [NEW] ë²„íŠ¼ ìƒíƒœ ê°±ì‹ ì„ ìœ„í•´ í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            }
        }
    ]);
}
function renderShopScreen() {
    switchScene('event');
    let saleCard = getRandomCard(); 
    let cardData = CARD_DATA[saleCard]; 
    let shopRelic = getRandomItem('relic'); 
    let shopConsumable = getRandomItem('consumable');

    document.getElementById('event-content-box').innerHTML = `
        <div class="event-title">ğŸ’° ìƒì¸</div>
        <div class="event-desc">"ê³¨ë¼ë³´ê²Œë‚˜."<br><span style="color:#f1c40f">ê³¨ë“œ: ${player.gold}</span></div>
        <div class="shop-items">
            <div class="shop-item" onclick="buyShopItem(this, 'card', '${saleCard}', 1000)">
                <div class="card">
                    <div class="card-cost">${cardData.cost}</div>
                    <div class="card-rank">${"â˜…".repeat(cardData.rank)}</div>
                    <div class="card-name">${saleCard}</div>
                    <div class="card-desc">${applyTooltip(cardData.desc)}</div>
                </div>
                <div class="shop-price">1000ì›</div>
            </div>

            <div class="shop-item" onclick="buyShopItem(this, 'relic', '${shopRelic}', ${ITEM_DATA[shopRelic].price})">
                <div class="item-icon item-relic item-rank-${ITEM_DATA[shopRelic].rank}" style="width:80px; height:80px; font-size:2em;">
                    ${ITEM_DATA[shopRelic].icon}
                    <span class="tooltip"><b>${shopRelic}</b><br>${ITEM_DATA[shopRelic].desc}</span>
                </div>
                <div class="shop-price">${ITEM_DATA[shopRelic].price}ì›</div>
                <div style="font-size:0.8em; margin-top:5px;">${shopRelic}</div>
            </div>
            <div class="shop-item" onclick="buyShopItem(this, 'consumable', '${shopConsumable}', ${ITEM_DATA[shopConsumable].price})">
                <div class="item-icon item-consumable item-rank-${ITEM_DATA[shopConsumable].rank}" style="width:80px; height:80px; font-size:2em;">
                    ${ITEM_DATA[shopConsumable].icon}
                    <span class="tooltip"><b>${shopConsumable}</b><br>${ITEM_DATA[shopConsumable].desc}</span>
                </div>
                <div class="shop-price">${ITEM_DATA[shopConsumable].price}ì›</div>
                <div style="font-size:0.8em; margin-top:5px;">${shopConsumable}</div>
            </div>
        </div>
        <button class="action-btn" style="background:#7f8c8d" onclick="startBattle()">ğŸ‘£ ë‚˜ê°€ê¸°</button>`;
}
function buyShopItem(el, type, name, cost) {
    if (el.classList.contains('sold-out')) return;
    if (player.gold < cost) { showPopup("êµ¬ë§¤ ì‹¤íŒ¨", "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", [{txt:"í™•ì¸", func: closePopup}]); return; }
    if (type === 'relic' && player.relics.includes(name)) { showPopup("êµ¬ë§¤ ë¶ˆê°€", "ì´ë¯¸ ë³´ìœ  ì¤‘ì…ë‹ˆë‹¤.", [{txt:"í™•ì¸", func: closePopup}]); return; }
    player.gold -= cost; el.classList.add('sold-out');
    if (type === 'card') { player.deck.push(name); showPopup("ì„±ê³µ", `[${name}] êµ¬ë§¤ ì™„ë£Œ.`, [{txt:"í™•ì¸", func: closePopup}]); }
    else { addItem(name); showPopup("ì„±ê³µ", `[${name}] êµ¬ë§¤ ì™„ë£Œ.`, [{txt:"í™•ì¸", func: closePopup}]); }
    updateUI();
}

/* --- ìœ í‹¸ë¦¬í‹° ë° ê³„ì‚° --- */
function getStat(entity, type) {
    let val = (type==='atk')? entity.baseAtk : (type==='def')? entity.baseDef : entity.baseSpd;
    if (entity === player) { if (type === 'atk' && player.relics.includes("ì¿ ë³´íƒ„")) val += 1; if (type === 'def' && player.relics.includes("ê°•ì¸í•¨ì˜ ë¶€ì ")) val += 1; if (type === 'spd' && player.relics.includes("ì¢‹ì€ ìš´ë™í™”")) val += 1; }
    if (type==='atk') { if (entity.buffs["ì•½í™”"]) val /= 2; if (entity.buffs["ê°•í™”"]) val *= 2; } else if (type==='def') { if (entity.buffs["ì·¨ì•½"]) val /= 2; if (entity.buffs["ê±´ê°•"]) val *= 2; } else if (type==='spd') { if (entity.buffs["ë§ˆë¹„"]) val /= 2; if (entity.buffs["ì¾Œì†"]) val *= 2; }
    return Math.floor(val);
}
function applyBuff(entity, name, dur) { if (name === "ë…" || name === "í™œë ¥") entity.buffs[name] = (entity.buffs[name] || 0) + dur; else entity.buffs[name] = dur; log(`âœ¨ ${entity===player?"ë‚˜":"ì "}ì—ê²Œ [${name}] ì ìš©`); }
function tickBuffs(entity) {
    if (entity.buffs["ë…"]) { let dmg = entity.buffs["ë…"]; log(`â˜ ï¸ ë… í”¼í•´ ${dmg}!`); takeDamage(entity, dmg); }
    if (entity.buffs["í™œë ¥"]) { let heal = entity.buffs["í™œë ¥"]; entity.hp = Math.min(entity.maxHp, entity.hp + heal); log(`ğŸŒ¿ í™œë ¥ íšŒë³µ +${heal}`); updateUI(); }
}
function decrementBuffs(entity) { for (let k in entity.buffs) { entity.buffs[k]--; if (entity.buffs[k] <= 0) delete entity.buffs[k]; } }
function addRandomCard(rank) { let pool = Object.keys(CARD_DATA).filter(k => CARD_DATA[k].rank === rank); player.deck.push(pool[Math.floor(Math.random() * pool.length)]); }
function getRandomCard() { let r = Math.random()*100; let rank = (r<70)?1:(r<95)?2:3; let pool = Object.keys(CARD_DATA).filter(k => CARD_DATA[k].rank === rank); return pool[Math.floor(Math.random()*pool.length)]; }
function getRandomItem(typeFilter) { let pool = Object.keys(ITEM_DATA); if (typeFilter) pool = pool.filter(k => ITEM_DATA[k].type === typeFilter); let r=Math.random()*100; let rank=(r<70)?1:(r<90)?2:3; let rankPool=pool.filter(k=>ITEM_DATA[k].rank===rank); if(rankPool.length===0) rankPool=pool; return rankPool[Math.floor(Math.random()*rankPool.length)]; }

/* --- UI Render Helpers --- */
/* [ìˆ˜ì •] drawCards í•¨ìˆ˜: ì†íŒ¨ ì´ˆê³¼ ì‹œ ìë™ ë²„ë¦¼ ì²˜ë¦¬ */
function drawCards(n) {
    const MAX_HAND_SIZE = 10; // ìµœëŒ€ í•¸ë“œ ë§¤ìˆ˜

    for(let i=0; i<n; i++) {
        // 1. ë± ë¦¬í•„ í™•ì¸
        if (player.drawPile.length === 0) {
            if (player.discardPile.length > 0) { 
                log("ğŸ”„ ë±ì„ ì„ìŠµë‹ˆë‹¤!"); 
                player.drawPile = [...player.discardPile]; 
                player.discardPile = []; 
                shuffle(player.drawPile); 
            }
            else {
                // ë±ë„ ì—†ê³  ë²„ë¦° ì¹´ë“œë„ ì—†ìœ¼ë©´ ì•„ì˜ˆ ë½‘ì„ ìˆ˜ ì—†ìŒ
                break; 
            }
        }
        
        // 2. ì¼ë‹¨ ì¹´ë“œë¥¼ ë½‘ìŒ
        let card = player.drawPile.pop();

        // 3. ì†íŒ¨ ê³µê°„ í™•ì¸
        if (player.hand.length < MAX_HAND_SIZE) {
            // ê³µê°„ì´ ìˆìœ¼ë©´ ì†íŒ¨ë¡œ
            player.hand.push(card);
        } else {
            // ê³µê°„ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ë²„ë¦¼ íŒ¨ë¡œ ì´ë™ (ì¹´ë“œê°€ íƒ€ë²„ë¦¼)
            player.discardPile.push(card);
            log(`ğŸ”¥ ì†íŒ¨ê°€ ê½‰ ì°¨ì„œ [${card}] ì¹´ë“œê°€ ë²„ë ¤ì¡ŒìŠµë‹ˆë‹¤!`);
            
            // ì‹œê°ì  íš¨ê³¼ (ë²„ë¦¼ ì¹´ë“œ ë”ë¯¸ê°€ í”ë“¤ë¦¼)
            playAnim('btn-discard-pile', 'anim-bounce');
        }
    }
    
    renderHand(); 
    updateUI();
}

/* [ìˆ˜ì •] UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì  ìƒíƒœì´ìƒ ë° ìŠ¤íƒ¯ í‘œì‹œ ë³µêµ¬) */
function updateUI() {
    // 1. ìƒë‹¨ ì •ë³´ (í”Œë ˆì´ì–´)
    let xpPercent = Math.floor((player.xp / player.maxXp) * 100);
    
    document.getElementById('game-info').innerHTML = 
        `Lv.${game.level} <span style="font-size:0.8em; color:#aaa;">(${player.xp}/${player.maxXp})</span> | ğŸ’° ${player.gold}ì›
         <div style="width:100%; height:4px; background:#444; margin-top:5px; border-radius:2px;">
            <div style="width:${xpPercent}%; height:100%; background:#3498db; transition: width 0.3s;"></div>
         </div>`;

    document.getElementById('p-hp').innerText = player.hp; 
    document.getElementById('p-max-hp').innerText = player.maxHp; 
    document.getElementById('p-block').innerText = player.block; 
    document.getElementById('p-hp-bar').style.width = Math.max(0, (player.hp/player.maxHp)*100) + "%"; 
    document.getElementById('p-stats').innerText = `ê³µ${getStat(player,'atk')} ë°©${getStat(player,'def')} ì†${getStat(player,'spd')}`;
    document.getElementById('p-buffs').innerHTML = applyTooltip(Object.entries(player.buffs).map(([k,v])=>`${k}(${v})`).join(', '));
    
    document.getElementById('btn-draw-pile').innerText = `ë± (${player.drawPile.length})`;
    document.getElementById('btn-discard-pile').innerText = `ë²„ë¦¼ (${player.discardPile.length})`;
    document.getElementById('btn-exhaust-pile').innerText = `ì†Œë©¸ (${player.exhaustPile.length})`;
    
    updateInventoryUI();

    // 2. ì  UI ì—…ë°ì´íŠ¸
    if (!enemies || enemies.length === 0) return;

    enemies.forEach(e => {
        let el = document.getElementById(`enemy-unit-${e.id}`);
        // HTML ìš”ì†Œê°€ ì—†ìœ¼ë©´ íŒ¨ìŠ¤
        if (!el) return; 

        // ì£½ì€ ê²½ìš° ì²˜ë¦¬
        if (e.hp <= 0) {
            if (!el.classList.contains('dead')) {
                el.className = 'enemy-unit dead';
                el.innerHTML = `<div style="margin-top:50px; color:#777;">ğŸ’€<br>${e.name}</div>`;
            }
            return;
        }

        // ì‚° ê²½ìš°
        let hpPct = Math.max(0, (e.hp / e.maxHp) * 100);
        // í–‰ë™ ê²Œì´ì§€(AG) í¼ì„¼íŠ¸ ê³„ì‚°
        let agPct = Math.min(100, (e.ag / game.AG_MAX) * 100);
        
        // ë²„í”„ í…ìŠ¤íŠ¸ ìƒì„±
        let buffText = applyTooltip(Object.entries(e.buffs).map(([k,v])=>`${k}(${v})`).join(', '));
        
        // ì˜ë„(Intent) í‘œì‹œ
        let intent = "ğŸ’¤";
        if (game.turnOwner === "enemy" && game.currentActorId === e.id) intent = "âš”ï¸";

        el.innerHTML = `
            <div style="font-weight:bold; font-size:0.9em; margin-bottom:5px;">${e.name} ${intent}</div>
            
            <img src="${e.img}" alt="${e.name}" class="char-img" style="width:80px; height:80px;">
            
            <div class="hp-bar-bg" style="height:8px; margin:5px 10px;"><div class="hp-bar-fill" style="width:${hpPct}%"></div></div>
            
            <div style="background:#444; height:6px; margin:2px 10px; border-radius:3px; overflow:hidden;">
                <div style="background:#f1c40f; height:100%; width:${agPct}%"></div>
            </div>

            <div style="font-size:0.8em;">HP: ${e.hp} <span class="block-icon">ğŸ›¡ï¸${e.block}</span></div>

            <div class="stats" style="font-size:0.7em;">ê³µ${getStat(e,'atk')} ë°©${getStat(e,'def')} <span style="color:#f1c40f; font-weight:bold;">âš¡${getStat(e,'spd')}</span></div>

            <div class="status-effects" style="font-size:0.7em; min-height:15px; color:#f39c12; margin-top:2px;">${buffText}</div>
        `;
    });

    // 3. í„´ ìˆœì„œ ì˜ˆì¸¡ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    if (typeof updateTurnOrderList === "function") {
        updateTurnOrderList();
    }
}

/* [ìˆ˜ì •] renderHand: í„°ì¹˜ ì´ë²¤íŠ¸ ì§€ì› ì¶”ê°€ */
function renderHand() {
    const container = document.getElementById('hand-container'); 
    container.innerHTML = "";
    
    if (player.hand.length >= 8) container.classList.add('compact');
    else container.classList.remove('compact');

    player.hand.forEach((cName, idx) => {
        let data = CARD_DATA[cName];
        let el = document.createElement('div'); 
        el.className = 'card';
        el.id = `card-el-${idx}`;
        el.style.pointerEvents = "auto";
     
        if (player.ap < data.cost || game.turnOwner !== "player") el.className += " disabled";
        
        el.innerHTML = `
            <div class="card-cost">${data.cost}</div>
            <div class="card-rank">${"â˜…".repeat(data.rank)}</div>
            <div class="card-name">${cName}</div>
            <div class="card-desc">${applyTooltip(data.desc)}</div>
        `;
        
        if (game.turnOwner === "player" && player.ap >= data.cost) {
            // [í•µì‹¬ ë³€ê²½] ë§ˆìš°ìŠ¤ì™€ í„°ì¹˜ ë‘˜ ë‹¤ ì—°ê²°
            el.onmousedown = (e) => startDrag(e, idx, cName);
            el.ontouchstart = (e) => startDrag(e, idx, cName);
        } else {
            el.onclick = () => log("ğŸš« í–‰ë™ë ¥ì´ ë¶€ì¡±í•˜ê±°ë‚˜ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        
        container.appendChild(el);
    });
}

// [ìˆ˜ì •ë¨] openPileView: ëª©ë¡ ì°½ì—ì„œë„ ì¼ë°˜ ì¹´ë“œì²˜ëŸ¼ ë³´ì´ê²Œ ìˆ˜ì •
function openPileView(type) {
    const title = document.getElementById('popup-title'); const content = document.getElementById('popup-content'); const btns = document.getElementById('popup-buttons');
    content.innerHTML = ""; btns.innerHTML = "<button class='action-btn' onclick='closePopup()'>ë‹«ê¸°</button>";
    
    let sourceArray;
    if (type === 'draw') sourceArray = [...player.drawPile].sort();
    else if (type === 'discard') sourceArray = player.discardPile;
    else if (type === 'exhaust') sourceArray = player.exhaustPile;

    let typeText = (type==='draw')?'ë‚¨ì€ ë±':(type==='discard')?'ë²„ë¦° ì¹´ë“œ':'ì†Œë©¸ëœ ì¹´ë“œ';
    title.innerText = `${typeText} (${sourceArray.length}ì¥)`;
    document.getElementById('popup-desc').innerText = "ì¹´ë“œ ëª©ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤.";
    if (sourceArray.length === 0) content.innerHTML = "<div style='padding:20px; color:#777;'>ë¹„ì–´ìˆìŒ</div>";
    else {
        let listDiv = document.createElement('div'); listDiv.className = 'pile-list';
        sourceArray.forEach(cName => {
            let data = CARD_DATA[cName]; let el = document.createElement('div'); el.className = 'mini-card';
            
            // [ìˆ˜ì •] ë¯¸ë‹ˆ ì¹´ë“œì—ë„ ë³„ ì¶”ê°€
            el.innerHTML = `
                <div>${data.cost} <span style="color:#f1c40f">${"â˜…".repeat(data.rank)}</span></div>
                <b>${cName}</b>
                <div>${applyTooltip(data.desc)}</div>
            `; 
            listDiv.appendChild(el);
        }); content.appendChild(listDiv);
    }
    document.getElementById('popup-layer').style.display = 'flex';
}

function showPopup(title, desc, buttons, contentHTML = "") {
    const layer = document.getElementById('popup-layer'); document.getElementById('popup-title').innerText = title; document.getElementById('popup-desc').innerHTML = desc; document.getElementById('popup-content').innerHTML = contentHTML;
    const btnBox = document.getElementById('popup-buttons'); btnBox.innerHTML = "";
    buttons.forEach(b => { let btn = document.createElement('button'); btn.className = 'action-btn'; btn.style.fontSize = "1em"; btn.style.padding = "5px 15px"; btn.innerText = b.txt; btn.onclick = b.func; btnBox.appendChild(btn); });
    layer.style.display = "flex";
}
function showLevelUp() {
    // game.level++;  <-- [ì‚­ì œ] ì´ ì¤„ì„ ì°¾ì•„ì„œ ì§€ìš°ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”!
    
    showPopup("ğŸ†™ ë ˆë²¨ ì—…!", "ì˜¬ë¦´ ìŠ¤íƒ¯ì„ ì„ íƒí•˜ì„¸ìš”.", [
        {txt: "ê³µê²©ë ¥ +1", func: ()=> { player.baseAtk++; getCardReward(); }},
        {txt: "ë°©ì–´ë ¥ +1", func: ()=> { player.baseDef++; getCardReward(); }},
        {txt: "ì†ë„ +1", func: ()=> { player.baseSpd++; getCardReward(); }}
    ]);
}
function getCardReward() {
    let newCard = getRandomCard(); 
    let data = CARD_DATA[newCard];
    
    // [ìˆ˜ì •] ë³´ìƒ ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸°ì—ë„ ë³„ ì¶”ê°€
    let cardHTML = `
    <div style="display:flex; justify-content:center; margin:10px;">
        <div class="card">
            <div class="card-cost">${data.cost}</div>
            <div class="card-rank">${"â˜…".repeat(data.rank)}</div>
            <div class="card-name">${newCard}</div>
            <div class="card-desc">${applyTooltip(data.desc)}</div>
        </div>
    </div>`;
    
    showPopup("ğŸ ì¹´ë“œ ë³´ìƒ", "íšë“í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [{txt: "ë°›ê¸°", func: ()=>{player.deck.push(newCard); runRandomEvent();}}, {txt: "ê±´ë„ˆë›°ê¸°", func: runRandomEvent}], cardHTML);
}
function closePopup() { document.getElementById('popup-layer').style.display = "none"; }

initGame();

/* [ì¶”ê°€] script íƒœê·¸ ë§¨ ì•„ë˜ìª½ì´ë‚˜ ì ì ˆí•œ ê³³ì— ì¶”ê°€í•˜ì„¸ìš” */

// ë ˆë²¨ì—… ì²˜ë¦¬ ë¡œì§
function processLevelUp() {
    player.xp -= player.maxXp; // ê²½í—˜ì¹˜ ì°¨ê° (ì˜¤ë²„í”Œë¡œìš° ëœ ê²½í—˜ì¹˜ëŠ” ìœ ì§€ë¨)
    game.level++;
    
    // [NEW] ë‹¤ìŒ ë ˆë²¨ í•„ìš” ê²½í—˜ì¹˜ ê³µì‹ (ë ˆë²¨ * 100)
    // ì˜ˆ: 1->2 (100xp), 2->3 (200xp), 3->4 (300xp) ...
    player.maxXp = game.level * 100;
    
    // ê¸°ì¡´ ìŠ¤íƒ¯ ì„ íƒ íŒì—… í˜¸ì¶œ
    showLevelUp(); 
}

// ìŠ¹ë¦¬ í›„ (ë ˆë²¨ì—… ì—†ì„ ë•Œ) ì´ë™ ë¡œì§
function nextStepAfterWin() {
    // ë ˆë²¨ì—…ì„ ì•ˆ í–ˆìœ¼ë©´ ë°”ë¡œ ëœë¤ ì´ë²¤íŠ¸ë¡œ ì´ë™
    runRandomEvent();
}
/* [ì¶”ê°€] ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ í•¨ìˆ˜ */
function playAnim(elementId, animClass) {
    const el = document.getElementById(elementId);
    
    // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±° (ì—°ì† ì¬ìƒì„ ìœ„í•´)
    el.classList.remove('anim-atk-p', 'anim-atk-e', 'anim-hit', 'anim-bounce');
    
    // ê°•ì œ ë¦¬í”Œë¡œìš° (ë¸Œë¼ìš°ì €ê°€ ë³€ê²½ì‚¬í•­ì„ ì¦‰ì‹œ ì¸ì‹í•˜ê²Œ í•¨)
    void el.offsetWidth;
    
    // ìƒˆ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì¶”ê°€
    el.classList.add(animClass);
    
    // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚˜ë©´ í´ë˜ìŠ¤ ì œê±° (ê¹”ë”í•˜ê²Œ)
    setTimeout(() => {
        el.classList.remove(animClass);
    }, 600); // ê°€ì¥ ê¸´ ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„(0.6s)ì— ë§ì¶¤
}
/* --- [ì¶”ê°€] ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œìŠ¤í…œ --- */

function saveGame() {
    // 1. ì €ì¥í•  ë°ì´í„° ë¬¶ê¸°
    const saveData = {
        playerData: player,       // í”Œë ˆì´ì–´ì˜ ëª¨ë“  ì •ë³´ (ë±, ì²´ë ¥, ì•„ì´í…œ ë“±)
        gameLevel: game.level     // í˜„ì¬ ë ˆë²¨
    };

    // 2. ë¸Œë¼ìš°ì € ì €ì¥ì†Œ(Local Storage)ì— 'myRPG_save'ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì €ì¥
    // ê°ì²´(Object)ëŠ” ì €ì¥ ëª» í•˜ë¯€ë¡œ JSON.stringifyë¡œ ë¬¸ìì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
    localStorage.setItem('myRPG_save', JSON.stringify(saveData));

    // 3. ì•Œë¦¼
    alert("ê²Œì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ ìœ ì§€ë©ë‹ˆë‹¤)");
}

function loadGame() {
    // 1. ì €ì¥ì†Œì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const saveString = localStorage.getItem('myRPG_save');

    // 2. ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
    if (!saveString) {
        alert("ì €ì¥ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // 3. ë°ì´í„° ë³µêµ¬
    try {
        const loadedData = JSON.parse(saveString); // ë¬¸ìì—´ì„ ë‹¤ì‹œ ê°ì²´ë¡œ ë³€í™˜

        // ë°ì´í„° ë®ì–´ì“°ê¸°
        player = loadedData.playerData;
        game.level = loadedData.gameLevel;

        // [ì¤‘ìš”] ë¶ˆëŸ¬ì˜¨ ë’¤, í˜„ì¬ ë ˆë²¨ì˜ ì „íˆ¬ë¥¼ 'ì²˜ìŒë¶€í„°' ë‹¤ì‹œ ì‹œì‘
        // (ì „íˆ¬ ì¤‘ê°„ ìƒíƒœê¹Œì§€ ì™„ë²½í•˜ê²Œ ì €ì¥í•˜ëŠ” ê±´ ë§¤ìš° ë³µì¡í•˜ë¯€ë¡œ, ì²´í¬í¬ì¸íŠ¸ ë°©ì‹ ì‚¬ìš©)
        alert(`Lv.${game.level} ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
        
        // UI ê°±ì‹  ë° ì „íˆ¬ ì¬ì‹œì‘
        updateUI();
        startBattle(); 

    } catch (e) {
        console.error(e);
        alert("ì„¸ì´ë¸Œ íŒŒì¼ì´ ì†ìƒë˜ì–´ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
}
/* [NEW] ìŠ¹ë¦¬ íŒì—…ì„ ìƒí™©ì— ë§ì¶° ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜ */
function renderWinPopup() {
    let btns = [];
    let contentHTML = "";

    // 1. [ì•„ì´í…œ ì¤ê¸° ë²„íŠ¼] - ì•„ì§ ì¤ì§€ ì•Šì€ ì•„ì´í…œì´ ìˆë‹¤ë©´
    if (game.pendingLoot) {
        let loot = game.pendingLoot;
        let lData = ITEM_DATA[loot];
        
        // ì•„ì´í…œ ì •ë³´ í‘œì‹œ
        contentHTML = `
            <div style="display:flex; justify-content:center; margin-top:15px;">
                <div class="item-icon item-${lData.type} item-rank-${lData.rank}">
                    ${lData.icon}
                    <span class="tooltip"><b>${loot}</b><br>${lData.desc}</span>
                </div>
            </div>
            <div style="margin-top:5px; font-size:0.9em; color:#aaa;">${loot}</div>
        `;
        
        // [ì¤‘ìš”] ì•„ì´í…œ ì¤ê¸° ë²„íŠ¼: ì¤ê³  ë‚˜ì„œ 'renderWinPopup'ì„ ë‹¤ì‹œ í˜¸ì¶œí•¨ (íŒì—… ìœ ì§€)
        btns.push({ 
            txt: "ì•„ì´í…œ ì¤ê¸°", 
            func: () => getLoot() 
        });
    }

    // 2. [ë ˆë²¨ì—… ë²„íŠ¼] - ê²½í—˜ì¹˜ê°€ ê½‰ ì°¼ë‹¤ë©´
    if (player.xp >= player.maxXp) {
        btns.push({ 
            txt: "ğŸ†™ ë ˆë²¨ì—…!", 
            func: processLevelUp 
        });
    }

    // 3. [ë– ë‚˜ê¸° ë²„íŠ¼] - ì–¸ì œë‚˜ ì¡´ì¬ (ì„ íƒì§€ ì œê³µ)
    // ë ˆë²¨ì—…ì´ ê°€ëŠ¥í•´ë„, ì§€ê¸ˆ ì•ˆ í•˜ê³  ë‚˜ì¤‘ì— í•˜ê±°ë‚˜ ê·¸ëƒ¥ ë– ë‚  ìˆ˜ë„ ìˆê²Œ í•¨
    btns.push({ 
        txt: "ë– ë‚˜ê¸°", 
        func: nextStepAfterWin 
    });

    // íŒì—… í‘œì‹œ
    // (ë ˆë²¨ì—… ê°€ëŠ¥í•˜ë©´ ë©”ì‹œì§€ì— ê°•ì¡° í‘œì‹œ)
    let finalMsg = game.winMsg;
    if (player.xp >= player.maxXp) finalMsg += `<br><b style="color:#f1c40f">ğŸ†™ ë ˆë²¨ ì—… ê°€ëŠ¥!</b>`;

    showPopup("ì „íˆ¬ ìŠ¹ë¦¬!", finalMsg, btns, contentHTML);
}

/* [NEW] ì•„ì´í…œ íšë“ ì²˜ë¦¬ í•¨ìˆ˜ */
function getLoot() {
    if (game.pendingLoot) {
        addItem(game.pendingLoot); // ì¸ë²¤í† ë¦¬ì— ì¶”ê°€
        
        // ë©”ì‹œì§€ ê°±ì‹ 
        game.winMsg = game.winMsg.replace("ì „ë¦¬í’ˆì´ ë°”ë‹¥ì— ë–¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.", "");
        game.winMsg += `<br><span style="color:#2ecc71">âœ” [${game.pendingLoot}] íšë“í•¨.</span>`;
        
        game.pendingLoot = null; // ë°”ë‹¥ì—ì„œ ì¹˜ì›€
        
        updateUI(); // ì¸ë²¤í† ë¦¬ ê°±ì‹ 
        renderWinPopup(); // [í•µì‹¬] íŒì—… ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì´ì œ ì¤ê¸° ë²„íŠ¼ì€ ì‚¬ë¼ì§)
    }
}
/* --- [NEW] ë“œë˜ê·¸ íƒ€ê²ŸíŒ… & ë¯¸ë¦¬ë³´ê¸° ì‹œìŠ¤í…œ --- */

let drag = { active: false, cardIdx: -1, cardName: "", startX: 0, startY: 0, originalDesc: "" };

/* [ìˆ˜ì •] ë“œë˜ê·¸ ì‹œì‘ í•¨ìˆ˜ (í…ìŠ¤íŠ¸ ì¦‰ì‹œ ë³€í™˜ ì œê±°) */
function startDrag(e, idx, name, type = 'card') {
  // ë§ˆìš°ìŠ¤ ìš°í´ë¦­ ë°©ì§€ (í„°ì¹˜ëŠ” button ì†ì„±ì´ ì—†ìŒ)
    if (e.type === 'mousedown' && e.button !== 0) return; 
    if (e.target.tagName === 'BUTTON') return;

    drag.active = true;
    drag.type = type; 
    drag.idx = idx;   
    drag.name = name; 
    
    let elId = (type === 'card') ? `card-el-${idx}` : `item-el-${idx}`;
    let dragEl = document.getElementById(elId);
    
    dragEl.style.pointerEvents = "none"; 
    
    let rect = dragEl.getBoundingClientRect();
    drag.startX = rect.left + rect.width / 2;
    drag.startY = rect.top + rect.height / 2;
    
    // --- [í•µì‹¬] í´ë¦­ ìˆœê°„ì—ëŠ” ë¬´ì¡°ê±´ ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ ì´ˆê¸°í™” ---
    if (type === 'card') {
        // ë°ì´í„°ì—ì„œ ì›ë³¸ ì„¤ëª…ì„ ê°€ì ¸ì˜´
        drag.originalDesc = applyTooltip(CARD_DATA[name].desc);
        
        // â˜… í™”ë©´ì˜ í…ìŠ¤íŠ¸ë¥¼ ê°•ì œë¡œ ì›ë³¸ìœ¼ë¡œ ë˜ëŒë¦¼ â˜…
        // ì´ë ‡ê²Œ í•˜ë©´ í´ë¦­í•˜ëŠ” ìˆœê°„ì€ ë¬´ì¡°ê±´ 'í•˜ì–€ìƒ‰' ê¸€ì”¨ê°€ ë©ë‹ˆë‹¤.
        dragEl.querySelector('.card-desc').innerHTML = drag.originalDesc;
        
    } else {
        drag.originalDesc = ""; 
    }
    // ---------------------------------------

    document.getElementById('drag-layer').style.display = 'block';
 // [í•µì‹¬ ë³€ê²½] ë§ˆìš°ìŠ¤ì™€ í„°ì¹˜ ì´ë™/ì¢…ë£Œ ì´ë²¤íŠ¸ ëª¨ë‘ ì—°ê²°
    // { passive: false } ì˜µì…˜ì€ ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ë°©ì§€ë¥¼ ìœ„í•´ ì¤‘ìš”í•¨
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', onDragEnd);
    
    document.addEventListener('touchmove', onDragMove, { passive: false });
    document.addEventListener('touchend', onDragEnd);
}

/* [ìˆ˜ì •] ë“œë˜ê·¸ ì´ë™ í•¨ìˆ˜ (í•¸ë“œ ì˜ì—­ ë²—ì–´ë‚˜ë©´ ìˆ˜ì¹˜ ë³€í™˜) */
function onDragMove(e) {
    if (!drag.active) return;
    if(e.cancelable) e.preventDefault(); // ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ë°©ì§€

    // ì¢Œí‘œ ì¶”ì¶œ
    const pos = getClientPos(e);
    let endX = pos.x; 
    let endY = pos.y;

    // í™”ì‚´í‘œ ê·¸ë¦¬ê¸°
    const path = document.getElementById('drag-path');
    const head = document.getElementById('drag-head');
    let cpX = (drag.startX + endX) / 2; let cpY = Math.min(drag.startY, endY) - 100;
    path.setAttribute("d", `M${drag.startX},${drag.startY} Q${cpX},${cpY} ${endX},${endY}`);
    head.setAttribute("cx", endX); head.setAttribute("cy", endY);

    // â˜… [ë³µêµ¬ëœ ì½”ë“œ] íƒ€ê²Ÿ íŒì • ë³€ìˆ˜ ì„ ì–¸
    let targetInfo = getTargetUnderMouse(e);
    
    // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    let data;
    if (drag.type === 'card') data = CARD_DATA[drag.name];
    else data = ITEM_DATA[drag.name];

    let dragEl = document.getElementById((drag.type==='card')?`card-el-${drag.idx}`:`item-el-${drag.idx}`);
    
    // ê¸°ì¡´ í•˜ì´ë¼ì´íŠ¸ ì´ˆê¸°í™”
    document.querySelectorAll('.enemy-unit').forEach(el => el.classList.remove('selected-target'));
    document.getElementById('player-char').classList.remove('selected-target');

    let validTarget = false;
    let aliveEnemies = enemies.filter(en => en.hp > 0);

    // íƒ€ê²Ÿ í•˜ì´ë¼ì´íŠ¸ ë¡œì§
    if (targetInfo) {
        // A. ê´‘ì—­ê¸°
        if (data.targetType === 'all' || data.target === 'all') {
            enemies.forEach(en => { if (en.hp > 0) document.getElementById(`enemy-unit-${en.id}`).classList.add('selected-target'); });
            validTarget = true;
        }
        // B. ì  íƒ€ê²Ÿ
        else if ((data.type && data.type.includes("attack")) || data.target === "enemy") {
            // íŠ¹ì • ì  ì§€ì •
            if (targetInfo.type === 'specific' && targetInfo.unit !== player) {
                document.getElementById(`enemy-unit-${targetInfo.unit.id}`).classList.add('selected-target');
                validTarget = true;
            }
            // [ìë™ íƒ€ê²Ÿ] ì ì´ í•˜ë‚˜ë¿ì´ê³  + ë§ˆìš°ìŠ¤ê°€ 'ì „íˆ¬ êµ¬ì—­(General)'ì— ë“¤ì–´ì™”ì„ ë•Œ
            else if (targetInfo.type === 'general' && aliveEnemies.length === 1) {
                document.getElementById(`enemy-unit-${aliveEnemies[0].id}`).classList.add('selected-target');
                validTarget = true;
            }
        }
        // C. ì•„êµ° íƒ€ê²Ÿ
        else if (data.target === "self" || (!data.type?.includes("attack") && data.target !== "enemy")) {
            if ((targetInfo.type === 'specific' && targetInfo.unit === player) || targetInfo.type === 'general') {
                document.getElementById('player-char').classList.add('selected-target');
                validTarget = true;
            }
        }
    }

    // --- í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë¡œì§ ---
    if (drag.type === 'card') {
        let descEl = dragEl.querySelector('.card-desc');
        
        // 1. ìœ íš¨í•œ íƒ€ê²ŸíŒ… ìƒíƒœì¼ ë•Œë§Œ ìˆ˜ì¹˜ ë³€í™˜
        if (validTarget) {
            let newText = calcPreview(drag.name, player);
            if (descEl.innerHTML !== newText) descEl.innerHTML = newText;
        } 
        // 2. ì•„ë‹ˆë©´ ì›ë³¸ ë³µêµ¬
        else {
            if (descEl.innerHTML !== drag.originalDesc) descEl.innerHTML = drag.originalDesc;
        }
    }

    // ì¹´ë“œ í™•ëŒ€ íš¨ê³¼
    if (validTarget) {
        dragEl.style.transform = "scale(1.1)"; 
        dragEl.style.zIndex = "1000";
    } else {
        dragEl.style.transform = "scale(1.0)"; 
        dragEl.style.zIndex = "auto";
    }
}

/* [ìˆ˜ì •] ë“œë˜ê·¸ ì¢…ë£Œ (í…ìŠ¤íŠ¸ ë³µêµ¬ í¬í•¨) */
function onDragEnd(e) {
    if (!drag.active) return;
    
   // [í•µì‹¬] ë¦¬ìŠ¤ë„ˆ ëª¨ë‘ ì œê±°
    document.removeEventListener('mousemove', onDragMove);
    document.removeEventListener('mouseup', onDragEnd);
    document.removeEventListener('touchmove', onDragMove);
    document.removeEventListener('touchend', onDragEnd);

    document.getElementById('drag-layer').style.display = 'none';
    
    // UI ë³µêµ¬
    let elId = (drag.type === 'card') ? `card-el-${drag.idx}` : `item-el-${drag.idx}`;
    let dragEl = document.getElementById(elId);
    
    if (dragEl) {
        dragEl.style.pointerEvents = "auto"; 
        dragEl.style.transform = "scale(1.0)";
        dragEl.style.zIndex = "auto";
        
        // --- [í•µì‹¬ ë³€ê²½] ì¹´ë“œë¥¼ ì•ˆ ì“°ê³  ë†“ì•˜ì„ ë•Œ ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ ë³µêµ¬ ---
        if (drag.type === 'card') {
             dragEl.querySelector('.card-desc').innerHTML = drag.originalDesc;
        }
    }
    
    document.querySelectorAll('.enemy-unit').forEach(el => el.classList.remove('selected-target'));
    document.getElementById('player-char').classList.remove('selected-target');

    // (ì´í•˜ íƒ€ê²ŸíŒ… ë° ë°œë™ ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤.)
    // ... ê¸°ì¡´ ë¡œì§ ...
    let targetInfo = getTargetUnderMouse(e);
    let data;
    if (drag.type === 'card') data = CARD_DATA[drag.name];
    else data = ITEM_DATA[drag.name];

    let finalTargets = [];
    let aliveEnemies = enemies.filter(en => en.hp > 0);

    if (targetInfo) {
        if (data.targetType === 'all' || data.target === 'all') {
            finalTargets = aliveEnemies;
        }
        else if ((data.type && data.type.includes("attack")) || data.target === "enemy") {
            if (targetInfo.type === 'specific' && targetInfo.unit !== player) {
                finalTargets = [targetInfo.unit];
            }
            else if (aliveEnemies.length === 1 && targetInfo.type === 'general') {
                finalTargets = [aliveEnemies[0]];
            }
        }
        else if (data.target === "self" || (!data.type?.includes("attack") && data.target !== "enemy")) {
            if (targetInfo.type === 'specific' && targetInfo.unit === player) {
                finalTargets = [player];
            }
            else if (targetInfo.type === 'general') {
                 finalTargets = [player];
            }
        }
    }

    if (finalTargets.length > 0) {
        if (drag.type === 'card') {
            player.ap -= data.cost;
            let usedCard = player.hand.splice(drag.idx, 1)[0];
            if (data.isExhaust) player.exhaustPile.push(usedCard);
            else player.discardPile.push(usedCard);
            finalTargets.forEach(target => useCard(player, target, drag.name));
            renderHand();
        } else {
            useConsumable(drag.idx, finalTargets[0]); 
        }
        updateUI();
        checkGameOver();
    }

    drag.active = false;
    drag.idx = -1;
}

/* [ìˆ˜ì •] ë§ˆìš°ìŠ¤ ì•„ë˜ íƒ€ê²Ÿ íŒì • (ì¢Œí‘œ ê¸°ë°˜ í•¸ë“œ ì˜ì—­ ê°ì§€) */
/* [ìˆ˜ì •] getTargetUnderMouse: ëª¨ë°”ì¼ ì¢Œí‘œ ì§€ì› */
function getTargetUnderMouse(e) {
    // 1. í•¸ë“œ ì˜ì—­ ê°ì§€ (ì¢Œí‘œ ê³„ì‚°)
    const handArea = document.getElementById('hand-container');
    const handRect = handArea.getBoundingClientRect();
    
    // [í•µì‹¬] ì¢Œí‘œ ì¶”ì¶œ
    const pos = getClientPos(e); // {x: ..., y: ...}
    const x = pos.x;
    const y = pos.y;

    // ë§ˆìš°ìŠ¤/í„°ì¹˜ê°€ í•¸ë“œ ì˜ì—­ ì‚¬ê°í˜• ì•ˆì— ìˆë‹¤ë©´ -> íƒ€ê²ŸíŒ… ì¤‘ë‹¨
    if (x >= handRect.left && x <= handRect.right &&
        y >= handRect.top && y <= handRect.bottom) {
        return null; 
    }

    // 2. í•´ë‹¹ ì¢Œí‘œì˜ ìš”ì†Œ í™•ì¸
    let el = document.elementFromPoint(x, y);
    if (!el) return null;

    // 3. ìœ ë‹› í™•ì¸
    let enemyUnit = el.closest('.enemy-unit');
    if (enemyUnit) {
        let id = parseInt(enemyUnit.id.split('-')[2]); 
        let target = enemies.find(e => e.id === id);
        if (target && target.hp > 0) return { type: 'specific', unit: target };
    }

    if (el.closest('#player-char')) return { type: 'specific', unit: player };

    // 4. ì „íˆ¬ êµ¬ì—­(í—ˆê³µ) í™•ì¸
    if (el.closest('.container') && !el.closest('.top-bar')) {
        return { type: 'general' };
    }

    return null;
}

/* [ìˆ˜ì •] ì¹´ë“œ ì„¤ëª… ë‚´ ìˆ˜ì¹˜ ê³„ì‚° í•¨ìˆ˜ (ìƒ‰ìƒ ê°•ì¡° í¬í•¨) */
function calcPreview(cardName, user) {
    let data = CARD_DATA[cardName];
    // íˆ´íŒ ë“± ê¸°ë³¸ ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
    let desc = applyTooltip(data.desc); 
    
    // ê³µê²©ë ¥/ë°©ì–´ë ¥ ìŠ¤íƒ¯ ê°€ì ¸ì˜¤ê¸° (ë²„í”„/ë””ë²„í”„ê°€ ì´ë¯¸ ì ìš©ëœ ìˆ˜ì¹˜)
    let atk = getStat(user, 'atk');
    let def = getStat(user, 'def');

    // 1. ê³µê²© ì¹´ë“œ ê³„ì‚°
    if (data.dmg) {
        // ê¸°ë³¸ ê³µì‹: (ì¹´ë“œ ë°ë¯¸ì§€ + í”Œë ˆì´ì–´ ê³µê²©ë ¥)
        // â€» ì‹¤ì œ ê²Œì„ì—ì„œëŠ” (ê¸°ë³¸ë€ + í˜) * ë°°ìœ¨ ë“±ì´ì§€ë§Œ, ì—¬ê¸°ì„  ë‹¨ìˆœ í•©ì‚°ìœ¼ë¡œ êµ¬í˜„
        let finalDmg = data.dmg + atk; 
        
        // ìƒ‰ìƒ ê²°ì • (ê¸°ë³¸ê°’ë³´ë‹¤ ë†’ìœ¼ë©´ ì´ˆë¡, ë‚®ìœ¼ë©´ ë¹¨ê°•)
        let colorClass = (finalDmg > data.dmg) ? "mod-val-buff" : 
                         (finalDmg < data.dmg) ? "mod-val-debuff" : "";
        
        // í…ìŠ¤íŠ¸ êµì²´ (ì˜ˆ: "HP -5" -> "HP -<span class='...'>7</span>")
        // ì •ê·œì‹: ì„¤ëª… í…ìŠ¤íŠ¸ ë‚´ì˜ 'ê¸°ë³¸ ë°ë¯¸ì§€ ìˆ«ì'ë¥¼ ì°¾ì•„ì„œ 'ê³„ì‚°ëœ ìˆ«ì'ë¡œ êµì²´
        let regex = new RegExp(data.dmg, "g");
        desc = desc.replace(regex, `<span class="${colorClass}">${finalDmg}</span>`);
    }

    // 2. ë°©ì–´ ì¹´ë“œ ê³„ì‚°
    if (data.block) {
        // ê¸°ë³¸ ê³µì‹: (ì¹´ë“œ ë°©ì–´ë„ + í”Œë ˆì´ì–´ ë°©ì–´ë ¥)
        let finalBlock = data.block + def;
        
        let colorClass = (finalBlock > data.block) ? "mod-val-buff" : 
                         (finalBlock < data.block) ? "mod-val-debuff" : "";
                         
        let regex = new RegExp(data.block, "g");
        desc = desc.replace(regex, `<span class="${colorClass}">${finalBlock}</span>`);
    }

    return desc;
}

/* [NEW] ë¯¸ë˜ì˜ í„´ ìˆœì„œë¥¼ ì˜ˆì¸¡í•´ì„œ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜ */
function updateTurnOrderList() {
    // 1. ì‹œë®¬ë ˆì´ì…˜ìš© ë°ì´í„° ë³µì‚¬ (ì›ë³¸ í›¼ì† ë°©ì§€)
    let simPlayer = { id: 'player', ag: player.ag, spd: getStat(player, 'spd'), name: "ë‚˜" };
    // ì‚´ì•„ìˆëŠ” ì ë§Œ í¬í•¨
    let simEnemies = enemies.filter(e=>e.hp>0).map(e => ({
        id: `enemy-${e.id}`, ag: e.ag, spd: getStat(e, 'spd'), name: e.name
    }));
    
    let allUnits = [simPlayer, ...simEnemies];
    let predictedOrder = [];
    const MAX_PREDICT = 6; // ì•ìœ¼ë¡œ 6í„´ë§Œ ì˜ˆì¸¡

    // 2. ì‹œë®¬ë ˆì´ì…˜ ë£¨í”„ (ì‹¤ì œ ê²Œì„ ìƒíƒœëŠ” ë³€ê²½ ì•ˆ í•¨)
    let safety = 0;
    while (predictedOrder.length < MAX_PREDICT && safety < 1000) {
        safety++;
        
        // í„´ ì¡ì„ ì‚¬ëŒ í™•ì¸ (AG 1000 ì´ìƒ)
        let readyUnits = allUnits.filter(u => u.ag >= game.AG_MAX);
        
        if (readyUnits.length > 0) {
            // AG ë†’ì€ ìˆœ ì •ë ¬
            readyUnits.sort((a, b) => b.ag - a.ag);
            
            // ì˜ˆì¸¡ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ê³  AG ì°¨ê° (ì‹œë®¬ë ˆì´ì…˜ ìƒì—ì„œë§Œ)
            for (let unit of readyUnits) {
                predictedOrder.push(unit.name);
                unit.ag -= game.AG_MAX;
                if (predictedOrder.length >= MAX_PREDICT) break;
            }
        } else {
            // ì•„ë¬´ë„ ì—†ìœ¼ë©´ ì‹œê°„ íë¥´ê²Œ í•¨
            allUnits.forEach(u => u.ag += u.spd);
        }
    }

    // 3. UIì— í‘œì‹œ (ìƒë‹¨ ì •ë³´ì°½ í™œìš©)
    let orderStr = predictedOrder.join(" â†’ ");
    let turnMsg = (game.turnOwner === 'player') ? `ë‚˜ì˜ í„´ (AP: ${player.ap})` : 
                  (game.turnOwner === 'enemy') ? `ì ì˜ í„´` : "ëŒ€ê¸° ì¤‘...";

    document.getElementById('turn-info').innerHTML = 
        `<div style="font-size:0.8em; color:#f1c40f; margin-bottom:3px;">ğŸ”œ ${orderStr}</div>
         <div>${turnMsg}</div>`;
}

</script>
<svg id="drag-layer" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; display:none;">
    <path id="drag-path" d="" stroke="#f1c40f" stroke-width="4" fill="none" stroke-dasharray="10,5" stroke-linecap="round" />
    <circle id="drag-head" cx="0" cy="0" r="8" fill="#e74c3c" stroke="#fff" stroke-width="2" />
</svg>
</body>
</html>