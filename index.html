<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Slay the Spire-like RPG (Exhaust Update)</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: #222; color: #eee; text-align: center; user-select: none; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; position: relative; min-height: 100vh; display: flex; flex-direction: column; }
        
       /* [ìˆ˜ì •] ìƒë‹¨ ë°”: ì•„ì£¼ ì–‡ê²Œ, ë²„íŠ¼ í†µí•© */
        .top-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;       /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
            margin-bottom: 5px;        /* ê°„ê²© ìµœì†Œí™” */
            background: #333; 
            padding: 5px 15px;         /* íŒ¨ë”© ì¤„ì„ */
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); 
            z-index: 10; 
            height: 40px;              /* ë†’ì´ ê³ ì • (ì‘ê²Œ) */
        }

        /* [ì¶”ê°€] ìƒë‹¨ ìš°ì¸¡ ë²„íŠ¼ ê·¸ë£¹ */
        .top-right-group {
            display: flex;
            gap: 5px;
        }        
        /* ì¸ë²¤í† ë¦¬ ì˜ì—­ */
        .inventory-area { background: #2c3e50; padding: 10px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; min-height: 50px; border: 1px solid #444; }
        .inv-label { font-size: 0.8em; color: #aaa; margin-right: 5px; }
        .item-list { display: flex; gap: 5px; flex-wrap: wrap; }
        .item-icon { 
            width: 40px; height: 40px; border-radius: 4px; display: flex; justify-content: center; align-items: center; 
            font-size: 1.2em; cursor: pointer; position: relative; border: 2px solid #555; transition: 0.2s;
        }
        .item-icon:hover { transform: scale(1.1); z-index: 5; }
        .item-relic { background: #e67e22; border-color: #d35400; color: #fff; }
        .item-consumable { background: #27ae60; border-color: #2ecc71; color: #fff; }
        .item-rank-2 { box-shadow: 0 0 5px #3498db; }
        .item-rank-3 { box-shadow: 0 0 8px #f1c40f; border-color: #f1c40f; }

        /* íˆ´íŒ */
        .tooltip { 
            visibility: hidden; 
            width: 160px; /* í­ì„ ì‚´ì§ ë„“í˜ */
            background-color: #111; 
            color: #fff; 
            text-align: center; 
            border-radius: 6px; 
            padding: 10px; /* ì—¬ë°±ì„ ì¢€ ë” ì¤Œ */
            
            position: absolute; 
            top: 120%; 
            left: 50%; 
            margin-left: -80px; /* widthì˜ ì ˆë°˜ */
            z-index: 1000; 
            
            /* [í•µì‹¬ ìˆ˜ì •] em ëŒ€ì‹  pxë¥¼ ì‚¬ìš©í•˜ì—¬ í¬ê¸°ë¥¼ ê³ ì •í•¨ */
            font-size: 13px; 
            font-weight: normal; /* ë¶€ëª¨ê°€ êµµê²Œ ì²˜ë¦¬ë˜ì–´ ìˆì–´ë„ íˆ´íŒì€ ì–‡ê²Œ */
            line-height: 1.4;    /* ì¤„ ê°„ê²© í™•ë³´ */
            
            border: 1px solid #777; 
            opacity: 0; 
            transition: opacity 0.3s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.5); 
        }
        .item-icon:hover .tooltip { visibility: visible; opacity: 1; }

        /* ì¥ë©´(Scene) ê´€ë¦¬ */
        .scene { width: 100%; flex: 1; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* ì „íˆ¬ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .battle-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; min-height: 200px; }
/* [ìˆ˜ì •] ê¸°ì¡´ .character ìŠ¤íƒ€ì¼ì„ ì´ê±¸ë¡œ ë®ì–´ì”Œìš°ì„¸ìš” (ë°°ê²½ìƒ‰ ì œê±°, í…Œë‘ë¦¬ ì •ë¦¬) */
        .character { 
            width: 40%; 
            padding: 10px; 
            border-radius: 10px; 
            position: relative; 
            transition: 0.2s; 
            text-align: center;
            /* ë°°ê²½ìƒ‰ ì œê±° (ì´ë¯¸ì§€ ê°•ì¡°) */
        }
        /* í„´ í™œì„±í™” ì‹œ í…Œë‘ë¦¬ë§Œ ê°•ì¡° */
        .character.turn-active { 
            border: 2px solid #f1c40f; 
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); 
            background: rgba(255, 255, 255, 0.05); /* ì•„ì£¼ ì˜…ì€ ë°°ê²½ */
        }

        /* [ì¶”ê°€] ìºë¦­í„° ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .char-img {
            width: 120px;
            height: 120px;
            object-fit: cover; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ì›€ */
            border-radius: 10px;
            border: 2px solid #555;
            background: #000;
            margin-bottom: 5px;
        }
        

        /* [ì¶”ê°€] ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ ì •ì˜ */

        /* 1. ê³µê²© (ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì³¤ë‹¤ê°€ ë³µê·€ - í”Œë ˆì´ì–´ìš©) */
        @keyframes atk-p {
            0% { transform: translateX(0); }
            30% { transform: translateX(50px) scale(1.1); } /* ì•ìœ¼ë¡œ íŒ! */
            100% { transform: translateX(0); }
        }
        /* 1-2. ê³µê²© (ì™¼ìª½ìœ¼ë¡œ ì³¤ë‹¤ê°€ ë³µê·€ - ì ìš©) */
        @keyframes atk-e {
            0% { transform: translateX(0); }
            30% { transform: translateX(-50px) scale(1.1); }
            100% { transform: translateX(0); }
        }

        /* 2. í”¼ê²© (ë’¤ë¡œ ë°€ë ¸ë‹¤ê°€ ë³µê·€ + ë¹¨ê°„ ë²ˆì©ì„) */
        @keyframes hit-anim {
            0% { transform: translateX(0); filter: brightness(1); }
            20% { transform: translateX(-10px); filter: brightness(0.5) sepia(1) hue-rotate(-50deg) saturate(5); } /* ë¹¨ê°›ê²Œ */
            40% { transform: translateX(10px); } /* ëœëœ ë–¨ë¦¼ */
            60% { transform: translateX(-5px); }
            100% { transform: translateX(0); filter: brightness(1); }
        }

        /* 3. ìŠ¤í‚¬/ë²„í”„ (ìœ„ë¡œ ë‘ ë²ˆ ì½©ì½©) */
        @keyframes bounce-double {
            0% { transform: translateY(0); }
            25% { transform: translateY(-20px); } /* ì í”„ 1 */
            50% { transform: translateY(0); }
            75% { transform: translateY(-10px); } /* ì í”„ 2 (ì‘ê²Œ) */
            100% { transform: translateY(0); }
        }
                /* [ì¶”ê°€] ëŒ€ë¯¸ì§€ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .damage-number {
            position: absolute;
            top: 10%;           /* ìºë¦­í„° ë¨¸ë¦¬ ê·¼ì²˜ */
            left: 50%;
            transform: translateX(-50%);
            color: #ff3333;     /* ê°•ë ¬í•œ ë¹¨ê°„ìƒ‰ */
            font-size: 2.5em;   /* í¬ê²Œ! */
            font-weight: 900;   /* ì•„ì£¼ êµµê²Œ! */
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000; /* ê²€ì€ í…Œë‘ë¦¬ë¡œ ê°€ë…ì„± í™•ë³´ */
            z-index: 999;
            pointer-events: none; /* ë§ˆìš°ìŠ¤ í´ë¦­ ë°©í•´ ì•ˆ í•˜ê²Œ */
            animation: float-up 0.8s ease-out forwards;
        }

        /* [ì¶”ê°€] ìˆ«ìê°€ ìœ„ë¡œ ì˜¬ë¼ê°€ë©° ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes float-up {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -20px) scale(1.2); opacity: 1; } /* íŒ íŠ€ì–´ë‚˜ì˜´ */
            100% { transform: translate(-50%, -80px) scale(1); opacity: 0; }  /* ìœ„ë¡œ ì‚¬ë¼ì§ */
        }

        /* ì• ë‹ˆë©”ì´ì…˜ ì ìš© í´ë˜ìŠ¤ (JSì—ì„œ ë¶™ì˜€ë‹¤ ë—„ ê²ƒì„) */
        .anim-atk-p { animation: atk-p 0.4s ease-out; }
        .anim-atk-e { animation: atk-e 0.4s ease-out; }
        .anim-hit { animation: hit-anim 0.4s ease-in-out; }
        .anim-bounce { animation: bounce-double 0.6s ease-in-out; }
        .hp-bar-bg { background: #222; height: 20px; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #555; }
        .hp-bar-fill { background: #e74c3c; height: 100%; width: 100%; transition: 0.5s; }
        
        /* [ìˆ˜ì •] í•¸ë“œ ì˜ì—­: ì¤„ë°”ê¿ˆ ê¸ˆì§€(nowrap) ë° ì˜¤ë²„í”Œë¡œìš° í—ˆìš© */
        .hand-area { 
            display: flex; 
            justify-content: center; 
            flex-wrap: nowrap;      /* [í•µì‹¬] ì¤„ë°”ê¿ˆ ì•ˆ í•¨ */
            align-items: flex-end;  /* ì•„ë˜ìª½ ì •ë ¬ */
            
            height: 160px;          /* ë†’ì´ ê³ ì • (ì¹´ë“œ íŒì—… ê³µê°„ í™•ë³´) */
            padding: 10px;
            margin-top: 20px;
            
            overflow: visible;      /* ì¹´ë“œê°€ ìœ„ë¡œ íŠ€ì–´ ì˜¬ë¼ë„ ì˜ë¦¬ì§€ ì•Šê²Œ */
            pointer-events: none;   /* ë¹ˆ ê³µê°„ í´ë¦­ ë°©ì§€ (ì¹´ë“œë§Œ í´ë¦­ë˜ê²Œ) */
        }

        .hand-area::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        /* [ìˆ˜ì •] ë¡œê·¸ ì˜ì—­: ê°€ìš´ë° ë°°ì¹˜ */
        .log-area { 
            height: 100%;       
            flex: 1;            /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
            overflow-y: auto; 
            background: #111; 
            border: 1px solid #444; 
            padding: 5px;       /* íŒ¨ë”© ì¤„ì„ */
            text-align: left; 
            font-size: 0.85em;  /* ê¸€ì í¬ê¸° ì‚´ì§ ì¤„ì„ */
            color: #bbb; 
            border-radius: 5px; 
            margin: 0;          /* ë§ˆì§„ ì œê±° */
        }
        /* [ìˆ˜ì •] ì»¨íŠ¸ë¡¤ ê·¸ë£¹: 3ë‹¨ ë¶„í•  (ìƒíƒœ | ë¡œê·¸ | ë²„íŠ¼) */
        .control-group {
            display: flex;          
            gap: 5px;              /* ê°„ê²© ì¢ê²Œ */
            height: 100px;         /* ì „ì²´ ë†’ì´ 120px -> 100pxë¡œ ì¶•ì†Œ */
            margin-bottom: 5px;    
            align-items: stretch;   
        }
        /* [ì¶”ê°€] ìƒíƒœ íŒ¨ë„ (ì™¼ìª½: í„´/AP ì •ë³´) */
        .status-panel {
            width: 110px;          /* ê³ ì • ë„ˆë¹„ */
            background: #2c3e50;
            border: 1px solid #34495e;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px;
            color: #fff;
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
            flex-shrink: 0;        /* í¬ê¸° ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
        }
        /* [ìˆ˜ì •] í„´ ì¢…ë£Œ ë²„íŠ¼: ì˜¤ë¥¸ìª½ ë°°ì¹˜ */
        .btn-end-turn-side {
            width: 80px;        /* ë„ˆë¹„ ì•½ê°„ ì¤„ì„ */
            font-size: 1.1em;
            font-weight: bold;
            word-break: keep-all;
            line-height: 1.2;
            padding: 0;         /* íŒ¨ë”© ì œê±° */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            background: #ecf0f1; color: #2c3e50; width: 100px; height: 140px; 
            border-radius: 8px; padding: 8px; cursor: pointer; font-size: 0.8em;
            display: flex; flex-direction: column; justify-content: space-between;
            border: 2px solid #bdc3c7; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        /* [ë³€ê²½] ê¸°ë³¸ ìƒíƒœëŠ” ê²¹ì¹˜ì§€ ì•Šê³  ê°„ê²©ì„ ë‘  */
            flex-shrink: 0;         
            margin: 0 5px;          /* ì–‘ì˜†ì— 5pxì”© ì—¬ìœ  */
            transition: all 0.2s ease-out; 
            pointer-events: auto;   
            transform-origin: bottom center;
        }
        /* [ì¶”ê°€] ê²¹ì¹˜ê¸° ëª¨ë“œ (.compact)ì¼ ë•Œì˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .hand-area.compact .card {
            margin: 0;              /* ê¸°ë³¸ ë§ˆì§„ ì œê±° */
            margin-left: -30px;     /* ì™¼ìª½ìœ¼ë¡œ ê²¹ì¹˜ê¸° */
        }

        /* ê²¹ì¹˜ê¸° ëª¨ë“œì—¬ë„ ì²« ë²ˆì§¸ ì¹´ë“œëŠ” ë°€ë¦¬ì§€ ì•ŠìŒ */
        .hand-area.compact .card:first-child {
            margin-left: 0;
        }
        /* ì²« ë²ˆì§¸ ì¹´ë“œëŠ” ì™¼ìª½ìœ¼ë¡œ ë°€ë¦¬ì§€ ì•Šê²Œ */
        .card:first-child {
            margin-left: 0;
        }
        /* [ìˆ˜ì •] ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ (Hover) */
        .card:hover { 
            transform: translateY(-5px) scale(1.1) !important; 
            z-index: 100;           
            border-color: #f1c40f; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);

            /* í˜¸ë²„ ì‹œì—ëŠ” ëª¨ë“œ ìƒê´€ì—†ì´ ì–‘ì˜† ê³µê°„ í™•ë³´ */
            margin-left: 10px !important;
            margin-right: 10px !important;
        }
        .card.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); transform: none; }
        .card-cost { background: #3498db; color: white; width: 25px; height: 25px; border-radius: 50%; text-align: center; line-height: 25px; font-weight: bold; position: absolute; top: -10px; left: -10px; }
        .card-name { font-weight: bold; margin-top: 10px; font-size: 1.1em; }
        .card-desc { font-size: 0.8em; color: #555; line-height: 1.3; }
      
        /* [ì¶”ê°€] ì¹´ë“œ ë“±ê¸‰(ë³„) ìŠ¤íƒ€ì¼ */
        .card-rank { 
            position: absolute; 
            top: 2px; 
            right: 5px; 
            color: #f1c40f; /* ê¸ˆìƒ‰ */
            font-weight: bold; 
            font-size: 1.2em; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.8); /* ì˜ ë³´ì´ê²Œ ê·¸ë¦¼ì ì¶”ê°€ */
        }
        /* [ì¶”ê°€] ëª¨ë°”ì¼ ê°€ë¡œ ëª¨ë“œ ê°•ì œ ì˜¤ë²„ë ˆì´ */
        #rotate-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            color: #fff;
            z-index: 9999;
            display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        /* í™”ë©´ ë„ˆë¹„ê°€ 768px ì´í•˜(ëª¨ë°”ì¼)ì´ê³ , ì„¸ë¡œ ëª¨ë“œ(portrait)ì¼ ë•Œë§Œ ë³´ì„ */
        @media screen and (max-width: 768px) and (orientation: portrait) {
            #rotate-overlay { display: flex; }
            .container { display: none; } /* ê²Œì„ í™”ë©´ ìˆ¨ê¹€ */
        }
        /* ì´ë²¤íŠ¸(ìƒì /íœ´ì‹) ì „ì²´ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #event-scene { justify-content: center; align-items: center; text-align: center; }
        .event-content { background: #2c3e50; padding: 40px; border-radius: 15px; width: 100%; max-width: 600px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border: 1px solid #34495e; }
        .event-title { font-size: 2em; margin-bottom: 10px; color: #f1c40f; }
        .event-desc { font-size: 1.2em; margin-bottom: 30px; color: #ecf0f1; }
        
        .shop-items { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .shop-item { cursor: pointer; transition: 0.2s; position: relative; }
        .shop-item:hover { transform: scale(1.05); }
        .shop-item.sold-out { opacity: 0.4; pointer-events: none; filter: grayscale(100%); }
        .shop-item.sold-out::after { content: "SOLD OUT"; position: absolute; top: 40%; left: 10%; color: red; font-weight: bold; font-size: 1.5em; transform: rotate(-15deg); border: 2px solid red; padding: 5px; }
        .shop-price { background: #111; color: #f1c40f; padding: 5px; border-radius: 4px; margin-top: 5px; font-weight: bold; }

        /* ë²„íŠ¼ë¥˜ */
        .action-btn { background: #e67e22; color: white; border: none; padding: 12px 30px; font-size: 1.1em; cursor: pointer; border-radius: 5px; box-shadow: 0 4px 0 #d35400; transition: 0.1s; }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        .action-btn:disabled { background: #7f8c8d; box-shadow: none; cursor: not-allowed; transform: none; }
        .small-btn { background: #555; color: #fff; border: 1px solid #777; padding: 5px 10px; font-size: 0.8em; cursor: pointer; border-radius: 4px; margin: 0 2px; }

        /* íŒì—… */
        #popup-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 200; }
        .popup-box { background: #333; padding: 30px; border-radius: 10px; width: 500px; max-height: 80%; display: flex; flex-direction: column; text-align: center; border: 1px solid #555; }
        .popup-btns { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .pile-list { flex: 1; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 10px; background: #222; border-radius: 5px; margin-top: 10px; }
        .mini-card { width: 70px; height: 100px; background: #ecf0f1; color: #333; border-radius: 4px; padding: 5px; font-size: 0.6em; display: flex; flex-direction: column; justify-content: center; text-align: center; border: 1px solid #bdc3c7; }
        .mini-card b { display: block; font-size: 1.2em; margin-bottom: 3px; }
        
        .keyword { position: relative; color: #f1c40f; font-weight: bold; cursor: help; text-decoration: underline dotted; }
        .keyword .tip-text { visibility: hidden; width: 180px; background-color: #111; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1000; bottom: 125%; left: 50%; margin-left: -90px; font-size: 0.8em; font-weight: normal; border: 1px solid #777; opacity: 0; transition: opacity 0.2s; pointer-events: none; box-shadow: 0 4px 6px rgba(0,0,0,0.5); white-space: normal; line-height: 1.4; }
        .keyword:hover .tip-text { visibility: visible; opacity: 1; }
    </style>
</head>
<body>
<div class="container">
    <div class="top-bar">
        <span id="game-info" style="font-weight:bold; font-size:1em;">Lv.1 | ğŸ’° 0ì›</span>
        
        <div class="top-right-group">
            <button class="small-btn" onclick="saveGame()">ğŸ’¾ ì €ì¥</button>
            <button class="small-btn" onclick="loadGame()">ğŸ“‚ ë¡œë“œ</button>
        </div>
    </div>

    <div class="inventory-area">
        <div class="inv-label">ğŸ‘‘ ìœ ë¬¼:</div>
        <div class="item-list" id="relic-list"></div>
        <div style="width:20px;"></div> <div class="inv-label">ğŸ§ª ì†Œëª¨í’ˆ:</div>
        <div class="item-list" id="consumable-list"></div>
    </div>

    <div id="battle-scene" class="scene">
        <div class="battle-area">
            <div class="character" id="player-char">
                <h3 style="margin:2px 0; font-size:1em;">ğŸ‘¤ í”Œë ˆì´ì–´</h3>
                <img id="p-img" src="https://placehold.co/150x150/3498db/ffffff?text=Hero" alt="Player" class="char-img" style="width:100px; height:100px;"> <div class="hp-bar-bg"><div class="hp-bar-fill" id="p-hp-bar"></div></div>
                <div style="font-size:0.9em;">HP: <span id="p-hp">25</span>/<span id="p-max-hp">25</span> <span class="block-icon">ğŸ›¡ï¸<span id="p-block">0</span></span></div>
                <div class="stats" id="p-stats" style="font-size:0.8em;">ê³µ1 ë°©1 ì†1</div>
                <div class="buffs" id="p-buffs" style="min-height:20px;"></div>
                <div style="margin-top: 5px; display: flex; justify-content: center; gap: 3px;">
                    <button id="btn-draw-pile" class="small-btn" style="font-size:0.7em;" onclick="openPileView('draw')">ë±(0)</button>
                    <button id="btn-discard-pile" class="small-btn" style="font-size:0.7em;" onclick="openPileView('discard')">ë²„ë¦¼(0)</button>
                    <button id="btn-exhaust-pile" class="small-btn" style="font-size:0.7em;" onclick="openPileView('exhaust')">ì†Œë©¸(0)</button>
                </div>
            </div>

            <div class="character" id="enemy-char">
                <h3 id="e-name" style="margin:2px 0; font-size:1em;">ğŸ‘¿ í—ˆìˆ˜ì•„ë¹„</h3>
                <img id="e-img" src="https://placehold.co/150x150/e74c3c/ffffff?text=Enemy" alt="Enemy" class="char-img" style="width:100px; height:100px;"> <div class="hp-bar-bg"><div class="hp-bar-fill" id="e-hp-bar"></div></div>
                <div style="font-size:0.9em;">HP: <span id="e-hp">25</span>/<span id="e-max-hp">25</span> <span class="block-icon">ğŸ›¡ï¸<span id="e-block">0</span></span></div>
                <div class="stats" id="e-stats" style="font-size:0.8em;">ê³µ1 ë°©1 ì†1</div>
                <div class="buffs" id="e-buffs" style="min-height:20px;"></div>
            </div>
        </div>

        <div class="control-group">
            <div class="status-panel">
                <div id="turn-info" style="word-break: keep-all;">ê²Œì„ ì‹œì‘</div>
            </div>
            
            <div class="log-area" id="log-box"></div>
            
            <button id="end-turn-btn" class="action-btn btn-end-turn-side" onclick="endPlayerTurn()">
                í„´<br>ì¢…ë£Œ
            </button>
        </div>

    <div class="hand-area" id="hand-container"></div>
</div>

    <div id="event-scene" class="scene hidden">
        <div class="event-content" id="event-content-box"></div>
    </div>
</div>

<div id="popup-layer">
    <div class="popup-box" onclick="event.stopPropagation()">
        <h2 id="popup-title" style="color:#f1c40f;">ì œëª©</h2>
        <div id="popup-desc" style="font-size:1.1em; color:#ddd; margin:10px 0;">ë‚´ìš©</div>
        <div id="popup-content"></div>
        <div class="popup-btns" id="popup-buttons"></div>
    </div>
</div>

<script>
/* --- ë°ì´í„° (ì¹´ë“œ) --- */
const CARD_DATA = {
    // 1ì„± (ê¸°ë³¸)
    "íƒ€ê²©": { rank: 1, cost: 1, type: "attack", desc: "ì  HP -5", dmg: 5 },
    "ìˆ˜ë¹„": { rank: 1, cost: 1, type: "skill", desc: "ë°©ì–´ë„ +4", block: 4 },
   
    
    // 1ì„± (íŠ¹ìˆ˜)
    "ì ìê¸°": { rank: 1, cost: 0, type: "skill", desc: "í™œë ¥(2í„´), ë°©ì–´ë„+2 (ì†Œë©¸)", buff: {name:"í™œë ¥", val:2}, block: 2, isExhaust: true },

    // 2ì„± (ë””ë²„í”„ & ë³µí•©)
    // ê¸°ì¡´: valì´ ë°©ì–´ë„ì˜€ìŒ -> block: 3ìœ¼ë¡œ ëª…ì‹œ
    "ë„ë°œ": { rank: 2, cost: 2, type: "skill", desc: "ì  ì•½í™”(2í„´), ë°©ì–´ë„+3", buff: {name:"ì•½í™”", val:2}, block: 3 },
    "ë… ë¿Œë¦¬ê¸°": { rank: 2, cost: 2, type: "skill", desc: "ì  ë…(2í„´), ë°©ì–´ë„+3", buff: {name:"ë…", val:2}, block: 3 },
    "íë§ê´‘ì„ ": { rank: 2, cost: 2, type: "skill", desc: "ë‚˜ í™œë ¥(2í„´), ë°©ì–´ë„+3", buff: {name:"í™œë ¥", val:2}, target:"self", block: 3 },
    "ê»´ì…ê¸°": { rank: 2, cost: 2, type: "skill", desc: "ë‚˜ ê±´ê°•(2í„´), ë°©ì–´ë„+4", buff: {name:"ê±´ê°•", val:2}, target:"self", block: 4 },

    // 2ì„± (ê³µê²© + ë””ë²„í”„/ë²„í”„)
    "ë„˜ì–´ëœ¨ë¦¬ê¸°": { rank: 2, cost: 2, type: "attack", desc: "ì  ì·¨ì•½(2í„´), ì  HP -4", buff: {name:"ì·¨ì•½", val:2}, dmg: 4 },
    "ì „ê¸° ì¶©ê²©": { rank: 2, cost: 2, type: "attack", desc: "ì  ë§ˆë¹„(2í„´), ì  HP -4", buff: {name:"ë§ˆë¹„", val:2}, dmg: 4 },
    "ê·¼ìœ¡ìë‘": { rank: 2, cost: 2, type: "attack", desc: "ë‚˜ ê°•í™”(2í„´), ì  HP -4", buff: {name:"ê°•í™”", val:2}, target:"self", dmg: 4 },
    "ë‹¬ë¦¬ê¸°": { rank: 2, cost: 2, type: "attack", desc: "ë‚˜ ì¾Œì†(2í„´), ì  HP -4", buff: {name:"ì¾Œì†", val:2}, target:"self", dmg: 4 },

    "ëŒì§„" : { rank: 2, cost: 2, type: "attack", desc: "ì  8 í”¼í•´, ë°©ì–´ë„ +8", dmg: 8, block: 8},

    // íŠ¹ìˆ˜ ê¸°ëŠ¥ (special íƒœê·¸ ì‚¬ìš©)
    "ë°©íŒ¨ ë¶€ìˆ˜ê¸°": { rank: 2, cost: 2, type: "attack", desc: "ì  ë°©ì–´ë„ ì œê±°, ì  HP -2", special: "break_block", dmg: 2 },
    "ì£¼ë¨¸ë‹ˆ ë’¤ì§€ê¸°": { rank: 2, cost: 1, type: "skill", desc: "ë°©ì–´ë„ +2, ì¹´ë“œ 2ì¥ ë½‘ê¸°", block: 2, draw: 1 },
    // 3ì„±
    "ì‚¬ê²©": { rank: 3, cost: 1, type: "attack", desc: "ë‚˜ ê°•í™”(2í„´), ì  HP -8", buff: {name:"ê°•í™”", val:2}, target:"self", dmg: 8 },
    "ëŸ­í‚¤í”¼ìŠ¤": { rank: 3, cost: 1, type: "attack", desc: "ì  HP -8, ìƒê¸ˆ 2ë°° (ì†Œë©¸)", special: "lucky", dmg: 8, isExhaust: true }
};

const TOOLTIPS = {
    "ì•½í™”": "ê³µê²© ìŠ¤íƒ¯ì´ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.",
    "ì·¨ì•½": "ë°©ì–´ ìŠ¤íƒ¯ì´ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.",
    "ë§ˆë¹„": "ì†ë„ ìŠ¤íƒ¯ì´ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.",
    "ë…": "í„´ ì‹œì‘ ì‹œ ì¤‘ì²©ëœ ìˆ˜ì¹˜ë§Œí¼ í”¼í•´ë¥¼ ì…ê³ , 1 ì¤„ì–´ë“­ë‹ˆë‹¤.",
    "ê°•í™”": "ê³µê²© ìŠ¤íƒ¯ì´ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.",
    "ê±´ê°•": "ë°©ì–´ ìŠ¤íƒ¯ì´ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.",
    "ì¾Œì†": "ì†ë„ ìŠ¤íƒ¯ì´ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.",
    "í™œë ¥": "í„´ ì‹œì‘ ì‹œ ì¤‘ì²©ëœ ìˆ˜ì¹˜ë§Œí¼ ì²´ë ¥ì„ íšŒë³µí•˜ê³ , 1 ì¤„ì–´ë“­ë‹ˆë‹¤.",
    // [ì¶”ê°€ëœ ë¶€ë¶„] ì†Œë©¸ ì„¤ëª… ì¶”ê°€
    "ì†Œë©¸": "ì¹´ë“œë¥¼ ì‚¬ìš©í•˜ë©´ ë±ì—ì„œ ì œê±°ë˜ì–´, ì´ë²ˆ ì „íˆ¬ ë™ì•ˆ ë‹¤ì‹œ ë‚˜ì˜¤ì§€ ì•ŠìŠµë‹ˆë‹¤."
};

function applyTooltip(text) {
    let res = text;
    for (let key in TOOLTIPS) {
        let regex = new RegExp(key, 'g'); 
        res = res.replace(regex, `<span class="keyword">${key}<span class="tip-text">${TOOLTIPS[key]}</span></span>`);
    }
    return res;
}

/* --- ë°ì´í„° (ì•„ì´í…œ) --- */
/* [ìˆ˜ì •] ITEM_DATA ì „ì²´ë¥¼ ì´ê±¸ë¡œ ì—…ë°ì´íŠ¸í•˜ì„¸ìš” */
const ITEM_DATA = {
    // --- ìœ ë¬¼ (íŒ¨ì‹œë¸Œ íš¨ê³¼ëŠ” ë³„ë„ ë¡œì§ì´ë¼ effect íƒœê·¸ê°€ ë‹¹ì¥ í•„ìš”í•˜ì§„ ì•Šì§€ë§Œ, í™•ì¥ì„ ìœ„í•´ ë¶„ë¥˜) ---
    "ì¿ ë³´íƒ„": {type: "relic", rank: 1, price: 2000, icon: "ğŸ¥Š", desc: "ê³µê²©ë ¥ +1 (íŒ¨ì‹œë¸Œ)"},
    "ê°•ì¸í•¨ì˜ ë¶€ì ": {type: "relic", rank: 1, price: 2000, icon: "ğŸ§¿", desc: "ë°©ì–´ë ¥ +1 (íŒ¨ì‹œë¸Œ)"},
    "ì¢‹ì€ ìš´ë™í™”": {type: "relic", rank: 1, price: 2000, icon: "ğŸ‘Ÿ", desc: "ì†ë„ +1 (íŒ¨ì‹œë¸Œ)"},
    "ìš¸ëˆë¶ˆëˆ íŒ¨ë”©": {type: "relic", rank: 2, price: 3000, icon: "ğŸ§¥", desc: "ìµœëŒ€ HP +50 ì¦ê°€"},
    "í™©ê¸ˆ ëŒ€íƒ€": {type: "relic", rank: 3, price: 4000, icon: "ğŸº", desc: "ì‚¬ë§ ì‹œ 1000ì›ì„ ì†Œëª¨í•˜ì—¬ ë¶€í™œ"},

    // --- ì†Œëª¨í’ˆ (ì—¬ê¸°ì„œë¶€í„° ë°ì´í„° êµ¬ì¡°í™” ì ìš©!) ---
    
    // effect: "heal" -> ì²´ë ¥ íšŒë³µ
    "íšŒë³µì•½": {type: "consumable", rank: 1, price: 1000, icon: "ğŸ·", desc: "HP 25 íšŒë³µ", effect: "heal", val: 25},
    
    // effect: "damage" -> ì ì—ê²Œ í”¼í•´
    "í˜¸ì‹ ìš© ìŠ¤í”„ë ˆì´": {type: "consumable", rank: 1, price: 1000, icon: "ğŸ§´", desc: "ì ì—ê²Œ 10 í”¼í•´", effect: "damage", val: 10},
    
    // effect: "event_rest" -> ë‹¤ìŒ ì´ë²¤íŠ¸ ê³ ì •
    "í”¼ë‚œì˜ í”¼ë¦¬": {type: "consumable", rank: 2, price: 2000, icon: "ğŸ¼", desc: "ë‹¤ìŒ ì´ë²¤íŠ¸ë¥¼ [íœ´ì‹]ìœ¼ë¡œ ê³ ì •", effect: "event_rest"},
    
    // effect: "revive" -> ë¶€í™œ (ìˆ˜ë™ ì‚¬ìš© ë¶ˆê°€)
    "ëŒ€íƒ€ ì¸í˜•": {type: "consumable", rank: 3, price: 3000, icon: "ğŸ§¸", desc: "ì‚¬ë§ ì‹œ ìë™ ë¶€í™œ", effect: "revive"}
};
/* --- ìƒíƒœ ë³€ìˆ˜ --- */
let player = { 
    maxHp: 25, hp: 25, baseAtk: 1, baseDef: 1, baseSpd: 1, 
    gold: 0, deck: [], hand: [], block: 0, buffs: {}, ap: 3, 
    jumadeung: false, lucky: false,
    drawPile: [], discardPile: [], 
    exhaustPile: [], // [NEW] ì†Œë©¸ëœ ì¹´ë“œ ì €ì¥ì†Œ
    relics: [], consumables: [],
    xp: 0, 
    maxXp: 100 // 1ë ˆë²¨ì—… í•„ìš” ê²½í—˜ì¹˜
};
let enemy = { name: "í—ˆìˆ˜ì•„ë¹„", maxHp: 25, hp: 25, baseAtk: 1, baseDef: 1, baseSpd: 1, deck: [], block: 0, buffs: {}, ap: 3 };
/* [ìˆ˜ì •] game ë³€ìˆ˜ ì •ì˜ ë¶€ë¶„ */
let game = { 
    level: 1, 
    turnCount: 0, 
    state: "battle", 
    turnOwner: "none", 
    lastWho: null, 
    forceRest: false, 
    extraTurnTriggered: false,
    
    // [NEW] ìŠ¹ë¦¬ í™”ë©´ ìœ ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜ë“¤
    pendingLoot: null,  // ë°”ë‹¥ì— ë–¨ì–´ì§„ ì•„ì´í…œ
    winMsg: ""          // ìŠ¹ë¦¬ ë©”ì‹œì§€ ì €ì¥
};

/* --- ìœ í‹¸ë¦¬í‹° --- */
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
function log(msg) { const box = document.getElementById('log-box'); box.innerHTML += `<div>${msg}</div>`; box.scrollTop = box.scrollHeight; }

/* --- ì¥ë©´ ì „í™˜ --- */
function switchScene(sceneName) {
    document.getElementById('battle-scene').classList.add('hidden');
    document.getElementById('event-scene').classList.add('hidden');
    document.getElementById('popup-layer').style.display = 'none';
    if (sceneName === 'battle') document.getElementById('battle-scene').classList.remove('hidden');
    else if (sceneName === 'event') document.getElementById('event-scene').classList.remove('hidden');
    updateUI();
}

/* --- ì´ˆê¸°í™” --- */
function initGame() {
    // 1. ê¸°ë³¸ ë± ì„¤ì •: íƒ€ê²© 5ì¥ + ìˆ˜ë¹„ 4ì¥
    player.deck = ["íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","ìˆ˜ë¹„","ìˆ˜ë¹„","ìˆ˜ë¹„","ìˆ˜ë¹„"];
    
    // 2. ë¬´ì‘ìœ„ 2ì„± ì¹´ë“œ 1ì¥ ì¶”ê°€
    addRandomCard(2); 
    
    // (ì‚­ì œë¨) player.deck.push("ì ìê¸°"); 
    
    updateUI();
    startBattle();
}

/* --- ì¸ë²¤í† ë¦¬ ì‹œìŠ¤í…œ --- */
function addItem(name) {
    const data = ITEM_DATA[name];
    if (data.type === 'relic') {
        if (player.relics.includes(name)) return false; 
        player.relics.push(name);
        if (name === "ìš¸ëˆë¶ˆëˆ íŒ¨ë”©") { player.maxHp += 50; player.hp += 50; log("ğŸ§¥ íŒ¨ë”© ì¥ì°©! ìµœëŒ€ ì²´ë ¥ì´ 50 ì¦ê°€í–ˆìŠµë‹ˆë‹¤."); }
    } else { player.consumables.push(name); }
    updateInventoryUI(); return true;
}
/* [ìˆ˜ì •] useConsumable í•¨ìˆ˜ ì „ì²´ êµì²´ */
function useConsumable(index) {
    const name = player.consumables[index];
    const data = ITEM_DATA[name];

    // 1. ì‚¬ìš© ì¡°ê±´ ì²´í¬
    // ì „íˆ¬ ì¤‘ì—ë§Œ ì“¸ ìˆ˜ ìˆëŠ” ê³µê²© ì•„ì´í…œì¸ì§€ í™•ì¸
    if (data.effect === "damage") {
        if (game.state !== "battle") { log("ğŸš« ê³µê²© ì•„ì´í…œì€ ì „íˆ¬ ì¤‘ì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
        if (game.turnOwner !== "player") { log("ğŸš« ë‚´ í„´ì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
    }
    
    // 2. íš¨ê³¼ ì²˜ë¦¬ (Switchë¬¸ ì‚¬ìš©)
    let used = false; // ì‹¤ì œë¡œ ì‚¬ìš©í–ˆëŠ”ì§€ ì—¬ë¶€

    switch (data.effect) {
        case "heal":
            // íšŒë³µ ë¡œì§ (val ì†ì„± ì‚¬ìš©)
            let oldHp = player.hp;
            player.hp = Math.min(player.maxHp, player.hp + data.val);
            let healed = player.hp - oldHp;
            log(`ğŸ¥¤ [${name}] ì‚¬ìš©! ì²´ë ¥ì„ ${healed} íšŒë³µí–ˆìŠµë‹ˆë‹¤.`);
            used = true;
            break;

        case "damage":
            // ë°ë¯¸ì§€ ë¡œì§ (val ì†ì„± ì‚¬ìš©)
            enemy.hp -= data.val;
            log(`ğŸ’¥ [${name}] ë°œì‚¬! ì ì—ê²Œ ${data.val} í”¼í•´.`);
            checkGameOver(); // ì ì´ ì£½ì—ˆëŠ”ì§€ í™•ì¸
            used = true;
            break;

        case "event_rest":
            // ì´ë²¤íŠ¸ ê³ ì • ë¡œì§
            game.forceRest = true;
            log(`ğŸ¼ [${name}]ì„ ë¶ˆì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì¥ì†ŒëŠ” ì•ˆì „í•  ê²ƒì…ë‹ˆë‹¤.`);
            used = true;
            break;

        case "revive":
            // ë¶€í™œ ì•„ì´í…œ (ìˆ˜ë™ ì‚¬ìš© ë¶ˆê°€)
            log(`ğŸ§¸ [${name}]ì€ ì†Œì§€í•˜ê³  ìˆìœ¼ë©´ ì£½ì„ ë•Œ ìë™ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.`);
            used = false; // ì‚¬ìš©ë˜ì§€ ì•ŠìŒ (ì¸ë²¤í† ë¦¬ì— ë‚¨ìŒ)
            break;

        default:
            log("ğŸš« ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.");
            used = false;
            break;
    }

    // 3. ì•„ì´í…œ ì†Œëª¨ ì²˜ë¦¬
    if (used) {
        player.consumables.splice(index, 1);
        updateUI();
    }
}
function updateInventoryUI() {
    const rList = document.getElementById('relic-list'); const cList = document.getElementById('consumable-list'); rList.innerHTML = ""; cList.innerHTML = "";
    player.relics.forEach(name => { let data = ITEM_DATA[name]; let el = document.createElement('div'); el.className = `item-icon item-relic item-rank-${data.rank}`; el.innerHTML = `${data.icon}<span class="tooltip"><b>${name}</b><br>${data.desc}</span>`; rList.appendChild(el); });
    player.consumables.forEach((name, idx) => { let data = ITEM_DATA[name]; let el = document.createElement('div'); el.className = `item-icon item-consumable item-rank-${data.rank}`; el.innerHTML = `${data.icon}<span class="tooltip"><b>${name}</b><br>${data.desc}</span>`; el.onclick = () => useConsumable(idx); cList.appendChild(el); });
}

/* --- ì „íˆ¬ ì‹œìŠ¤í…œ --- */
function startBattle() {
    switchScene('battle'); game.state = "battle"; 
    let growth = game.level - 1;
    enemy.name = `í—ˆìˆ˜ì•„ë¹„ Lv.${game.level}`; enemy.maxHp = 25 + (growth * 5); enemy.hp = enemy.maxHp;
    enemy.baseAtk = 1; enemy.baseDef = 1; enemy.baseSpd = 1;
    for(let i=0; i<growth; i++) { let r = Math.random(); if (r < 0.33) enemy.baseAtk++; else if (r < 0.66) enemy.baseDef++; else enemy.baseSpd++; }
    enemy.deck = ["íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","ìˆ˜ë¹„","ìˆ˜ë¹„","ìˆ˜ë¹„","ìˆ˜ë¹„"];
    let rank2Cards = Object.keys(CARD_DATA).filter(k => CARD_DATA[k].rank === 2);
    enemy.deck.push(rank2Cards[Math.floor(Math.random() * rank2Cards.length)]);

    player.drawPile = [...player.deck]; shuffle(player.drawPile);
    player.discardPile = [];
    player.exhaustPile = []; // [NEW] ì „íˆ¬ ì‹œì‘ ì‹œ ì†Œë©¸ ë”ë¯¸ ì´ˆê¸°í™”
    player.hand = [];
    enemy.buffs = {}; player.buffs = {}; player.block = 0; enemy.block = 0; player.lucky = false; player.jumadeung = false;
    game.turnCount = 0; game.lastWho = null;
    game.extraTurnTriggered = false; // [NEW] ì¶”ê°€ í–‰ë™ê¶Œ ì‚¬ìš© ì—¬ë¶€ ì´ˆê¸°í™”
    log(`âš”ï¸ Lv.${game.level} ì „íˆ¬ ì‹œì‘!`); updateUI(); nextTurnCycle();
}

async function nextTurnCycle() {
    if (checkGameOver()) return;
    
    game.turnCount++;
    log(`---- Turn ${game.turnCount} ----`);

    // 1. ë²„í”„/ë””ë²„í”„ í„´ ê²½ê³¼ ì²˜ë¦¬
    tickBuffs(player); tickBuffs(enemy);
    decrementBuffs(player); decrementBuffs(enemy);
    if (checkGameOver()) return;

    // 2. í˜„ì¬ ìŠ¤íƒ¯ í™•ì¸
    let pSpd = getStat(player, 'spd');
    let eSpd = getStat(enemy, 'spd');

    // 3. [í•µì‹¬ ìˆ˜ì •] ì´ë²ˆ í„´ì˜ 'ì¶”ê°€ í–‰ë™ê¶Œ' ì‚¬ìš© ì—¬ë¶€ ì´ˆê¸°í™”
    // ë§Œì•½ ì‹œì‘ë¶€í„° ì´ë¯¸ 2ë°° ë¹¨ë¼ì„œ 2íšŒ í–‰ë™ì„ ë°›ëŠ”ë‹¤ë©´? -> ì´ë¯¸ ë°›ì€ ê±¸ë¡œ ì²˜ë¦¬(true)
    // ì‹œì‘ì€ ë¹„ìŠ·í–ˆëŠ”ë° ë„ì¤‘ì— ë¹¨ë¼ì§„ ê²½ìš°ì—ë§Œ? -> ì•„ì§ ì•ˆ ë°›ì€ ê±¸ë¡œ ì²˜ë¦¬(false)
    if (pSpd >= eSpd * 2) {
        game.extraTurnTriggered = true; // ì´ë¯¸ ë¹¨ë¼ì„œ í˜œíƒ ë°›ìŒ (ì¤‘ë³µ ì§€ê¸‰ ë°©ì§€)
    } else {
        game.extraTurnTriggered = false; // ì•„ì§ í˜œíƒ ì•ˆ ë°›ìŒ (ë„ì¤‘ì— ë¹¨ë¼ì§€ë©´ ë°›ì„ ìˆ˜ ìˆìŒ)
    }

    // 4. í„´ ìˆœì„œ ë°°ì • (ê¸°ì¡´ ë¡œì§)
    let pTurns = (pSpd >= eSpd * 2) ? 2 : 1;
    let eTurns = (eSpd >= pSpd * 2) ? 2 : 1;
    
    // (ë¡œê·¸ ì¶œë ¥: ì´ë¯¸ ë¹¨ë¼ì„œ 2í„´ì´ë©´ ì—¬ê¸°ì„œ ì•Œë ¤ì¤Œ)
    if (pTurns > 1) log("âš¡ ì••ë„ì ì¸ ì†ë„! 2íšŒ í–‰ë™í•©ë‹ˆë‹¤.");
    if (eTurns > 1) log("âš¡ ì ì´ ë¹¨ë¼ì„œ 2íšŒ í–‰ë™í•©ë‹ˆë‹¤!");

    // í„´ í ìƒì„±
    let order = [];
    if (eSpd > pSpd) { 
        for(let i=0; i<eTurns; i++) order.push("enemy"); 
        for(let i=0; i<pTurns; i++) order.push("player"); 
    } else { 
        for(let i=0; i<pTurns; i++) order.push("player"); 
        for(let i=0; i<eTurns; i++) order.push("enemy"); 
    }
    
    await executeTurnQueue(order);
}

async function executeTurnQueue(queue) {
    if (queue.length === 0) { nextTurnCycle(); return; }
    if (checkGameOver()) return;
    let who = queue.shift(); let isConsecutive = (who === game.lastWho); game.lastWho = who; game.turnOwner = who; updateUI();
    if (who === "player") { game.currentQueue = queue; startPlayerTurn(isConsecutive); }
    else { await startEnemyTurn(isConsecutive); await executeTurnQueue(queue); }
}

function startPlayerTurn(isConsecutive) {
    if (!isConsecutive) player.block = 0; player.ap = 3; drawCards(5);
    document.getElementById('end-turn-btn').disabled = false;
    document.getElementById('turn-info').innerText = `ë‚˜ì˜ í„´ (í–‰ë™ë ¥: ${player.ap})`;
    document.getElementById('player-char').classList.add('turn-active'); document.getElementById('enemy-char').classList.remove('turn-active'); updateUI();
}

function endPlayerTurn() {
    document.getElementById('end-turn-btn').disabled = true;
    if (player.hand.length > 0) { player.discardPile.push(...player.hand); player.hand = []; }
    renderHand(); game.turnOwner = "none"; updateUI(); executeTurnQueue(game.currentQueue);
}

async function startEnemyTurn(isConsecutive) {
    if (!isConsecutive) enemy.block = 0; enemy.ap = 3; 
    document.getElementById('turn-info').innerText = "ì ì˜ í„´ (í–‰ë™ ì¤‘...)";
    document.getElementById('enemy-char').classList.add('turn-active'); document.getElementById('player-char').classList.remove('turn-active'); updateUI(); log(`ğŸ‘¿ ì ì˜ í„´ ì‹œì‘ (AP: ${enemy.ap})`);
    while (enemy.ap > 0 && player.hp > 0) {
        await sleep(1000); let playable = enemy.deck.filter(n => CARD_DATA[n].cost <= enemy.ap);
        if (playable.length === 0) { log("ğŸ’¬ ì  í„´ ì¢…ë£Œ."); break; }
        let cName = playable[Math.floor(Math.random() * playable.length)]; enemy.ap -= CARD_DATA[cName].cost;
        useCard(enemy, player, cName); updateUI(); if (checkGameOver()) return;
    }
    await sleep(800);
}

function useCard(user, target, cardName) {
    let data = CARD_DATA[cardName];
    let atk = getStat(user, 'atk');
    let def = getStat(user, 'def');
    
    log(`ğŸƒ ${user===player?"ë‚˜":"ì "}ì˜ [${cardName}]!`);
    let userId = (user === player) ? "player-char" : "enemy-char";

    // 1. [ê³µê²©]
    if (data.type.includes("attack")) {
        if (user === player) playAnim(userId, 'anim-atk-p');
        else playAnim(userId, 'anim-atk-e');

        if (data.special === "break_block") { target.block = 0; log(`ğŸ”¨ ë°©ì–´êµ¬ íŒŒê´´!`); }
        if (data.special === "lucky" && user === player) { player.lucky = true; log(`ğŸ€ í–‰ìš´ ë°œë™!`); }

        let finalDmg = (data.dmg || 0) + atk;
        takeDamage(target, finalDmg);
    } 
    // 2. [ìŠ¤í‚¬]
    else {
        playAnim(userId, 'anim-bounce');
    }

    // 3. [ê³µí†µ: ë°©ì–´ ë° ë²„í”„]
    if (data.block) {
        let finalBlock = data.block + def;
        user.block += finalBlock;
        log(`ğŸ›¡ï¸ ë°©ì–´ë„ +${finalBlock}`);
    }

    if (data.buff) {
        let buffName = data.buff.name;
        let buffVal = data.buff.val;
        let buffTarget = target; 
        
        const selfBuffs = ["ê°•í™”", "ê±´ê°•", "ì¾Œì†", "í™œë ¥"];
        if (data.target === "self" || selfBuffs.includes(buffName)) { 
            buffTarget = user; 
        }
        applyBuff(buffTarget, buffName, buffVal);
    }
    // 4. [ë“œë¡œìš° íš¨ê³¼]
        if (data.draw && user === player) {
            drawCards(data.draw);
            log(`ğŸƒ ì¹´ë“œë¥¼ ${data.draw}ì¥ ë½‘ì•˜ìŠµë‹ˆë‹¤.`);
        }
    // [ìˆ˜ì •] 5. ì‹¤ì‹œê°„ í„´ ì¬ê³„ì‚° (í•œ ë¼ìš´ë“œì— 1ë²ˆë§Œ ë°œë™)
    // -----------------------------------------------------------
    if (user === player) {
        let pSpd = getStat(player, 'spd');
        let eSpd = getStat(enemy, 'spd');

        // ì¡°ê±´ 1: ì†ë„ê°€ 2ë°° ì´ìƒ ì°¨ì´ë‚¨
        // ì¡°ê±´ 2: [NEW] ì´ë²ˆ ë¼ìš´ë“œì— ì•„ì§ ì¶”ê°€ í„´ì„ ë°›ì§€ ì•ŠìŒ (!game.extraTurnTriggered)
        if (pSpd >= eSpd * 2 && !game.extraTurnTriggered) {
            
            // ì¡°ê±´ 3: íì˜ ë§¨ ì•ì´ ì´ë¯¸ ë‚´ í„´ì´ ì•„ë‹ ë•Œ (ì¤‘ë³µ ë°©ì§€)
            if (game.currentQueue.length === 0 || game.currentQueue[0] !== "player") {
                
                game.currentQueue.unshift("player"); // í„´ ìƒˆì¹˜ê¸°
                game.extraTurnTriggered = true;      // [NEW] "ë‚˜ ë°›ì•˜ë‹¤" ë„ì¥ ì¾…!
                
                log("âš¡ ì••ë„ì ì¸ ì†ë„! í–‰ë™ ê¸°íšŒë¥¼ ì¦‰ì‹œ íšë“í•©ë‹ˆë‹¤!");
                if(typeof showDamageText === "function") showDamageText(player, "SPEED UP!");
                
                updateUI();
            }
        }
    }
}
function takeDamage(target, dmg) {
    // 1. [ì• ë‹ˆë©”ì´ì…˜] í”¼ê²© ëª¨ì…˜ ì¬ìƒ (ë§ëŠ” ëŒ€ìƒì— ë”°ë¼ ID ê²°ì •)
    let targetId = (target === player) ? "player-char" : "enemy-char";
    playAnim(targetId, 'anim-hit');

    // 2. [ë°©ì–´ë„ ì—°ì‚°] ë°©íŒ¨ê°€ ìˆìœ¼ë©´ ë°ë¯¸ì§€ë¥¼ ë¨¼ì € í¡ìˆ˜
    if (target.block > 0) {
        if (target.block >= dmg) {
            target.block -= dmg;
            dmg = 0; // ë°©ì–´ë„ê°€ ë°ë¯¸ì§€ë³´ë‹¤ ë§ìœ¼ë©´ HP í”¼í•´ ì—†ìŒ
        } else {
            dmg -= target.block;
            target.block = 0; // ë°©ì–´ë„ ë‹¤ ê¹¨ì§€ê³  ë‚¨ì€ ë°ë¯¸ì§€ë§Œ ë“¤ì–´ê°
        }
    }
// [NEW] ëŒ€ë¯¸ì§€ í…ìŠ¤íŠ¸ ë„ìš°ê¸°!
    if (dmg > 0) {
        showDamageText(target, dmg); // ì˜ˆ: "15"
    } else {
        showDamageText(target, "BLOCK"); // ëŒ€ë¯¸ì§€ 0ì¼ ë•Œ
    }

    // 3. [ì²´ë ¥ ê°ì†Œ] ì‹¤ì œ HP ì°¨ê°
    target.hp -= dmg;
    log(`ğŸ’¥ ${dmg} í”¼í•´! (HP: ${target.hp})`); // (ë¡œê·¸ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì£¼ì„ ì²˜ë¦¬)

    // 4. [í”Œë ˆì´ì–´ ì‚¬ë§ ìœ„ê¸° ì²˜ë¦¬] HPê°€ 0 ì´í•˜ì¼ ë•Œ ìƒì¡´ ë¡œì§ ê°€ë™
    if (target === player && target.hp <= 0) {

        // (1ë‹¨ê³„) ì•„ì´í…œ ë¶€í™œ ì²´í¬: 'effect'ê°€ 'revive'ì¸ ì•„ì´í…œ ì°¾ê¸°
        // (ì´ë¦„("ëŒ€íƒ€ ì¸í˜•")ìœ¼ë¡œ ì°¾ì§€ ì•Šê³  íš¨ê³¼ë¡œ ì°¾ìœ¼ë¯€ë¡œ, ë‚˜ì¤‘ì— ì•„ì´í…œ ì´ë¦„ì´ ë°”ë€Œì–´ë„ ì‘ë™í•¨)
        let reviveItemIdx = player.consumables.findIndex(name => ITEM_DATA[name].effect === "revive");

        if (reviveItemIdx !== -1) {
            let itemName = player.consumables[reviveItemIdx]; // ì•„ì´í…œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            
            player.hp = player.maxHp; // í’€í”¼ ë¶€í™œ
            player.consumables.splice(reviveItemIdx, 1); // ì•„ì´í…œ ì†Œëª¨

            log(`âœ¨ [${itemName}]ì˜ íš¨ê³¼ë¡œ ë¶€í™œí–ˆìŠµë‹ˆë‹¤!`);
            playAnim(targetId, 'anim-bounce'); // ë¶€í™œí•´ì„œ ê¸°ì˜ë‹ˆê¹Œ ì í”„ ëª¨ì…˜

            updateInventoryUI();
            updateUI();
            return; // ì£½ì§€ ì•Šê³  ì—¬ê¸°ì„œ ì¢…ë£Œ
        }

        // (2ë‹¨ê³„) ìœ ë¬¼ ë¶€í™œ ì²´í¬: 'í™©ê¸ˆ ëŒ€íƒ€' (ê³¨ë“œ ì†Œëª¨)
        if (player.relics.includes("í™©ê¸ˆ ëŒ€íƒ€") && player.gold >= 1000) {
            player.gold -= 1000;
            player.hp = player.maxHp;

            log("ğŸº [í™©ê¸ˆ ëŒ€íƒ€]ê°€ 1000ì›ì„ ì†Œëª¨í•˜ì—¬ ë‹¹ì‹ ì„ ì‚´ë ¸ìŠµë‹ˆë‹¤!");
            playAnim(targetId, 'anim-bounce');

            updateUI();
            return;
        }

        // (3ë‹¨ê³„) ì£¼ë§ˆë“± ì‹œìŠ¤í…œ: ì•„ë¬´ê²ƒë„ ì—†ì„ ë•Œ ë”± í•œ ë²ˆ 1ë¡œ ë²„íŒ€
        if (!target.jumadeung) {
            target.hp = 1;
            target.jumadeung = true; // ì£¼ë§ˆë“± ì‚¬ìš© ì²˜ë¦¬

            log("âš¡ [ì£¼ë§ˆë“±] ì¹˜ëª…ì ì¸ ê³µê²©ì„ ê°„ì‹ íˆ ë²„í…¼ìŠµë‹ˆë‹¤! (HP 1)");
            playAnim(targetId, 'anim-bounce');

            updateUI();
            return;
        }

        // (4ë‹¨ê³„) ì—¬ê¸°ê¹Œì§€ ì™”ìœ¼ë©´ ì§„ì§œ ì‚¬ë§... (checkGameOverì—ì„œ ê²Œì„ ì˜¤ë²„ ì²˜ë¦¬ë¨)
    }
}
        /* [ì¶”ê°€] ëŒ€ë¯¸ì§€ í°íŠ¸ ì¶œë ¥ í•¨ìˆ˜ */
        function showDamageText(target, text) {
            // 1. ë„ìš¸ ìœ„ì¹˜(ìºë¦­í„° ë°•ìŠ¤) ì°¾ê¸°
            let targetId = (target === player) ? "player-char" : "enemy-char";
            let parentEl = document.getElementById(targetId);

            // 2. í…ìŠ¤íŠ¸ ìš”ì†Œ ìƒì„± (div)
            let el = document.createElement("div");
            el.className = "damage-number";
            el.innerText = text; // ìˆ«ìë‚˜ í…ìŠ¤íŠ¸(BLOCK ë“±)

            // 3. ìºë¦­í„° ë°•ìŠ¤ ì•ˆì— ë¶™ì´ê¸°
            parentEl.appendChild(el);

            // 4. ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„(0.8ì´ˆ) ë’¤ì— HTMLì—ì„œ ì™„ì „ ì œê±° (ì²­ì†Œ)
            setTimeout(() => {
                el.remove();
            }, 800);
        }
function checkGameOver() {
    if (player.hp <= 0) { 
        showPopup("ğŸ’€ ê²Œì„ ì˜¤ë²„", "íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...", [{txt:"ë‹¤ì‹œ í•˜ê¸°", func: ()=>location.reload()}]); 
        return true; 
    }
    
    if (enemy.hp <= 0) {
        if(game.state === "win") return true; 
        game.state = "win";
        
        // 1. ë³´ìƒ ê³„ì‚°
        let rewardGold = 1000 * (player.lucky ? 2 : 1); 
        player.gold += rewardGold; 
        
        let gainXp = 40 + (game.level * 10);
        player.xp += gainXp;

        // 2. ë©”ì‹œì§€ ì €ì¥
        game.winMsg = `ìŠ¹ë¦¬! ${rewardGold}ì›, ${gainXp} XP íšë“.`; 
        if (player.lucky) game.winMsg += " (ëŸ­í‚¤í”¼ìŠ¤ íš¨ê³¼!)";

        // 3. ì•„ì´í…œ ë“œë ê²°ì • (ì €ì¥ë§Œ í•¨)
        game.pendingLoot = null;
        if (Math.random() < 1.0) { // (í…ŒìŠ¤íŠ¸ìš© 100%, ë‚˜ì¤‘ì— 0.05ë¡œ ë°”ê¾¸ì„¸ìš”)
            game.pendingLoot = getRandomItem();
            game.winMsg += `<br>âœ¨ ì „ë¦¬í’ˆì´ ë°”ë‹¥ì— ë–¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.`;
        }
        
        updateUI(); // ê²½í—˜ì¹˜ë°”/ê³¨ë“œ ê°±ì‹ 

        // 4. ìŠ¹ë¦¬ íŒì—… ê·¸ë¦¬ê¸° (ì—¬ê¸°ì„œ ë²„íŠ¼ ë“±ì„ ê²°ì •í•¨)
        renderWinPopup(); 
        
        return true;
    }
    return false;
}
/* --- ì´ë²¤íŠ¸ ë° ìƒì  --- */
/* [ìˆ˜ì •] runRandomEvent í•¨ìˆ˜ */
function runRandomEvent() {
    if (game.forceRest) {
        game.forceRest = false;
        
        game.hasRested = false; // [NEW] íœ´ì‹ ì—¬ë¶€ ì´ˆê¸°í™”
        renderRestScreen();
        return;
    }

    let rand = Math.random();
    if (rand < 0.6) {
        startBattle();
    } else if (rand < 0.8) {
        game.hasRested = false; // [NEW] íœ´ì‹ ì—¬ë¶€ ì´ˆê¸°í™”
        renderRestScreen();
    } else {
        renderShopScreen();
    }
}
/* [ìˆ˜ì •] renderRestScreen í•¨ìˆ˜ ì „ì²´ êµì²´ */
function renderRestScreen() {
    switchScene('event');
    const container = document.getElementById('event-content-box');
    
    // íœ´ì‹ ë²„íŠ¼ HTML ìƒì„± (ìƒíƒœì— ë”°ë¼ ë‹¤ë¦„)
    let restBtnHTML = "";
    if (!game.hasRested) {
        // ì•„ì§ íœ´ì‹ ì•ˆ í•¨: ë²„íŠ¼ í™œì„±í™”
        restBtnHTML = `<button class="action-btn" onclick="restAction()">ğŸ˜´ ì‰¬ê¸° (50% íšŒë³µ)</button>`;
    } else {
        // ì´ë¯¸ íœ´ì‹ í•¨: ë²„íŠ¼ ëŒ€ì‹  í…ìŠ¤íŠ¸ í‘œì‹œ
        restBtnHTML = `<button class="action-btn" disabled style="background:#555; cursor:default;">âœ… íœ´ì‹ ì™„ë£Œ</button>`;
    }

    container.innerHTML = `
        <div class="event-title">ğŸ”¥ íœ´ì‹ì²˜</div>
        <div class="event-desc">
            ë”°ëœ»í•œ ëª¨ë‹¥ë¶ˆì´ ìˆìŠµë‹ˆë‹¤.<br>
            ì ì‹œ ì‰¬ì–´ê°€ê±°ë‚˜ ì •ë¹„ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>
            <span style="color:#e74c3c">í˜„ì¬ HP: ${player.hp} / ${player.maxHp}</span>
        </div>
        
        <div style="display:flex; justify-content:center; gap:20px;">
            ${restBtnHTML}
            <button class="action-btn" style="background:#7f8c8d" onclick="startBattle()">ğŸ‘£ ë– ë‚˜ê¸°</button>
        </div>
        
        <div style="margin-top:20px; font-size:0.9em; color:#aaa;">
            (ë– ë‚˜ê¸° ì „ì— ì¸ë²¤í† ë¦¬ì˜ ì•„ì´í…œì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
        </div>
    `;
}
/* [ìˆ˜ì •] restAction í•¨ìˆ˜ ì „ì²´ êµì²´ */
function restAction() {
    // 1. íšŒë³µ ë¡œì§
    let maxHeal = Math.floor(player.maxHp / 2);
    let missingHp = player.maxHp - player.hp;
    let actualHeal = Math.min(maxHeal, missingHp);
    
    player.hp += actualHeal;
    game.hasRested = true; // [NEW] íœ´ì‹ ì™„ë£Œ í”Œë˜ê·¸ ì„¸íŒ…
    
    updateUI();
    
    // 2. íŒì—…ì„ ë„ìš°ë˜, í™•ì¸ ëˆ„ë¥´ë©´ 'ë– ë‚˜ê¸°'ê°€ ì•„ë‹ˆë¼ íŒì—…ë§Œ ë‹«í˜
    showPopup("íœ´ì‹ ì™„ë£Œ", `ì²´ë ¥ì´ ${actualHeal}ë§Œí¼ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì´ì œ ì¶œë°œ ì¤€ë¹„ê°€ ë˜ì…¨ë‚˜ìš”?`, [
        {
            txt: "í™•ì¸", 
            func: () => {
                closePopup();
                renderRestScreen(); // [NEW] ë²„íŠ¼ ìƒíƒœ ê°±ì‹ ì„ ìœ„í•´ í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            }
        }
    ]);
}
function renderShopScreen() {
    switchScene('event');
    let saleCard = getRandomCard(); 
    let cardData = CARD_DATA[saleCard]; 
    let shopRelic = getRandomItem('relic'); 
    let shopConsumable = getRandomItem('consumable');

    document.getElementById('event-content-box').innerHTML = `
        <div class="event-title">ğŸ’° ìƒì¸</div>
        <div class="event-desc">"ê³¨ë¼ë³´ê²Œë‚˜."<br><span style="color:#f1c40f">ê³¨ë“œ: ${player.gold}</span></div>
        <div class="shop-items">
            <div class="shop-item" onclick="buyShopItem(this, 'card', '${saleCard}', 1000)">
                <div class="card">
                    <div class="card-cost">${cardData.cost}</div>
                    <div class="card-rank">${"â˜…".repeat(cardData.rank)}</div>
                    <div class="card-name">${saleCard}</div>
                    <div class="card-desc">${applyTooltip(cardData.desc)}</div>
                </div>
                <div class="shop-price">1000ì›</div>
            </div>

            <div class="shop-item" onclick="buyShopItem(this, 'relic', '${shopRelic}', ${ITEM_DATA[shopRelic].price})">
                <div class="item-icon item-relic item-rank-${ITEM_DATA[shopRelic].rank}" style="width:80px; height:80px; font-size:2em;">
                    ${ITEM_DATA[shopRelic].icon}
                    <span class="tooltip"><b>${shopRelic}</b><br>${ITEM_DATA[shopRelic].desc}</span>
                </div>
                <div class="shop-price">${ITEM_DATA[shopRelic].price}ì›</div>
                <div style="font-size:0.8em; margin-top:5px;">${shopRelic}</div>
            </div>
            <div class="shop-item" onclick="buyShopItem(this, 'consumable', '${shopConsumable}', ${ITEM_DATA[shopConsumable].price})">
                <div class="item-icon item-consumable item-rank-${ITEM_DATA[shopConsumable].rank}" style="width:80px; height:80px; font-size:2em;">
                    ${ITEM_DATA[shopConsumable].icon}
                    <span class="tooltip"><b>${shopConsumable}</b><br>${ITEM_DATA[shopConsumable].desc}</span>
                </div>
                <div class="shop-price">${ITEM_DATA[shopConsumable].price}ì›</div>
                <div style="font-size:0.8em; margin-top:5px;">${shopConsumable}</div>
            </div>
        </div>
        <button class="action-btn" style="background:#7f8c8d" onclick="startBattle()">ğŸ‘£ ë‚˜ê°€ê¸°</button>`;
}
function buyShopItem(el, type, name, cost) {
    if (el.classList.contains('sold-out')) return;
    if (player.gold < cost) { showPopup("êµ¬ë§¤ ì‹¤íŒ¨", "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", [{txt:"í™•ì¸", func: closePopup}]); return; }
    if (type === 'relic' && player.relics.includes(name)) { showPopup("êµ¬ë§¤ ë¶ˆê°€", "ì´ë¯¸ ë³´ìœ  ì¤‘ì…ë‹ˆë‹¤.", [{txt:"í™•ì¸", func: closePopup}]); return; }
    player.gold -= cost; el.classList.add('sold-out');
    if (type === 'card') { player.deck.push(name); showPopup("ì„±ê³µ", `[${name}] êµ¬ë§¤ ì™„ë£Œ.`, [{txt:"í™•ì¸", func: closePopup}]); }
    else { addItem(name); showPopup("ì„±ê³µ", `[${name}] êµ¬ë§¤ ì™„ë£Œ.`, [{txt:"í™•ì¸", func: closePopup}]); }
    updateUI();
}

/* --- ìœ í‹¸ë¦¬í‹° ë° ê³„ì‚° --- */
function getStat(entity, type) {
    let val = (type==='atk')? entity.baseAtk : (type==='def')? entity.baseDef : entity.baseSpd;
    if (entity === player) { if (type === 'atk' && player.relics.includes("ì¿ ë³´íƒ„")) val += 1; if (type === 'def' && player.relics.includes("ê°•ì¸í•¨ì˜ ë¶€ì ")) val += 1; if (type === 'spd' && player.relics.includes("ì¢‹ì€ ìš´ë™í™”")) val += 1; }
    if (type==='atk') { if (entity.buffs["ì•½í™”"]) val /= 2; if (entity.buffs["ê°•í™”"]) val *= 2; } else if (type==='def') { if (entity.buffs["ì·¨ì•½"]) val /= 2; if (entity.buffs["ê±´ê°•"]) val *= 2; } else if (type==='spd') { if (entity.buffs["ë§ˆë¹„"]) val /= 2; if (entity.buffs["ì¾Œì†"]) val *= 2; }
    return Math.floor(val);
}
function applyBuff(entity, name, dur) { if (name === "ë…" || name === "í™œë ¥") entity.buffs[name] = (entity.buffs[name] || 0) + dur; else entity.buffs[name] = dur; log(`âœ¨ ${entity===player?"ë‚˜":"ì "}ì—ê²Œ [${name}] ì ìš©`); }
function tickBuffs(entity) {
    if (entity.buffs["ë…"]) { let dmg = entity.buffs["ë…"]; log(`â˜ ï¸ ë… í”¼í•´ ${dmg}!`); takeDamage(entity, dmg); }
    if (entity.buffs["í™œë ¥"]) { let heal = entity.buffs["í™œë ¥"]; entity.hp = Math.min(entity.maxHp, entity.hp + heal); log(`ğŸŒ¿ í™œë ¥ íšŒë³µ +${heal}`); updateUI(); }
}
function decrementBuffs(entity) { for (let k in entity.buffs) { entity.buffs[k]--; if (entity.buffs[k] <= 0) delete entity.buffs[k]; } }
function addRandomCard(rank) { let pool = Object.keys(CARD_DATA).filter(k => CARD_DATA[k].rank === rank); player.deck.push(pool[Math.floor(Math.random() * pool.length)]); }
function getRandomCard() { let r = Math.random()*100; let rank = (r<70)?1:(r<95)?2:3; let pool = Object.keys(CARD_DATA).filter(k => CARD_DATA[k].rank === rank); return pool[Math.floor(Math.random()*pool.length)]; }
function getRandomItem(typeFilter) { let pool = Object.keys(ITEM_DATA); if (typeFilter) pool = pool.filter(k => ITEM_DATA[k].type === typeFilter); let r=Math.random()*100; let rank=(r<70)?1:(r<90)?2:3; let rankPool=pool.filter(k=>ITEM_DATA[k].rank===rank); if(rankPool.length===0) rankPool=pool; return rankPool[Math.floor(Math.random()*rankPool.length)]; }

/* --- UI Render Helpers --- */
/* [ìˆ˜ì •] drawCards í•¨ìˆ˜: ìµœëŒ€ 10ì¥ ì œí•œ ì¶”ê°€ */
function drawCards(n) {
    const MAX_HAND_SIZE = 10; // ìµœëŒ€ í•¸ë“œ ë§¤ìˆ˜ ì„¤ì •

    for(let i=0; i<n; i++) {
        // 1. í•¸ë“œê°€ ê°€ë“ ì°¼ëŠ”ì§€ í™•ì¸
        if (player.hand.length >= MAX_HAND_SIZE) {
            log("ğŸš« ì†íŒ¨ê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 10ì¥)");
            break; // ë°˜ë³µë¬¸ ì¦‰ì‹œ ì¢…ë£Œ
        }

        // 2. ë±/ë²„ë¦° ì¹´ë“œ í™•ì¸ ë° ë½‘ê¸°
        if (player.drawPile.length === 0) {
            if (player.discardPile.length > 0) { 
                log("ğŸ”„ ë± ë¦¬í•„!"); 
                player.drawPile = [...player.discardPile]; 
                player.discardPile = []; 
                shuffle(player.drawPile); 
            }
            else break; 
        }
        
        if (player.drawPile.length > 0) {
            player.hand.push(player.drawPile.pop());
        }
    }
    renderHand(); 
    updateUI();
}

function updateUI() {
   // 1. ìƒë‹¨ ì •ë³´ (ë ˆë²¨ | ê²½í—˜ì¹˜ | ê³¨ë“œ)
    // ê²½í—˜ì¹˜ í¼ì„¼íŠ¸ ê³„ì‚°
    let xpPercent = Math.floor((player.xp / player.maxXp) * 100);
    
    document.getElementById('game-info').innerHTML = 
        `Lv.${game.level} <span style="font-size:0.8em; color:#aaa;">(${player.xp}/${player.maxXp})</span> | ğŸ’° ${player.gold}ì›
         <div style="width:100%; height:4px; background:#444; margin-top:5px; border-radius:2px;">
            <div style="width:${xpPercent}%; height:100%; background:#3498db; transition: width 0.3s;"></div>
         </div>`;
    document.getElementById('p-hp').innerText = player.hp; document.getElementById('p-max-hp').innerText = player.maxHp; document.getElementById('p-block').innerText = player.block; document.getElementById('p-hp-bar').style.width = Math.max(0, (player.hp/player.maxHp)*100) + "%"; document.getElementById('p-stats').innerText = `ê³µ${getStat(player,'atk')} ë°©${getStat(player,'def')} ì†${getStat(player,'spd')}`;
    document.getElementById('p-buffs').innerHTML = applyTooltip(Object.entries(player.buffs).map(([k,v])=>`${k}(${v})`).join(', '));
    document.getElementById('e-hp').innerText = enemy.hp; document.getElementById('e-max-hp').innerText = enemy.maxHp; document.getElementById('e-block').innerText = enemy.block; document.getElementById('e-hp-bar').style.width = Math.max(0, (enemy.hp/enemy.maxHp)*100) + "%"; document.getElementById('e-stats').innerText = `ê³µ${getStat(enemy,'atk')} ë°©${getStat(enemy,'def')} ì†${getStat(enemy,'spd')}`;
    document.getElementById('e-buffs').innerHTML = applyTooltip(Object.entries(enemy.buffs).map(([k,v])=>`${k}(${v})`).join(', '));
    
    document.getElementById('btn-draw-pile').innerText = `ë± (${player.drawPile.length})`;
    document.getElementById('btn-discard-pile').innerText = `ë²„ë¦¼ (${player.discardPile.length})`;
    // [NEW] ì†Œë©¸ UI ì—…ë°ì´íŠ¸
    /* [ìˆ˜ì •] updateUI í•¨ìˆ˜ ì•ˆì—ì„œ ì´ ì¤„ì„ ì°¾ì•„ êµì²´í•˜ì„¸ìš” (ì´ëª¨ì§€ ì œê±°) */
document.getElementById('btn-exhaust-pile').innerText = `ì†Œë©¸ (${player.exhaustPile.length})`;
    
    updateInventoryUI();
}

/* [ìˆ˜ì •] renderHand: ê²¹ì¹˜ê¸° ëª¨ë“œ + ë“œë˜ê·¸ ì¡°ì¤€ í†µí•© */
function renderHand() {
    const container = document.getElementById('hand-container'); 
    container.innerHTML = "";
    
    // 1. [ê²¹ì¹˜ê¸° ëª¨ë“œ] ì¹´ë“œê°€ 6ì¥ ì´ìƒì´ë©´ compact í´ë˜ìŠ¤ ì¶”ê°€
    if (player.hand.length >= 6) {
        container.classList.add('compact');
    } else {
        container.classList.remove('compact');
    }

    player.hand.forEach((cName, idx) => {
        let data = CARD_DATA[cName];
        let el = document.createElement('div'); 
        el.className = 'card';
        // ë“œë˜ê·¸ ìœ„ì¹˜ ê³„ì‚°ì„ ìœ„í•´ ID ë¶€ì—¬
        el.id = `card-el-${idx}`;
        
        if (player.ap < data.cost || game.turnOwner !== "player") el.className += " disabled";
        
        // ì¹´ë“œ ë‚´ìš© (ë³„ ë“±ê¸‰ í¬í•¨)
        el.innerHTML = `
            <div class="card-cost">${data.cost}</div>
            <div class="card-rank">${"â˜…".repeat(data.rank)}</div>
            <div class="card-name">${cName}</div>
            <div class="card-desc">${applyTooltip(data.desc)}</div>
        `;
        
        // 2. [ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì—°ê²°]
        // í–‰ë™ë ¥ì´ ì¶©ë¶„í•˜ê³  ë‚´ í„´ì¼ ë•Œë§Œ ë“œë˜ê·¸ ê°€ëŠ¥
        if (game.turnOwner === "player" && player.ap >= data.cost) {
            el.onmousedown = (e) => startDrag(e, idx, cName);
        } else {
            // ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì¹´ë“œëŠ” í´ë¦­ ì‹œ í”¼ë“œë°±
            el.onclick = () => log("ğŸš« ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.");
        }
        
        container.appendChild(el);
    });
}

// [ìˆ˜ì •ë¨] openPileView: ëª©ë¡ ì°½ì—ì„œë„ ì¼ë°˜ ì¹´ë“œì²˜ëŸ¼ ë³´ì´ê²Œ ìˆ˜ì •
function openPileView(type) {
    const title = document.getElementById('popup-title'); const content = document.getElementById('popup-content'); const btns = document.getElementById('popup-buttons');
    content.innerHTML = ""; btns.innerHTML = "<button class='action-btn' onclick='closePopup()'>ë‹«ê¸°</button>";
    
    let sourceArray;
    if (type === 'draw') sourceArray = [...player.drawPile].sort();
    else if (type === 'discard') sourceArray = player.discardPile;
    else if (type === 'exhaust') sourceArray = player.exhaustPile;

    let typeText = (type==='draw')?'ë‚¨ì€ ë±':(type==='discard')?'ë²„ë¦° ì¹´ë“œ':'ì†Œë©¸ëœ ì¹´ë“œ';
    title.innerText = `${typeText} (${sourceArray.length}ì¥)`;
    document.getElementById('popup-desc').innerText = "ì¹´ë“œ ëª©ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤.";
    if (sourceArray.length === 0) content.innerHTML = "<div style='padding:20px; color:#777;'>ë¹„ì–´ìˆìŒ</div>";
    else {
        let listDiv = document.createElement('div'); listDiv.className = 'pile-list';
        sourceArray.forEach(cName => {
            let data = CARD_DATA[cName]; let el = document.createElement('div'); el.className = 'mini-card';
            
            // [ìˆ˜ì •] ë¯¸ë‹ˆ ì¹´ë“œì—ë„ ë³„ ì¶”ê°€
            el.innerHTML = `
                <div>${data.cost} <span style="color:#f1c40f">${"â˜…".repeat(data.rank)}</span></div>
                <b>${cName}</b>
                <div>${applyTooltip(data.desc)}</div>
            `; 
            listDiv.appendChild(el);
        }); content.appendChild(listDiv);
    }
    document.getElementById('popup-layer').style.display = 'flex';
}

function showPopup(title, desc, buttons, contentHTML = "") {
    const layer = document.getElementById('popup-layer'); document.getElementById('popup-title').innerText = title; document.getElementById('popup-desc').innerHTML = desc; document.getElementById('popup-content').innerHTML = contentHTML;
    const btnBox = document.getElementById('popup-buttons'); btnBox.innerHTML = "";
    buttons.forEach(b => { let btn = document.createElement('button'); btn.className = 'action-btn'; btn.style.fontSize = "1em"; btn.style.padding = "5px 15px"; btn.innerText = b.txt; btn.onclick = b.func; btnBox.appendChild(btn); });
    layer.style.display = "flex";
}
function showLevelUp() {
    // game.level++;  <-- [ì‚­ì œ] ì´ ì¤„ì„ ì°¾ì•„ì„œ ì§€ìš°ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”!
    
    showPopup("ğŸ†™ ë ˆë²¨ ì—…!", "ì˜¬ë¦´ ìŠ¤íƒ¯ì„ ì„ íƒí•˜ì„¸ìš”.", [
        {txt: "ê³µê²©ë ¥ +1", func: ()=> { player.baseAtk++; getCardReward(); }},
        {txt: "ë°©ì–´ë ¥ +1", func: ()=> { player.baseDef++; getCardReward(); }},
        {txt: "ì†ë„ +1", func: ()=> { player.baseSpd++; getCardReward(); }}
    ]);
}
function getCardReward() {
    let newCard = getRandomCard(); 
    let data = CARD_DATA[newCard];
    
    // [ìˆ˜ì •] ë³´ìƒ ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸°ì—ë„ ë³„ ì¶”ê°€
    let cardHTML = `
    <div style="display:flex; justify-content:center; margin:10px;">
        <div class="card">
            <div class="card-cost">${data.cost}</div>
            <div class="card-rank">${"â˜…".repeat(data.rank)}</div>
            <div class="card-name">${newCard}</div>
            <div class="card-desc">${applyTooltip(data.desc)}</div>
        </div>
    </div>`;
    
    showPopup("ğŸ ì¹´ë“œ ë³´ìƒ", "íšë“í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [{txt: "ë°›ê¸°", func: ()=>{player.deck.push(newCard); runRandomEvent();}}, {txt: "ê±´ë„ˆë›°ê¸°", func: runRandomEvent}], cardHTML);
}
function closePopup() { document.getElementById('popup-layer').style.display = "none"; }

initGame();

/* [ì¶”ê°€] script íƒœê·¸ ë§¨ ì•„ë˜ìª½ì´ë‚˜ ì ì ˆí•œ ê³³ì— ì¶”ê°€í•˜ì„¸ìš” */

// ë ˆë²¨ì—… ì²˜ë¦¬ ë¡œì§
function processLevelUp() {
    player.xp -= player.maxXp; // ê²½í—˜ì¹˜ ì°¨ê° (ì˜¤ë²„í”Œë¡œìš° ëœ ê²½í—˜ì¹˜ëŠ” ìœ ì§€ë¨)
    game.level++;
    
    // [NEW] ë‹¤ìŒ ë ˆë²¨ í•„ìš” ê²½í—˜ì¹˜ ê³µì‹ (ë ˆë²¨ * 100)
    // ì˜ˆ: 1->2 (100xp), 2->3 (200xp), 3->4 (300xp) ...
    player.maxXp = game.level * 100;
    
    // ê¸°ì¡´ ìŠ¤íƒ¯ ì„ íƒ íŒì—… í˜¸ì¶œ
    showLevelUp(); 
}

// ìŠ¹ë¦¬ í›„ (ë ˆë²¨ì—… ì—†ì„ ë•Œ) ì´ë™ ë¡œì§
function nextStepAfterWin() {
    // ë ˆë²¨ì—…ì„ ì•ˆ í–ˆìœ¼ë©´ ë°”ë¡œ ëœë¤ ì´ë²¤íŠ¸ë¡œ ì´ë™
    runRandomEvent();
}
/* [ì¶”ê°€] ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ í•¨ìˆ˜ */
function playAnim(elementId, animClass) {
    const el = document.getElementById(elementId);
    
    // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±° (ì—°ì† ì¬ìƒì„ ìœ„í•´)
    el.classList.remove('anim-atk-p', 'anim-atk-e', 'anim-hit', 'anim-bounce');
    
    // ê°•ì œ ë¦¬í”Œë¡œìš° (ë¸Œë¼ìš°ì €ê°€ ë³€ê²½ì‚¬í•­ì„ ì¦‰ì‹œ ì¸ì‹í•˜ê²Œ í•¨)
    void el.offsetWidth;
    
    // ìƒˆ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì¶”ê°€
    el.classList.add(animClass);
    
    // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚˜ë©´ í´ë˜ìŠ¤ ì œê±° (ê¹”ë”í•˜ê²Œ)
    setTimeout(() => {
        el.classList.remove(animClass);
    }, 600); // ê°€ì¥ ê¸´ ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„(0.6s)ì— ë§ì¶¤
}
/* --- [ì¶”ê°€] ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œìŠ¤í…œ --- */

function saveGame() {
    // 1. ì €ì¥í•  ë°ì´í„° ë¬¶ê¸°
    const saveData = {
        playerData: player,       // í”Œë ˆì´ì–´ì˜ ëª¨ë“  ì •ë³´ (ë±, ì²´ë ¥, ì•„ì´í…œ ë“±)
        gameLevel: game.level     // í˜„ì¬ ë ˆë²¨
    };

    // 2. ë¸Œë¼ìš°ì € ì €ì¥ì†Œ(Local Storage)ì— 'myRPG_save'ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì €ì¥
    // ê°ì²´(Object)ëŠ” ì €ì¥ ëª» í•˜ë¯€ë¡œ JSON.stringifyë¡œ ë¬¸ìì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
    localStorage.setItem('myRPG_save', JSON.stringify(saveData));

    // 3. ì•Œë¦¼
    alert("ê²Œì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ ìœ ì§€ë©ë‹ˆë‹¤)");
}

function loadGame() {
    // 1. ì €ì¥ì†Œì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const saveString = localStorage.getItem('myRPG_save');

    // 2. ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
    if (!saveString) {
        alert("ì €ì¥ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // 3. ë°ì´í„° ë³µêµ¬
    try {
        const loadedData = JSON.parse(saveString); // ë¬¸ìì—´ì„ ë‹¤ì‹œ ê°ì²´ë¡œ ë³€í™˜

        // ë°ì´í„° ë®ì–´ì“°ê¸°
        player = loadedData.playerData;
        game.level = loadedData.gameLevel;

        // [ì¤‘ìš”] ë¶ˆëŸ¬ì˜¨ ë’¤, í˜„ì¬ ë ˆë²¨ì˜ ì „íˆ¬ë¥¼ 'ì²˜ìŒë¶€í„°' ë‹¤ì‹œ ì‹œì‘
        // (ì „íˆ¬ ì¤‘ê°„ ìƒíƒœê¹Œì§€ ì™„ë²½í•˜ê²Œ ì €ì¥í•˜ëŠ” ê±´ ë§¤ìš° ë³µì¡í•˜ë¯€ë¡œ, ì²´í¬í¬ì¸íŠ¸ ë°©ì‹ ì‚¬ìš©)
        alert(`Lv.${game.level} ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
        
        // UI ê°±ì‹  ë° ì „íˆ¬ ì¬ì‹œì‘
        updateUI();
        startBattle(); 

    } catch (e) {
        console.error(e);
        alert("ì„¸ì´ë¸Œ íŒŒì¼ì´ ì†ìƒë˜ì–´ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
}
/* [NEW] ìŠ¹ë¦¬ íŒì—…ì„ ìƒí™©ì— ë§ì¶° ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜ */
function renderWinPopup() {
    let btns = [];
    let contentHTML = "";

    // 1. [ì•„ì´í…œ ì¤ê¸° ë²„íŠ¼] - ì•„ì§ ì¤ì§€ ì•Šì€ ì•„ì´í…œì´ ìˆë‹¤ë©´
    if (game.pendingLoot) {
        let loot = game.pendingLoot;
        let lData = ITEM_DATA[loot];
        
        // ì•„ì´í…œ ì •ë³´ í‘œì‹œ
        contentHTML = `
            <div style="display:flex; justify-content:center; margin-top:15px;">
                <div class="item-icon item-${lData.type} item-rank-${lData.rank}">
                    ${lData.icon}
                    <span class="tooltip"><b>${loot}</b><br>${lData.desc}</span>
                </div>
            </div>
            <div style="margin-top:5px; font-size:0.9em; color:#aaa;">${loot}</div>
        `;
        
        // [ì¤‘ìš”] ì•„ì´í…œ ì¤ê¸° ë²„íŠ¼: ì¤ê³  ë‚˜ì„œ 'renderWinPopup'ì„ ë‹¤ì‹œ í˜¸ì¶œí•¨ (íŒì—… ìœ ì§€)
        btns.push({ 
            txt: "ì•„ì´í…œ ì¤ê¸°", 
            func: () => getLoot() 
        });
    }

    // 2. [ë ˆë²¨ì—… ë²„íŠ¼] - ê²½í—˜ì¹˜ê°€ ê½‰ ì°¼ë‹¤ë©´
    if (player.xp >= player.maxXp) {
        btns.push({ 
            txt: "ğŸ†™ ë ˆë²¨ì—…!", 
            func: processLevelUp 
        });
    }

    // 3. [ë– ë‚˜ê¸° ë²„íŠ¼] - ì–¸ì œë‚˜ ì¡´ì¬ (ì„ íƒì§€ ì œê³µ)
    // ë ˆë²¨ì—…ì´ ê°€ëŠ¥í•´ë„, ì§€ê¸ˆ ì•ˆ í•˜ê³  ë‚˜ì¤‘ì— í•˜ê±°ë‚˜ ê·¸ëƒ¥ ë– ë‚  ìˆ˜ë„ ìˆê²Œ í•¨
    btns.push({ 
        txt: "ë– ë‚˜ê¸°", 
        func: nextStepAfterWin 
    });

    // íŒì—… í‘œì‹œ
    // (ë ˆë²¨ì—… ê°€ëŠ¥í•˜ë©´ ë©”ì‹œì§€ì— ê°•ì¡° í‘œì‹œ)
    let finalMsg = game.winMsg;
    if (player.xp >= player.maxXp) finalMsg += `<br><b style="color:#f1c40f">ğŸ†™ ë ˆë²¨ ì—… ê°€ëŠ¥!</b>`;

    showPopup("ì „íˆ¬ ìŠ¹ë¦¬!", finalMsg, btns, contentHTML);
}

/* [NEW] ì•„ì´í…œ íšë“ ì²˜ë¦¬ í•¨ìˆ˜ */
function getLoot() {
    if (game.pendingLoot) {
        addItem(game.pendingLoot); // ì¸ë²¤í† ë¦¬ì— ì¶”ê°€
        
        // ë©”ì‹œì§€ ê°±ì‹ 
        game.winMsg = game.winMsg.replace("ì „ë¦¬í’ˆì´ ë°”ë‹¥ì— ë–¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.", "");
        game.winMsg += `<br><span style="color:#2ecc71">âœ” [${game.pendingLoot}] íšë“í•¨.</span>`;
        
        game.pendingLoot = null; // ë°”ë‹¥ì—ì„œ ì¹˜ì›€
        
        updateUI(); // ì¸ë²¤í† ë¦¬ ê°±ì‹ 
        renderWinPopup(); // [í•µì‹¬] íŒì—… ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì´ì œ ì¤ê¸° ë²„íŠ¼ì€ ì‚¬ë¼ì§)
    }
}
/* --- [NEW] ë“œë˜ê·¸ íƒ€ê²ŸíŒ… & ë¯¸ë¦¬ë³´ê¸° ì‹œìŠ¤í…œ --- */

let drag = { active: false, cardIdx: -1, cardName: "", startX: 0, startY: 0, originalDesc: "" };

function startDrag(e, idx, cName) {
    if (e.button !== 0) return; // ì¢Œí´ë¦­ë§Œ í—ˆìš©
    e.preventDefault();

    drag.active = true;
    drag.cardIdx = idx;
    drag.cardName = cName;
    
    let cardEl = document.getElementById(`card-el-${idx}`);
    let rect = cardEl.getBoundingClientRect();
    drag.startX = rect.left + rect.width / 2;
    drag.startY = rect.top + rect.height / 2;
    
    let descEl = cardEl.querySelector('.card-desc');
    drag.originalDesc = descEl.innerHTML;

    document.getElementById('drag-layer').style.display = 'block';
    
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', onDragEnd);
}

function onDragMove(e) {
    if (!drag.active) return;

    const path = document.getElementById('drag-path');
    const head = document.getElementById('drag-head');
    
    let endX = e.clientX;
    let endY = e.clientY;
    
    // ë² ì§€ì–´ ê³¡ì„  (Sì)
    let cpX = (drag.startX + endX) / 2;
    let cpY = Math.min(drag.startY, endY) - 100;
    
    path.setAttribute("d", `M${drag.startX},${drag.startY} Q${cpX},${cpY} ${endX},${endY}`);
    head.setAttribute("cx", endX);
    head.setAttribute("cy", endY);

    // íƒ€ê²Ÿ ê°ì§€ ë° ë¯¸ë¦¬ë³´ê¸°
    let target = getTargetUnderMouse(e);
    let cardEl = document.getElementById(`card-el-${drag.cardIdx}`);
    let descEl = cardEl.querySelector('.card-desc');

    if (target) {
        let newDesc = calcPreview(drag.cardName, player, target);
        descEl.innerHTML = `<span style="color:#2ecc71; font-weight:bold;">${newDesc}</span>`;
        cardEl.style.transform = "scale(1.1)";
        cardEl.style.zIndex = "100";
    } else {
        descEl.innerHTML = drag.originalDesc;
        cardEl.style.transform = "scale(1.0)";
        cardEl.style.zIndex = "auto";
    }
}

function onDragEnd(e) {
    if (!drag.active) return;
    
    document.removeEventListener('mousemove', onDragMove);
    document.removeEventListener('mouseup', onDragEnd);
    document.getElementById('drag-layer').style.display = 'none';
    
    let target = getTargetUnderMouse(e);
    let cardEl = document.getElementById(`card-el-${drag.cardIdx}`);
    
    if (cardEl) {
        let descEl = cardEl.querySelector('.card-desc');
        descEl.innerHTML = drag.originalDesc;
        cardEl.style.transform = "scale(1.0)";
        cardEl.style.zIndex = "auto";
    }

    if (target) {
        let data = CARD_DATA[drag.cardName];
        player.ap -= data.cost;
        
        let usedCard = player.hand.splice(drag.cardIdx, 1)[0];
        if (data.isExhaust) {
            player.exhaustPile.push(usedCard);
            log(`ğŸš« [${drag.cardName}] ì†Œë©¸ë¨!`);
        } else {
            player.discardPile.push(usedCard);
        }

        useCard(player, target, drag.cardName);
        
        renderHand();
        document.getElementById('turn-info').innerText = `ë‚˜ì˜ í„´ (AP: ${player.ap})`;
        updateUI();
        checkGameOver();
    }

    drag.active = false;
    drag.cardIdx = -1;
}

function getTargetUnderMouse(e) {
    let el = document.elementFromPoint(e.clientX, e.clientY);
    if (!el) return null;

    let targetDiv = el.closest('.character');
    if (!targetDiv) return null;

    let data = CARD_DATA[drag.cardName];
    
    if (data.type.includes("attack")) {
        if (targetDiv.id === "enemy-char") return enemy;
    } else {
        if (targetDiv.id === "player-char") return player;
    }
    return null;
}

function calcPreview(cardName, user, target) {
    let data = CARD_DATA[cardName];
    let atk = getStat(user, 'atk');
    let def = getStat(user, 'def');
    let text = data.desc;
    
    if (data.dmg) {
        let baseDmg = data.dmg + atk;
        text = text.replace(new RegExp(`${data.dmg} í”¼í•´`), `<b>${baseDmg} í”¼í•´</b>`);
    }
    if (data.block) {
        let baseBlock = data.block + def;
        // ì •ê·œì‹ íŠ¹ìˆ˜ë¬¸ì(+) ì²˜ë¦¬
        text = text.replace(new RegExp(`ë°©ì–´ë„ \\+${data.block}`), `<b>ë°©ì–´ë„ +${baseBlock}</b>`);
    }
    return text;
}
</script>
<svg id="drag-layer" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; display:none;">
    <path id="drag-path" d="" stroke="#f1c40f" stroke-width="4" fill="none" stroke-dasharray="10,5" stroke-linecap="round" />
    <circle id="drag-head" cx="0" cy="0" r="8" fill="#e74c3c" stroke="#fff" stroke-width="2" />
</svg>
</body>
</html>