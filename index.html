<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Slay the Spire-like RPG (Exhaust Update)</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: #222; color: #eee; text-align: center; user-select: none; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; position: relative; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* ìƒë‹¨ ë°” */
        .top-bar { display: flex; justify-content: space-between; margin-bottom: 10px; background: #333; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 10; }
        
        /* ì¸ë²¤í† ë¦¬ ì˜ì—­ */
        .inventory-area { background: #2c3e50; padding: 10px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; min-height: 50px; border: 1px solid #444; }
        .inv-label { font-size: 0.8em; color: #aaa; margin-right: 5px; }
        .item-list { display: flex; gap: 5px; flex-wrap: wrap; }
        .item-icon { 
            width: 40px; height: 40px; border-radius: 4px; display: flex; justify-content: center; align-items: center; 
            font-size: 1.2em; cursor: pointer; position: relative; border: 2px solid #555; transition: 0.2s;
        }
        .item-icon:hover { transform: scale(1.1); z-index: 5; }
        .item-relic { background: #e67e22; border-color: #d35400; color: #fff; }
        .item-consumable { background: #27ae60; border-color: #2ecc71; color: #fff; }
        .item-rank-2 { box-shadow: 0 0 5px #3498db; }
        .item-rank-3 { box-shadow: 0 0 8px #f1c40f; border-color: #f1c40f; }

        /* íˆ´íŒ */
        .tooltip { 
            visibility: hidden; 
            width: 160px; /* í­ì„ ì‚´ì§ ë„“í˜ */
            background-color: #111; 
            color: #fff; 
            text-align: center; 
            border-radius: 6px; 
            padding: 10px; /* ì—¬ë°±ì„ ì¢€ ë” ì¤Œ */
            
            position: absolute; 
            top: 120%; 
            left: 50%; 
            margin-left: -80px; /* widthì˜ ì ˆë°˜ */
            z-index: 1000; 
            
            /* [í•µì‹¬ ìˆ˜ì •] em ëŒ€ì‹  pxë¥¼ ì‚¬ìš©í•˜ì—¬ í¬ê¸°ë¥¼ ê³ ì •í•¨ */
            font-size: 13px; 
            font-weight: normal; /* ë¶€ëª¨ê°€ êµµê²Œ ì²˜ë¦¬ë˜ì–´ ìˆì–´ë„ íˆ´íŒì€ ì–‡ê²Œ */
            line-height: 1.4;    /* ì¤„ ê°„ê²© í™•ë³´ */
            
            border: 1px solid #777; 
            opacity: 0; 
            transition: opacity 0.3s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.5); 
        }
        .item-icon:hover .tooltip { visibility: visible; opacity: 1; }

        /* ì¥ë©´(Scene) ê´€ë¦¬ */
        .scene { width: 100%; flex: 1; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* ì „íˆ¬ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .battle-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; min-height: 200px; }
/* [ìˆ˜ì •] ê¸°ì¡´ .character ìŠ¤íƒ€ì¼ì„ ì´ê±¸ë¡œ ë®ì–´ì”Œìš°ì„¸ìš” (ë°°ê²½ìƒ‰ ì œê±°, í…Œë‘ë¦¬ ì •ë¦¬) */
        .character { 
            width: 40%; 
            padding: 10px; 
            border-radius: 10px; 
            position: relative; 
            transition: 0.2s; 
            text-align: center;
            /* ë°°ê²½ìƒ‰ ì œê±° (ì´ë¯¸ì§€ ê°•ì¡°) */
        }
        /* í„´ í™œì„±í™” ì‹œ í…Œë‘ë¦¬ë§Œ ê°•ì¡° */
        .character.turn-active { 
            border: 2px solid #f1c40f; 
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); 
            background: rgba(255, 255, 255, 0.05); /* ì•„ì£¼ ì˜…ì€ ë°°ê²½ */
        }

        /* [ì¶”ê°€] ìºë¦­í„° ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .char-img {
            width: 120px;
            height: 120px;
            object-fit: cover; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ì›€ */
            border-radius: 10px;
            border: 2px solid #555;
            background: #000;
            margin-bottom: 5px;
        }

        /* [ì¶”ê°€] ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ ì •ì˜ */

        /* 1. ê³µê²© (ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì³¤ë‹¤ê°€ ë³µê·€ - í”Œë ˆì´ì–´ìš©) */
        @keyframes atk-p {
            0% { transform: translateX(0); }
            30% { transform: translateX(50px) scale(1.1); } /* ì•ìœ¼ë¡œ íŒ! */
            100% { transform: translateX(0); }
        }
        /* 1-2. ê³µê²© (ì™¼ìª½ìœ¼ë¡œ ì³¤ë‹¤ê°€ ë³µê·€ - ì ìš©) */
        @keyframes atk-e {
            0% { transform: translateX(0); }
            30% { transform: translateX(-50px) scale(1.1); }
            100% { transform: translateX(0); }
        }

        /* 2. í”¼ê²© (ë’¤ë¡œ ë°€ë ¸ë‹¤ê°€ ë³µê·€ + ë¹¨ê°„ ë²ˆì©ì„) */
        @keyframes hit-anim {
            0% { transform: translateX(0); filter: brightness(1); }
            20% { transform: translateX(-10px); filter: brightness(0.5) sepia(1) hue-rotate(-50deg) saturate(5); } /* ë¹¨ê°›ê²Œ */
            40% { transform: translateX(10px); } /* ëœëœ ë–¨ë¦¼ */
            60% { transform: translateX(-5px); }
            100% { transform: translateX(0); filter: brightness(1); }
        }

        /* 3. ìŠ¤í‚¬/ë²„í”„ (ìœ„ë¡œ ë‘ ë²ˆ ì½©ì½©) */
        @keyframes bounce-double {
            0% { transform: translateY(0); }
            25% { transform: translateY(-20px); } /* ì í”„ 1 */
            50% { transform: translateY(0); }
            75% { transform: translateY(-10px); } /* ì í”„ 2 (ì‘ê²Œ) */
            100% { transform: translateY(0); }
        }
                /* [ì¶”ê°€] ëŒ€ë¯¸ì§€ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .damage-number {
            position: absolute;
            top: 10%;           /* ìºë¦­í„° ë¨¸ë¦¬ ê·¼ì²˜ */
            left: 50%;
            transform: translateX(-50%);
            color: #ff3333;     /* ê°•ë ¬í•œ ë¹¨ê°„ìƒ‰ */
            font-size: 2.5em;   /* í¬ê²Œ! */
            font-weight: 900;   /* ì•„ì£¼ êµµê²Œ! */
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000; /* ê²€ì€ í…Œë‘ë¦¬ë¡œ ê°€ë…ì„± í™•ë³´ */
            z-index: 999;
            pointer-events: none; /* ë§ˆìš°ìŠ¤ í´ë¦­ ë°©í•´ ì•ˆ í•˜ê²Œ */
            animation: float-up 0.8s ease-out forwards;
        }

        /* [ì¶”ê°€] ìˆ«ìê°€ ìœ„ë¡œ ì˜¬ë¼ê°€ë©° ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes float-up {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -20px) scale(1.2); opacity: 1; } /* íŒ íŠ€ì–´ë‚˜ì˜´ */
            100% { transform: translate(-50%, -80px) scale(1); opacity: 0; }  /* ìœ„ë¡œ ì‚¬ë¼ì§ */
        }

        /* ì• ë‹ˆë©”ì´ì…˜ ì ìš© í´ë˜ìŠ¤ (JSì—ì„œ ë¶™ì˜€ë‹¤ ë—„ ê²ƒì„) */
        .anim-atk-p { animation: atk-p 0.4s ease-out; }
        .anim-atk-e { animation: atk-e 0.4s ease-out; }
        .anim-hit { animation: hit-anim 0.4s ease-in-out; }
        .anim-bounce { animation: bounce-double 0.6s ease-in-out; }
        .hp-bar-bg { background: #222; height: 20px; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #555; }
        .hp-bar-fill { background: #e74c3c; height: 100%; width: 100%; transition: 0.5s; }
        
       /* [ìˆ˜ì •] ì¹´ë“œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
     /* [ìˆ˜ì •] ì¹´ë“œ ì˜ì—­ (ì¤‘ì•™ ì •ë ¬ ë³µê·€ & ì˜ë¦¼ ë°©ì§€) */
        .hand-area { 
            display: flex; 
            
            /* 1. ë‹¤ì‹œ ì¤‘ì•™ ì •ë ¬ */
            justify-content: center; 
            
            /* 2. ì¤„ë°”ê¿ˆ í—ˆìš© (ê°€ë¡œ ìŠ¤í¬ë¡¤ ì œê±° -> ì˜ë¦¼ í˜„ìƒ í•´ê²°ë¨) */
            flex-wrap: wrap;       
            
            /* 3. ì¹´ë“œ ê°„ê²© ë° ì—¬ë°± ì¡°ì ˆ */
            gap: 10px;             
            margin-bottom: 5px;    /* ë²„íŠ¼ê³¼ì˜ ê±°ë¦¬ë¥¼ ì¢í˜ */
            padding: 10px;         /* ì¹´ë“œê°€ ì»¤ì§ˆ ë•Œ ì—¬ìœ  ê³µê°„ í™•ë³´ */
            
            min-height: 150px; 
            align-content: center;
            
            /* [ì¤‘ìš”] ì¹´ë“œê°€ í™•ëŒ€ë  ë•Œ ì˜ë¦¬ì§€ ì•Šë„ë¡ ì„¤ì • */
            overflow: visible; 
        }
        .hand-area::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .log-area { height: 120px; overflow-y: auto; background: #111; border: 1px solid #444; padding: 10px; text-align: left; font-size: 0.9em; margin-bottom: 10px; color: #bbb; border-radius: 5px; }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            background: #ecf0f1; color: #2c3e50; width: 100px; height: 140px; 
            border-radius: 8px; padding: 8px; cursor: pointer; font-size: 0.8em;
            display: flex; flex-direction: column; justify-content: space-between;
            border: 2px solid #bdc3c7; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        }
        .card:hover { transform: translateY(-15px) scale(1.05); border-color: #3498db; z-index: 5; }
        .card.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); transform: none; }
        .card-cost { background: #3498db; color: white; width: 25px; height: 25px; border-radius: 50%; text-align: center; line-height: 25px; font-weight: bold; position: absolute; top: -10px; left: -10px; }
        .card-name { font-weight: bold; margin-top: 10px; font-size: 1.1em; }
        .card-desc { font-size: 0.8em; color: #555; line-height: 1.3; }
      
        /* [ì¶”ê°€] ì¹´ë“œ ë“±ê¸‰(ë³„) ìŠ¤íƒ€ì¼ */
        .card-rank { 
            position: absolute; 
            top: 2px; 
            right: 5px; 
            color: #f1c40f; /* ê¸ˆìƒ‰ */
            font-weight: bold; 
            font-size: 1.2em; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.8); /* ì˜ ë³´ì´ê²Œ ê·¸ë¦¼ì ì¶”ê°€ */
        }

        /* ì´ë²¤íŠ¸(ìƒì /íœ´ì‹) ì „ì²´ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #event-scene { justify-content: center; align-items: center; text-align: center; }
        .event-content { background: #2c3e50; padding: 40px; border-radius: 15px; width: 100%; max-width: 600px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border: 1px solid #34495e; }
        .event-title { font-size: 2em; margin-bottom: 10px; color: #f1c40f; }
        .event-desc { font-size: 1.2em; margin-bottom: 30px; color: #ecf0f1; }
        
        .shop-items { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .shop-item { cursor: pointer; transition: 0.2s; position: relative; }
        .shop-item:hover { transform: scale(1.05); }
        .shop-item.sold-out { opacity: 0.4; pointer-events: none; filter: grayscale(100%); }
        .shop-item.sold-out::after { content: "SOLD OUT"; position: absolute; top: 40%; left: 10%; color: red; font-weight: bold; font-size: 1.5em; transform: rotate(-15deg); border: 2px solid red; padding: 5px; }
        .shop-price { background: #111; color: #f1c40f; padding: 5px; border-radius: 4px; margin-top: 5px; font-weight: bold; }

        /* ë²„íŠ¼ë¥˜ */
        .action-btn { background: #e67e22; color: white; border: none; padding: 12px 30px; font-size: 1.1em; cursor: pointer; border-radius: 5px; box-shadow: 0 4px 0 #d35400; transition: 0.1s; }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        .action-btn:disabled { background: #7f8c8d; box-shadow: none; cursor: not-allowed; transform: none; }
        .small-btn { background: #555; color: #fff; border: 1px solid #777; padding: 5px 10px; font-size: 0.8em; cursor: pointer; border-radius: 4px; margin: 0 2px; }

        /* íŒì—… */
        #popup-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 200; }
        .popup-box { background: #333; padding: 30px; border-radius: 10px; width: 500px; max-height: 80%; display: flex; flex-direction: column; text-align: center; border: 1px solid #555; }
        .popup-btns { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .pile-list { flex: 1; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 10px; background: #222; border-radius: 5px; margin-top: 10px; }
        .mini-card { width: 70px; height: 100px; background: #ecf0f1; color: #333; border-radius: 4px; padding: 5px; font-size: 0.6em; display: flex; flex-direction: column; justify-content: center; text-align: center; border: 1px solid #bdc3c7; }
        .mini-card b { display: block; font-size: 1.2em; margin-bottom: 3px; }
        
        .keyword { position: relative; color: #f1c40f; font-weight: bold; cursor: help; text-decoration: underline dotted; }
        .keyword .tip-text { visibility: hidden; width: 180px; background-color: #111; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1000; bottom: 125%; left: 50%; margin-left: -90px; font-size: 0.8em; font-weight: normal; border: 1px solid #777; opacity: 0; transition: opacity 0.2s; pointer-events: none; box-shadow: 0 4px 6px rgba(0,0,0,0.5); white-space: normal; line-height: 1.4; }
        .keyword:hover .tip-text { visibility: visible; opacity: 1; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <span id="game-info" style="font-weight:bold; font-size:1.1em;">Lv.1 | ğŸ’° 0ì›</span>
        <span id="turn-info">ê²Œì„ ì‹œì‘ ëŒ€ê¸°</span>
    </div>

    <div class="inventory-area">
        <div class="inv-label">ğŸ‘‘ ìœ ë¬¼:</div>
        <div class="item-list" id="relic-list"></div>
        <div style="width:20px;"></div> <div class="inv-label">ğŸ§ª ì†Œëª¨í’ˆ:</div>
        <div class="item-list" id="consumable-list"></div>
    </div>

    <div id="battle-scene" class="scene">
        <div class="battle-area">
    <div class="character" id="player-char">
        <h3 style="margin:5px 0;">ğŸ‘¤ í”Œë ˆì´ì–´</h3>
        <img id="p-img" src="https://placehold.co/150x150/3498db/ffffff?text=Hero" alt="Player" class="char-img">
        
        <div class="hp-bar-bg"><div class="hp-bar-fill" id="p-hp-bar"></div></div>
        <div>HP: <span id="p-hp">25</span>/<span id="p-max-hp">25</span> <span class="block-icon">ğŸ›¡ï¸<span id="p-block">0</span></span></div>
        <div class="stats" id="p-stats">ê³µ1 ë°©1 ì†1</div>
        <div class="buffs" id="p-buffs"></div>
        <div style="margin-top: 10px; display: flex; justify-content: center; gap: 5px;">
            <button id="btn-draw-pile" class="small-btn" onclick="openPileView('draw')">ë± (0)</button>
            <button id="btn-discard-pile" class="small-btn" onclick="openPileView('discard')">ë²„ë¦¼ (0)</button>
            <button id="btn-exhaust-pile" class="small-btn" onclick="openPileView('exhaust')">ì†Œë©¸ (0)</button>
        </div>
    </div>

    <div class="character" id="enemy-char">
        <h3 id="e-name" style="margin:5px 0;">ğŸ‘¿ í—ˆìˆ˜ì•„ë¹„</h3>
        <img id="e-img" src="https://placehold.co/150x150/e74c3c/ffffff?text=Enemy" alt="Enemy" class="char-img">
        
        <div class="hp-bar-bg"><div class="hp-bar-fill" id="e-hp-bar"></div></div>
        <div>HP: <span id="e-hp">25</span>/<span id="e-max-hp">25</span> <span class="block-icon">ğŸ›¡ï¸<span id="e-block">0</span></span></div>
        <div class="stats" id="e-stats">ê³µ1 ë°©1 ì†1</div>
        <div class="buffs" id="e-buffs"></div>
    </div>
</div>

        <div class="log-area" id="log-box"></div>
        <div class="hand-area" id="hand-container"></div>
        <div style="margin-top:auto;">
            <div style="margin-top: 0; margin-bottom: 3vh;">
                <button id="end-turn-btn" class="action-btn" onclick="endPlayerTurn()">í„´ ì¢…ë£Œ</button>
            </div>
        </div>
    </div>

    <div id="event-scene" class="scene hidden">
        <div class="event-content" id="event-content-box"></div>
    </div>
</div>

<div id="popup-layer">
    <div class="popup-box" onclick="event.stopPropagation()">
        <h2 id="popup-title" style="color:#f1c40f;">ì œëª©</h2>
        <div id="popup-desc" style="font-size:1.1em; color:#ddd; margin:10px 0;">ë‚´ìš©</div>
        <div id="popup-content"></div>
        <div class="popup-btns" id="popup-buttons"></div>
    </div>
</div>

<script>
/* --- ë°ì´í„° (ì¹´ë“œ) --- */
const CARD_DATA = {
    // 1ì„± (ê¸°ë³¸)
    "íƒ€ê²©": { rank: 1, cost: 1, type: "attack", desc: "ì  HP -5", dmg: 5 },
    "ìˆ˜ë¹„": { rank: 1, cost: 1, type: "skill", desc: "ë°©ì–´ë„ +4", block: 4 },
   
    
    // 1ì„± (íŠ¹ìˆ˜)
    "ì ìê¸°": { rank: 1, cost: 0, type: "skill", desc: "í™œë ¥(2í„´), ë°©ì–´ë„+2 (ì†Œë©¸)", buff: {name:"í™œë ¥", val:2}, block: 2, isExhaust: true },

    // 2ì„± (ë””ë²„í”„ & ë³µí•©)
    // ê¸°ì¡´: valì´ ë°©ì–´ë„ì˜€ìŒ -> block: 3ìœ¼ë¡œ ëª…ì‹œ
    "ë„ë°œ": { rank: 2, cost: 2, type: "skill", desc: "ì  ì•½í™”(2í„´), ë°©ì–´ë„+3", buff: {name:"ì•½í™”", val:2}, block: 3 },
    "ë… ë¿Œë¦¬ê¸°": { rank: 2, cost: 2, type: "skill", desc: "ì  ë…(2í„´), ë°©ì–´ë„+3", buff: {name:"ë…", val:2}, block: 3 },
    "íë§ê´‘ì„ ": { rank: 2, cost: 2, type: "skill", desc: "ë‚˜ í™œë ¥(2í„´), ë°©ì–´ë„+3", buff: {name:"í™œë ¥", val:3}, target:"self", block: 3 },
    "ê»´ì…ê¸°": { rank: 2, cost: 2, type: "skill", desc: "ë‚˜ ê±´ê°•(2í„´), ë°©ì–´ë„+4", buff: {name:"ê±´ê°•", val:2}, target:"self", block: 4 },

    // 2ì„± (ê³µê²© + ë””ë²„í”„/ë²„í”„)
    "ë„˜ì–´ëœ¨ë¦¬ê¸°": { rank: 2, cost: 2, type: "attack", desc: "ì  ì·¨ì•½(2í„´), ì  HP -4", buff: {name:"ì·¨ì•½", val:2}, dmg: 4 },
    "ì „ê¸° ì¶©ê²©": { rank: 2, cost: 2, type: "attack", desc: "ì  ë§ˆë¹„(2í„´), ì  HP -4", buff: {name:"ë§ˆë¹„", val:2}, dmg: 4 },
    "ê·¼ìœ¡ìë‘": { rank: 2, cost: 2, type: "attack", desc: "ë‚˜ ê°•í™”(2í„´), ì  HP -4", buff: {name:"ê°•í™”", val:2}, target:"self", dmg: 4 },
    "ë‹¬ë¦¬ê¸°": { rank: 2, cost: 2, type: "attack", desc: "ë‚˜ ì¾Œì†(2í„´), ì  HP -4", buff: {name:"ì¾Œì†", val:2}, target:"self", dmg: 4 },

    "ëŒì§„" : { rank: 2, cost: 2, type: "attack", desc: "ì  8 í”¼í•´, ë°©ì–´ë„ +8", dmg: 8, block: 8},

    // íŠ¹ìˆ˜ ê¸°ëŠ¥ (special íƒœê·¸ ì‚¬ìš©)
    "ë°©íŒ¨ ë¶€ìˆ˜ê¸°": { rank: 2, cost: 2, type: "attack", desc: "ì  ë°©ì–´ë„ ì œê±°, ì  HP -2", special: "break_block", dmg: 2 },

    // 3ì„±
    "ì‚¬ê²©": { rank: 3, cost: 1, type: "attack", desc: "ë‚˜ ê°•í™”(2í„´), ì  HP -8", buff: {name:"ê°•í™”", val:2}, target:"self", dmg: 8 },
    "ëŸ­í‚¤í”¼ìŠ¤": { rank: 3, cost: 1, type: "attack", desc: "ì  HP -8, ìƒê¸ˆ 2ë°° (ì†Œë©¸)", special: "lucky", dmg: 8, isExhaust: true }
};

const TOOLTIPS = {
    "ì•½í™”": "ê³µê²© ìŠ¤íƒ¯ì´ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.",
    "ì·¨ì•½": "ë°©ì–´ ìŠ¤íƒ¯ì´ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.",
    "ë§ˆë¹„": "ì†ë„ ìŠ¤íƒ¯ì´ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.",
    "ë…": "í„´ ì‹œì‘ ì‹œ ì¤‘ì²©ëœ ìˆ˜ì¹˜ë§Œí¼ í”¼í•´ë¥¼ ì…ê³ , 1 ì¤„ì–´ë“­ë‹ˆë‹¤.",
    "ê°•í™”": "ê³µê²© ìŠ¤íƒ¯ì´ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.",
    "ê±´ê°•": "ë°©ì–´ ìŠ¤íƒ¯ì´ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.",
    "ì¾Œì†": "ì†ë„ ìŠ¤íƒ¯ì´ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.",
    "í™œë ¥": "í„´ ì‹œì‘ ì‹œ ì¤‘ì²©ëœ ìˆ˜ì¹˜ë§Œí¼ ì²´ë ¥ì„ íšŒë³µí•˜ê³ , 1 ì¤„ì–´ë“­ë‹ˆë‹¤.",
    // [ì¶”ê°€ëœ ë¶€ë¶„] ì†Œë©¸ ì„¤ëª… ì¶”ê°€
    "ì†Œë©¸": "ì¹´ë“œë¥¼ ì‚¬ìš©í•˜ë©´ ë±ì—ì„œ ì œê±°ë˜ì–´, ì´ë²ˆ ì „íˆ¬ ë™ì•ˆ ë‹¤ì‹œ ë‚˜ì˜¤ì§€ ì•ŠìŠµë‹ˆë‹¤."
};

function applyTooltip(text) {
    let res = text;
    for (let key in TOOLTIPS) {
        let regex = new RegExp(key, 'g'); 
        res = res.replace(regex, `<span class="keyword">${key}<span class="tip-text">${TOOLTIPS[key]}</span></span>`);
    }
    return res;
}

/* --- ë°ì´í„° (ì•„ì´í…œ) --- */
/* [ìˆ˜ì •] ITEM_DATA ì „ì²´ë¥¼ ì´ê±¸ë¡œ ì—…ë°ì´íŠ¸í•˜ì„¸ìš” */
const ITEM_DATA = {
    // --- ìœ ë¬¼ (íŒ¨ì‹œë¸Œ íš¨ê³¼ëŠ” ë³„ë„ ë¡œì§ì´ë¼ effect íƒœê·¸ê°€ ë‹¹ì¥ í•„ìš”í•˜ì§„ ì•Šì§€ë§Œ, í™•ì¥ì„ ìœ„í•´ ë¶„ë¥˜) ---
    "ì¿ ë³´íƒ„": {type: "relic", rank: 1, price: 2000, icon: "ğŸ¥Š", desc: "ê³µê²©ë ¥ +1 (íŒ¨ì‹œë¸Œ)"},
    "ê°•ì¸í•¨ì˜ ë¶€ì ": {type: "relic", rank: 1, price: 2000, icon: "ğŸ§¿", desc: "ë°©ì–´ë ¥ +1 (íŒ¨ì‹œë¸Œ)"},
    "ì¢‹ì€ ìš´ë™í™”": {type: "relic", rank: 1, price: 2000, icon: "ğŸ‘Ÿ", desc: "ì†ë„ +1 (íŒ¨ì‹œë¸Œ)"},
    "ìš¸ëˆë¶ˆëˆ íŒ¨ë”©": {type: "relic", rank: 2, price: 3000, icon: "ğŸ§¥", desc: "ìµœëŒ€ HP +50 ì¦ê°€"},
    "í™©ê¸ˆ ëŒ€íƒ€": {type: "relic", rank: 3, price: 4000, icon: "ğŸº", desc: "ì‚¬ë§ ì‹œ 1000ì›ì„ ì†Œëª¨í•˜ì—¬ ë¶€í™œ"},

    // --- ì†Œëª¨í’ˆ (ì—¬ê¸°ì„œë¶€í„° ë°ì´í„° êµ¬ì¡°í™” ì ìš©!) ---
    
    // effect: "heal" -> ì²´ë ¥ íšŒë³µ
    "íšŒë³µì•½": {type: "consumable", rank: 1, price: 1000, icon: "ğŸ·", desc: "HP 25 íšŒë³µ", effect: "heal", val: 25},
    
    // effect: "damage" -> ì ì—ê²Œ í”¼í•´
    "í˜¸ì‹ ìš© ìŠ¤í”„ë ˆì´": {type: "consumable", rank: 1, price: 1000, icon: "ğŸ§´", desc: "ì ì—ê²Œ 10 í”¼í•´", effect: "damage", val: 10},
    
    // effect: "event_rest" -> ë‹¤ìŒ ì´ë²¤íŠ¸ ê³ ì •
    "í”¼ë‚œì˜ í”¼ë¦¬": {type: "consumable", rank: 2, price: 2000, icon: "ğŸ¼", desc: "ë‹¤ìŒ ì´ë²¤íŠ¸ë¥¼ [íœ´ì‹]ìœ¼ë¡œ ê³ ì •", effect: "event_rest"},
    
    // effect: "revive" -> ë¶€í™œ (ìˆ˜ë™ ì‚¬ìš© ë¶ˆê°€)
    "ëŒ€íƒ€ ì¸í˜•": {type: "consumable", rank: 3, price: 3000, icon: "ğŸ§¸", desc: "ì‚¬ë§ ì‹œ ìë™ ë¶€í™œ", effect: "revive"}
};
/* --- ìƒíƒœ ë³€ìˆ˜ --- */
let player = { 
    maxHp: 25, hp: 25, baseAtk: 1, baseDef: 1, baseSpd: 1, 
    gold: 0, deck: [], hand: [], block: 0, buffs: {}, ap: 3, 
    jumadeung: false, lucky: false,
    drawPile: [], discardPile: [], 
    exhaustPile: [], // [NEW] ì†Œë©¸ëœ ì¹´ë“œ ì €ì¥ì†Œ
    relics: [], consumables: [],
    xp: 0, 
    maxXp: 100 // 1ë ˆë²¨ì—… í•„ìš” ê²½í—˜ì¹˜
};
let enemy = { name: "í—ˆìˆ˜ì•„ë¹„", maxHp: 25, hp: 25, baseAtk: 1, baseDef: 1, baseSpd: 1, deck: [], block: 0, buffs: {}, ap: 3 };
let game = { level: 1, turnCount: 0, state: "battle", turnOwner: "none", lastWho: null, forceRest: false };

/* --- ìœ í‹¸ë¦¬í‹° --- */
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
function log(msg) { const box = document.getElementById('log-box'); box.innerHTML += `<div>${msg}</div>`; box.scrollTop = box.scrollHeight; }

/* --- ì¥ë©´ ì „í™˜ --- */
function switchScene(sceneName) {
    document.getElementById('battle-scene').classList.add('hidden');
    document.getElementById('event-scene').classList.add('hidden');
    document.getElementById('popup-layer').style.display = 'none';
    if (sceneName === 'battle') document.getElementById('battle-scene').classList.remove('hidden');
    else if (sceneName === 'event') document.getElementById('event-scene').classList.remove('hidden');
    updateUI();
}

/* --- ì´ˆê¸°í™” --- */
function initGame() {
    // 1. ê¸°ë³¸ ë± ì„¤ì •: íƒ€ê²© 5ì¥ + ìˆ˜ë¹„ 4ì¥
    player.deck = ["íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","ìˆ˜ë¹„","ìˆ˜ë¹„","ìˆ˜ë¹„","ìˆ˜ë¹„"];
    
    // 2. ë¬´ì‘ìœ„ 2ì„± ì¹´ë“œ 1ì¥ ì¶”ê°€
    addRandomCard(2); 
    
    // (ì‚­ì œë¨) player.deck.push("ì ìê¸°"); 
    
    updateUI();
    startBattle();
}

/* --- ì¸ë²¤í† ë¦¬ ì‹œìŠ¤í…œ --- */
function addItem(name) {
    const data = ITEM_DATA[name];
    if (data.type === 'relic') {
        if (player.relics.includes(name)) return false; 
        player.relics.push(name);
        if (name === "ìš¸ëˆë¶ˆëˆ íŒ¨ë”©") { player.maxHp += 50; player.hp += 50; log("ğŸ§¥ íŒ¨ë”© ì¥ì°©! ìµœëŒ€ ì²´ë ¥ì´ 50 ì¦ê°€í–ˆìŠµë‹ˆë‹¤."); }
    } else { player.consumables.push(name); }
    updateInventoryUI(); return true;
}
/* [ìˆ˜ì •] useConsumable í•¨ìˆ˜ ì „ì²´ êµì²´ */
function useConsumable(index) {
    const name = player.consumables[index];
    const data = ITEM_DATA[name];

    // 1. ì‚¬ìš© ì¡°ê±´ ì²´í¬
    // ì „íˆ¬ ì¤‘ì—ë§Œ ì“¸ ìˆ˜ ìˆëŠ” ê³µê²© ì•„ì´í…œì¸ì§€ í™•ì¸
    if (data.effect === "damage") {
        if (game.state !== "battle") { log("ğŸš« ê³µê²© ì•„ì´í…œì€ ì „íˆ¬ ì¤‘ì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
        if (game.turnOwner !== "player") { log("ğŸš« ë‚´ í„´ì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
    }
    
    // 2. íš¨ê³¼ ì²˜ë¦¬ (Switchë¬¸ ì‚¬ìš©)
    let used = false; // ì‹¤ì œë¡œ ì‚¬ìš©í–ˆëŠ”ì§€ ì—¬ë¶€

    switch (data.effect) {
        case "heal":
            // íšŒë³µ ë¡œì§ (val ì†ì„± ì‚¬ìš©)
            let oldHp = player.hp;
            player.hp = Math.min(player.maxHp, player.hp + data.val);
            let healed = player.hp - oldHp;
            log(`ğŸ¥¤ [${name}] ì‚¬ìš©! ì²´ë ¥ì„ ${healed} íšŒë³µí–ˆìŠµë‹ˆë‹¤.`);
            used = true;
            break;

        case "damage":
            // ë°ë¯¸ì§€ ë¡œì§ (val ì†ì„± ì‚¬ìš©)
            enemy.hp -= data.val;
            log(`ğŸ’¥ [${name}] ë°œì‚¬! ì ì—ê²Œ ${data.val} í”¼í•´.`);
            checkGameOver(); // ì ì´ ì£½ì—ˆëŠ”ì§€ í™•ì¸
            used = true;
            break;

        case "event_rest":
            // ì´ë²¤íŠ¸ ê³ ì • ë¡œì§
            game.forceRest = true;
            log(`ğŸ¼ [${name}]ì„ ë¶ˆì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì¥ì†ŒëŠ” ì•ˆì „í•  ê²ƒì…ë‹ˆë‹¤.`);
            used = true;
            break;

        case "revive":
            // ë¶€í™œ ì•„ì´í…œ (ìˆ˜ë™ ì‚¬ìš© ë¶ˆê°€)
            log(`ğŸ§¸ [${name}]ì€ ì†Œì§€í•˜ê³  ìˆìœ¼ë©´ ì£½ì„ ë•Œ ìë™ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.`);
            used = false; // ì‚¬ìš©ë˜ì§€ ì•ŠìŒ (ì¸ë²¤í† ë¦¬ì— ë‚¨ìŒ)
            break;

        default:
            log("ğŸš« ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.");
            used = false;
            break;
    }

    // 3. ì•„ì´í…œ ì†Œëª¨ ì²˜ë¦¬
    if (used) {
        player.consumables.splice(index, 1);
        updateUI();
    }
}
function updateInventoryUI() {
    const rList = document.getElementById('relic-list'); const cList = document.getElementById('consumable-list'); rList.innerHTML = ""; cList.innerHTML = "";
    player.relics.forEach(name => { let data = ITEM_DATA[name]; let el = document.createElement('div'); el.className = `item-icon item-relic item-rank-${data.rank}`; el.innerHTML = `${data.icon}<span class="tooltip"><b>${name}</b><br>${data.desc}</span>`; rList.appendChild(el); });
    player.consumables.forEach((name, idx) => { let data = ITEM_DATA[name]; let el = document.createElement('div'); el.className = `item-icon item-consumable item-rank-${data.rank}`; el.innerHTML = `${data.icon}<span class="tooltip"><b>${name}</b><br>${data.desc}</span>`; el.onclick = () => useConsumable(idx); cList.appendChild(el); });
}

/* --- ì „íˆ¬ ì‹œìŠ¤í…œ --- */
function startBattle() {
    switchScene('battle'); game.state = "battle"; 
    let growth = game.level - 1;
    enemy.name = `í—ˆìˆ˜ì•„ë¹„ Lv.${game.level}`; enemy.maxHp = 25 + (growth * 5); enemy.hp = enemy.maxHp;
    enemy.baseAtk = 1; enemy.baseDef = 1; enemy.baseSpd = 1;
    for(let i=0; i<growth; i++) { let r = Math.random(); if (r < 0.33) enemy.baseAtk++; else if (r < 0.66) enemy.baseDef++; else enemy.baseSpd++; }
    enemy.deck = ["íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","íƒ€ê²©","ìˆ˜ë¹„","ìˆ˜ë¹„","ìˆ˜ë¹„","ìˆ˜ë¹„"];
    let rank2Cards = Object.keys(CARD_DATA).filter(k => CARD_DATA[k].rank === 2);
    enemy.deck.push(rank2Cards[Math.floor(Math.random() * rank2Cards.length)]);

    player.drawPile = [...player.deck]; shuffle(player.drawPile);
    player.discardPile = [];
    player.exhaustPile = []; // [NEW] ì „íˆ¬ ì‹œì‘ ì‹œ ì†Œë©¸ ë”ë¯¸ ì´ˆê¸°í™”
    player.hand = [];
    enemy.buffs = {}; player.buffs = {}; player.block = 0; enemy.block = 0; player.lucky = false; player.jumadeung = false;
    game.turnCount = 0; game.lastWho = null;
    game.extraTurnTriggered = false; // [NEW] ì¶”ê°€ í–‰ë™ê¶Œ ì‚¬ìš© ì—¬ë¶€ ì´ˆê¸°í™”
    log(`âš”ï¸ Lv.${game.level} ì „íˆ¬ ì‹œì‘!`); updateUI(); nextTurnCycle();
}

async function nextTurnCycle() {
    if (checkGameOver()) return;
    
    game.turnCount++;
    log(`---- Turn ${game.turnCount} ----`);

    // 1. ë²„í”„/ë””ë²„í”„ í„´ ê²½ê³¼ ì²˜ë¦¬
    tickBuffs(player); tickBuffs(enemy);
    decrementBuffs(player); decrementBuffs(enemy);
    if (checkGameOver()) return;

    // 2. í˜„ì¬ ìŠ¤íƒ¯ í™•ì¸
    let pSpd = getStat(player, 'spd');
    let eSpd = getStat(enemy, 'spd');

    // 3. [í•µì‹¬ ìˆ˜ì •] ì´ë²ˆ í„´ì˜ 'ì¶”ê°€ í–‰ë™ê¶Œ' ì‚¬ìš© ì—¬ë¶€ ì´ˆê¸°í™”
    // ë§Œì•½ ì‹œì‘ë¶€í„° ì´ë¯¸ 2ë°° ë¹¨ë¼ì„œ 2íšŒ í–‰ë™ì„ ë°›ëŠ”ë‹¤ë©´? -> ì´ë¯¸ ë°›ì€ ê±¸ë¡œ ì²˜ë¦¬(true)
    // ì‹œì‘ì€ ë¹„ìŠ·í–ˆëŠ”ë° ë„ì¤‘ì— ë¹¨ë¼ì§„ ê²½ìš°ì—ë§Œ? -> ì•„ì§ ì•ˆ ë°›ì€ ê±¸ë¡œ ì²˜ë¦¬(false)
    if (pSpd >= eSpd * 2) {
        game.extraTurnTriggered = true; // ì´ë¯¸ ë¹¨ë¼ì„œ í˜œíƒ ë°›ìŒ (ì¤‘ë³µ ì§€ê¸‰ ë°©ì§€)
    } else {
        game.extraTurnTriggered = false; // ì•„ì§ í˜œíƒ ì•ˆ ë°›ìŒ (ë„ì¤‘ì— ë¹¨ë¼ì§€ë©´ ë°›ì„ ìˆ˜ ìˆìŒ)
    }

    // 4. í„´ ìˆœì„œ ë°°ì • (ê¸°ì¡´ ë¡œì§)
    let pTurns = (pSpd >= eSpd * 2) ? 2 : 1;
    let eTurns = (eSpd >= pSpd * 2) ? 2 : 1;
    
    // (ë¡œê·¸ ì¶œë ¥: ì´ë¯¸ ë¹¨ë¼ì„œ 2í„´ì´ë©´ ì—¬ê¸°ì„œ ì•Œë ¤ì¤Œ)
    if (pTurns > 1) log("âš¡ ì••ë„ì ì¸ ì†ë„! 2íšŒ í–‰ë™í•©ë‹ˆë‹¤.");
    if (eTurns > 1) log("âš¡ ì ì´ ë¹¨ë¼ì„œ 2íšŒ í–‰ë™í•©ë‹ˆë‹¤!");

    // í„´ í ìƒì„±
    let order = [];
    if (eSpd > pSpd) { 
        for(let i=0; i<eTurns; i++) order.push("enemy"); 
        for(let i=0; i<pTurns; i++) order.push("player"); 
    } else { 
        for(let i=0; i<pTurns; i++) order.push("player"); 
        for(let i=0; i<eTurns; i++) order.push("enemy"); 
    }
    
    await executeTurnQueue(order);
}

async function executeTurnQueue(queue) {
    if (queue.length === 0) { nextTurnCycle(); return; }
    if (checkGameOver()) return;
    let who = queue.shift(); let isConsecutive = (who === game.lastWho); game.lastWho = who; game.turnOwner = who; updateUI();
    if (who === "player") { game.currentQueue = queue; startPlayerTurn(isConsecutive); }
    else { await startEnemyTurn(isConsecutive); await executeTurnQueue(queue); }
}

function startPlayerTurn(isConsecutive) {
    if (!isConsecutive) player.block = 0; player.ap = 3; drawCards(5);
    document.getElementById('end-turn-btn').disabled = false;
    document.getElementById('turn-info').innerText = `ë‚˜ì˜ í„´ (í–‰ë™ë ¥: ${player.ap})`;
    document.getElementById('player-char').classList.add('turn-active'); document.getElementById('enemy-char').classList.remove('turn-active'); updateUI();
}

function endPlayerTurn() {
    document.getElementById('end-turn-btn').disabled = true;
    if (player.hand.length > 0) { player.discardPile.push(...player.hand); player.hand = []; }
    renderHand(); game.turnOwner = "none"; updateUI(); executeTurnQueue(game.currentQueue);
}

async function startEnemyTurn(isConsecutive) {
    if (!isConsecutive) enemy.block = 0; enemy.ap = 3; 
    document.getElementById('turn-info').innerText = "ì ì˜ í„´ (í–‰ë™ ì¤‘...)";
    document.getElementById('enemy-char').classList.add('turn-active'); document.getElementById('player-char').classList.remove('turn-active'); updateUI(); log(`ğŸ‘¿ ì ì˜ í„´ ì‹œì‘ (AP: ${enemy.ap})`);
    while (enemy.ap > 0 && player.hp > 0) {
        await sleep(1000); let playable = enemy.deck.filter(n => CARD_DATA[n].cost <= enemy.ap);
        if (playable.length === 0) { log("ğŸ’¬ ì  í„´ ì¢…ë£Œ."); break; }
        let cName = playable[Math.floor(Math.random() * playable.length)]; enemy.ap -= CARD_DATA[cName].cost;
        useCard(enemy, player, cName); updateUI(); if (checkGameOver()) return;
    }
    await sleep(800);
}

function useCard(user, target, cardName) {
    let data = CARD_DATA[cardName];
    let atk = getStat(user, 'atk');
    let def = getStat(user, 'def');
    
    log(`ğŸƒ ${user===player?"ë‚˜":"ì "}ì˜ [${cardName}]!`);
    let userId = (user === player) ? "player-char" : "enemy-char";

    // 1. [ê³µê²©]
    if (data.type.includes("attack")) {
        if (user === player) playAnim(userId, 'anim-atk-p');
        else playAnim(userId, 'anim-atk-e');

        if (data.special === "break_block") { target.block = 0; log(`ğŸ”¨ ë°©ì–´êµ¬ íŒŒê´´!`); }
        if (data.special === "lucky" && user === player) { player.lucky = true; log(`ğŸ€ í–‰ìš´ ë°œë™!`); }

        let finalDmg = (data.dmg || 0) + atk;
        takeDamage(target, finalDmg);
    } 
    // 2. [ìŠ¤í‚¬]
    else {
        playAnim(userId, 'anim-bounce');
    }

    // 3. [ê³µí†µ: ë°©ì–´ ë° ë²„í”„]
    if (data.block) {
        let finalBlock = data.block + def;
        user.block += finalBlock;
        log(`ğŸ›¡ï¸ ë°©ì–´ë„ +${finalBlock}`);
    }

    if (data.buff) {
        let buffName = data.buff.name;
        let buffVal = data.buff.val;
        let buffTarget = target; 
        
        const selfBuffs = ["ê°•í™”", "ê±´ê°•", "ì¾Œì†", "í™œë ¥"];
        if (data.target === "self" || selfBuffs.includes(buffName)) { 
            buffTarget = user; 
        }
        applyBuff(buffTarget, buffName, buffVal);
    }

    // [ìˆ˜ì •] 4. ì‹¤ì‹œê°„ í„´ ì¬ê³„ì‚° (í•œ ë¼ìš´ë“œì— 1ë²ˆë§Œ ë°œë™)
    // -----------------------------------------------------------
    if (user === player) {
        let pSpd = getStat(player, 'spd');
        let eSpd = getStat(enemy, 'spd');

        // ì¡°ê±´ 1: ì†ë„ê°€ 2ë°° ì´ìƒ ì°¨ì´ë‚¨
        // ì¡°ê±´ 2: [NEW] ì´ë²ˆ ë¼ìš´ë“œì— ì•„ì§ ì¶”ê°€ í„´ì„ ë°›ì§€ ì•ŠìŒ (!game.extraTurnTriggered)
        if (pSpd >= eSpd * 2 && !game.extraTurnTriggered) {
            
            // ì¡°ê±´ 3: íì˜ ë§¨ ì•ì´ ì´ë¯¸ ë‚´ í„´ì´ ì•„ë‹ ë•Œ (ì¤‘ë³µ ë°©ì§€)
            if (game.currentQueue.length === 0 || game.currentQueue[0] !== "player") {
                
                game.currentQueue.unshift("player"); // í„´ ìƒˆì¹˜ê¸°
                game.extraTurnTriggered = true;      // [NEW] "ë‚˜ ë°›ì•˜ë‹¤" ë„ì¥ ì¾…!
                
                log("âš¡ ì••ë„ì ì¸ ì†ë„! í–‰ë™ ê¸°íšŒë¥¼ ì¦‰ì‹œ íšë“í•©ë‹ˆë‹¤!");
                if(typeof showDamageText === "function") showDamageText(player, "SPEED UP!");
                
                updateUI();
            }
        }
    }
}
function takeDamage(target, dmg) {
    // 1. [ì• ë‹ˆë©”ì´ì…˜] í”¼ê²© ëª¨ì…˜ ì¬ìƒ (ë§ëŠ” ëŒ€ìƒì— ë”°ë¼ ID ê²°ì •)
    let targetId = (target === player) ? "player-char" : "enemy-char";
    playAnim(targetId, 'anim-hit');

    // 2. [ë°©ì–´ë„ ì—°ì‚°] ë°©íŒ¨ê°€ ìˆìœ¼ë©´ ë°ë¯¸ì§€ë¥¼ ë¨¼ì € í¡ìˆ˜
    if (target.block > 0) {
        if (target.block >= dmg) {
            target.block -= dmg;
            dmg = 0; // ë°©ì–´ë„ê°€ ë°ë¯¸ì§€ë³´ë‹¤ ë§ìœ¼ë©´ HP í”¼í•´ ì—†ìŒ
        } else {
            dmg -= target.block;
            target.block = 0; // ë°©ì–´ë„ ë‹¤ ê¹¨ì§€ê³  ë‚¨ì€ ë°ë¯¸ì§€ë§Œ ë“¤ì–´ê°
        }
    }
// [NEW] ëŒ€ë¯¸ì§€ í…ìŠ¤íŠ¸ ë„ìš°ê¸°!
    if (dmg > 0) {
        showDamageText(target, dmg); // ì˜ˆ: "15"
    } else {
        showDamageText(target, "BLOCK"); // ëŒ€ë¯¸ì§€ 0ì¼ ë•Œ
    }

    // 3. [ì²´ë ¥ ê°ì†Œ] ì‹¤ì œ HP ì°¨ê°
    target.hp -= dmg;
    log(`ğŸ’¥ ${dmg} í”¼í•´! (HP: ${target.hp})`); // (ë¡œê·¸ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì£¼ì„ ì²˜ë¦¬)

    // 4. [í”Œë ˆì´ì–´ ì‚¬ë§ ìœ„ê¸° ì²˜ë¦¬] HPê°€ 0 ì´í•˜ì¼ ë•Œ ìƒì¡´ ë¡œì§ ê°€ë™
    if (target === player && target.hp <= 0) {

        // (1ë‹¨ê³„) ì•„ì´í…œ ë¶€í™œ ì²´í¬: 'effect'ê°€ 'revive'ì¸ ì•„ì´í…œ ì°¾ê¸°
        // (ì´ë¦„("ëŒ€íƒ€ ì¸í˜•")ìœ¼ë¡œ ì°¾ì§€ ì•Šê³  íš¨ê³¼ë¡œ ì°¾ìœ¼ë¯€ë¡œ, ë‚˜ì¤‘ì— ì•„ì´í…œ ì´ë¦„ì´ ë°”ë€Œì–´ë„ ì‘ë™í•¨)
        let reviveItemIdx = player.consumables.findIndex(name => ITEM_DATA[name].effect === "revive");

        if (reviveItemIdx !== -1) {
            let itemName = player.consumables[reviveItemIdx]; // ì•„ì´í…œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            
            player.hp = player.maxHp; // í’€í”¼ ë¶€í™œ
            player.consumables.splice(reviveItemIdx, 1); // ì•„ì´í…œ ì†Œëª¨

            log(`âœ¨ [${itemName}]ì˜ íš¨ê³¼ë¡œ ë¶€í™œí–ˆìŠµë‹ˆë‹¤!`);
            playAnim(targetId, 'anim-bounce'); // ë¶€í™œí•´ì„œ ê¸°ì˜ë‹ˆê¹Œ ì í”„ ëª¨ì…˜

            updateInventoryUI();
            updateUI();
            return; // ì£½ì§€ ì•Šê³  ì—¬ê¸°ì„œ ì¢…ë£Œ
        }

        // (2ë‹¨ê³„) ìœ ë¬¼ ë¶€í™œ ì²´í¬: 'í™©ê¸ˆ ëŒ€íƒ€' (ê³¨ë“œ ì†Œëª¨)
        if (player.relics.includes("í™©ê¸ˆ ëŒ€íƒ€") && player.gold >= 1000) {
            player.gold -= 1000;
            player.hp = player.maxHp;

            log("ğŸº [í™©ê¸ˆ ëŒ€íƒ€]ê°€ 1000ì›ì„ ì†Œëª¨í•˜ì—¬ ë‹¹ì‹ ì„ ì‚´ë ¸ìŠµë‹ˆë‹¤!");
            playAnim(targetId, 'anim-bounce');

            updateUI();
            return;
        }

        // (3ë‹¨ê³„) ì£¼ë§ˆë“± ì‹œìŠ¤í…œ: ì•„ë¬´ê²ƒë„ ì—†ì„ ë•Œ ë”± í•œ ë²ˆ 1ë¡œ ë²„íŒ€
        if (!target.jumadeung) {
            target.hp = 1;
            target.jumadeung = true; // ì£¼ë§ˆë“± ì‚¬ìš© ì²˜ë¦¬

            log("âš¡ [ì£¼ë§ˆë“±] ì¹˜ëª…ì ì¸ ê³µê²©ì„ ê°„ì‹ íˆ ë²„í…¼ìŠµë‹ˆë‹¤! (HP 1)");
            playAnim(targetId, 'anim-bounce');

            updateUI();
            return;
        }

        // (4ë‹¨ê³„) ì—¬ê¸°ê¹Œì§€ ì™”ìœ¼ë©´ ì§„ì§œ ì‚¬ë§... (checkGameOverì—ì„œ ê²Œì„ ì˜¤ë²„ ì²˜ë¦¬ë¨)
    }
}
        /* [ì¶”ê°€] ëŒ€ë¯¸ì§€ í°íŠ¸ ì¶œë ¥ í•¨ìˆ˜ */
        function showDamageText(target, text) {
            // 1. ë„ìš¸ ìœ„ì¹˜(ìºë¦­í„° ë°•ìŠ¤) ì°¾ê¸°
            let targetId = (target === player) ? "player-char" : "enemy-char";
            let parentEl = document.getElementById(targetId);

            // 2. í…ìŠ¤íŠ¸ ìš”ì†Œ ìƒì„± (div)
            let el = document.createElement("div");
            el.className = "damage-number";
            el.innerText = text; // ìˆ«ìë‚˜ í…ìŠ¤íŠ¸(BLOCK ë“±)

            // 3. ìºë¦­í„° ë°•ìŠ¤ ì•ˆì— ë¶™ì´ê¸°
            parentEl.appendChild(el);

            // 4. ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„(0.8ì´ˆ) ë’¤ì— HTMLì—ì„œ ì™„ì „ ì œê±° (ì²­ì†Œ)
            setTimeout(() => {
                el.remove();
            }, 800);
        }
/* [ìˆ˜ì •] checkGameOver í•¨ìˆ˜ ì „ì²´ êµì²´ */
function checkGameOver() {
    if (player.hp <= 0) { 
        showPopup("ğŸ’€ ê²Œì„ ì˜¤ë²„", "íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...", [{txt:"ë‹¤ì‹œ í•˜ê¸°", func: ()=>location.reload()}]); 
        return true; 
    }
    if (enemy.hp <= 0) {
        if(game.state === "win") return true; 
        game.state = "win";
        
        // 1. ë³´ìƒ ê³„ì‚° (ê³¨ë“œ)
        let rewardGold = 1000 * (player.lucky ? 2 : 1); 
        player.gold += rewardGold; 
        
        // [NEW] 2. ê²½í—˜ì¹˜ íšë“ ê³µì‹ (ê¸°ë³¸ 40 + ì  ë ˆë²¨ ë¹„ë¡€)
        // ë ˆë²¨ì´ ì˜¤ë¥¼ìˆ˜ë¡ ì ë„ ì„¸ì§€ë¯€ë¡œ ê²½í—˜ì¹˜ë„ ì¡°ê¸ˆì”© ë” ì¤ë‹ˆë‹¤.
        let gainXp = 40 + (game.level * 10);
        player.xp += gainXp;

        let msg = `ìŠ¹ë¦¬! ${rewardGold}ì›, ${gainXp} XP íšë“.`; 
        if (player.lucky) msg += " (ëŸ­í‚¤í”¼ìŠ¤ íš¨ê³¼!)";
        
        // 3. ì•„ì´í…œ ë“œë (5%)
        let lootBtn = null; 
        let contentHTML = "";
        if (Math.random() < 0.05) { 
            let loot = getRandomItem(); 
            let lData = ITEM_DATA[loot];
            msg += `<br>âœ¨ ì „ë¦¬í’ˆ ë°œê²¬!`;
            contentHTML = `
                <div style="display:flex; justify-content:center; margin-top:15px;">
                    <div class="item-icon item-${lData.type} item-rank-${lData.rank}">
                        ${lData.icon}
                        <span class="tooltip"><b>${loot}</b><br>${lData.desc}</span>
                    </div>
                </div>
                <div style="margin-top:5px; font-size:0.9em; color:#aaa;">${loot}</div>
            `;
            lootBtn = {txt: "ì•„ì´í…œ ì¤ê¸°", func: ()=>{ addItem(loot); nextStepAfterWin(); }}; 
        }
        
        // 4. ë²„íŠ¼ ì„¤ì •
        let btns = [];
        if (lootBtn) btns.push(lootBtn);
        
        // ë ˆë²¨ì—… ì¡°ê±´ì¸ì§€ í™•ì¸í•˜ì—¬ ë²„íŠ¼ ë™ì‘ ë¶„ê¸°
        if (player.xp >= player.maxXp) {
            msg += `<br><b style="color:#f1c40f">ğŸ†™ ë ˆë²¨ ì—… ê°€ëŠ¥!</b>`;
            // ë ˆë²¨ì—…ì´ë©´ -> ìŠ¤íƒ¯ ì°ìœ¼ëŸ¬ ê°€ê¸°
            btns.push({txt: "ë ˆë²¨ì—…!", func: processLevelUp});
        } else {
            // ë ˆë²¨ì—… ì•„ë‹ˆë©´ -> ë‹¤ìŒ ì´ë²¤íŠ¸ë¡œ
            btns.push({txt: "ë‹¤ìŒìœ¼ë¡œ", func: nextStepAfterWin});
        }

        showPopup("ì „íˆ¬ ìŠ¹ë¦¬!", msg, btns, contentHTML); 
        updateUI(); // ê²½í—˜ì¹˜ ë°” ê°±ì‹ 
        return true;
    }
    return false;
}
/* --- ì´ë²¤íŠ¸ ë° ìƒì  --- */
function runRandomEvent() {
    if (game.forceRest) { game.forceRest = false; renderRestScreen(); return; }
    let rand = Math.random(); if (rand < 0.6) startBattle(); else if (rand < 0.8) renderRestScreen(); else renderShopScreen();
}
function renderRestScreen() {
    switchScene('event');
    document.getElementById('event-content-box').innerHTML = `
        <div class="event-title">ğŸ”¥ íœ´ì‹ì²˜</div><div class="event-desc">ì²´ë ¥ì„ íšŒë³µí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span style="color:#e74c3c">HP: ${player.hp} / ${player.maxHp}</span></div>
        <div style="display:flex; justify-content:center; gap:20px;">
            <button class="action-btn" onclick="restAction()">ğŸ˜´ ì‰¬ê¸° (50% íšŒë³µ)</button><button class="action-btn" style="background:#7f8c8d" onclick="startBattle()">ğŸ‘£ ë– ë‚˜ê¸°</button>
        </div>`;
}
// [ìˆ˜ì •] ì‹¤ì œ íšŒë³µëœ ìˆ˜ì¹˜ë¥¼ ê³„ì‚°í•˜ì—¬ í‘œì‹œ
function restAction() {
    // 1. íšŒë³µ ê°€ëŠ¥í•œ ìµœëŒ€ëŸ‰ (ì „ì²´ ì²´ë ¥ì˜ 50%)
    let maxHeal = Math.floor(player.maxHp / 2);
    
    // 2. í˜„ì¬ ìƒì–´ë²„ë¦° ì²´ë ¥ (ì´ê²ƒë³´ë‹¤ ë§ì´ íšŒë³µí•  ìˆ˜ëŠ” ì—†ìŒ)
    let missingHp = player.maxHp - player.hp;
    
    // 3. ë‘˜ ì¤‘ ë” ì‘ì€ ê°’ì´ ì‹¤ì œë¡œ íšŒë³µë˜ëŠ” ì–‘
    let actualHeal = Math.min(maxHeal, missingHp);
    
    player.hp += actualHeal;
    updateUI();
    
    showPopup("íœ´ì‹ ì™„ë£Œ", `ì²´ë ¥ì´ ${actualHeal}ë§Œí¼ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.`, [{txt:"ì¶œë°œ", func: startBattle}]);
}
function renderShopScreen() {
    switchScene('event');
    let saleCard = getRandomCard(); 
    let cardData = CARD_DATA[saleCard]; 
    let shopRelic = getRandomItem('relic'); 
    let shopConsumable = getRandomItem('consumable');

    document.getElementById('event-content-box').innerHTML = `
        <div class="event-title">ğŸ’° ìƒì¸</div>
        <div class="event-desc">"ê³¨ë¼ë³´ê²Œë‚˜."<br><span style="color:#f1c40f">ê³¨ë“œ: ${player.gold}</span></div>
        <div class="shop-items">
            <div class="shop-item" onclick="buyShopItem(this, 'card', '${saleCard}', 1000)">
                <div class="card">
                    <div class="card-cost">${cardData.cost}</div>
                    <div class="card-rank">${"â˜…".repeat(cardData.rank)}</div>
                    <div class="card-name">${saleCard}</div>
                    <div class="card-desc">${applyTooltip(cardData.desc)}</div>
                </div>
                <div class="shop-price">1000ì›</div>
            </div>

            <div class="shop-item" onclick="buyShopItem(this, 'relic', '${shopRelic}', ${ITEM_DATA[shopRelic].price})">
                <div class="item-icon item-relic item-rank-${ITEM_DATA[shopRelic].rank}" style="width:80px; height:80px; font-size:2em;">
                    ${ITEM_DATA[shopRelic].icon}
                    <span class="tooltip"><b>${shopRelic}</b><br>${ITEM_DATA[shopRelic].desc}</span>
                </div>
                <div class="shop-price">${ITEM_DATA[shopRelic].price}ì›</div>
                <div style="font-size:0.8em; margin-top:5px;">${shopRelic}</div>
            </div>
            <div class="shop-item" onclick="buyShopItem(this, 'consumable', '${shopConsumable}', ${ITEM_DATA[shopConsumable].price})">
                <div class="item-icon item-consumable item-rank-${ITEM_DATA[shopConsumable].rank}" style="width:80px; height:80px; font-size:2em;">
                    ${ITEM_DATA[shopConsumable].icon}
                    <span class="tooltip"><b>${shopConsumable}</b><br>${ITEM_DATA[shopConsumable].desc}</span>
                </div>
                <div class="shop-price">${ITEM_DATA[shopConsumable].price}ì›</div>
                <div style="font-size:0.8em; margin-top:5px;">${shopConsumable}</div>
            </div>
        </div>
        <button class="action-btn" style="background:#7f8c8d" onclick="startBattle()">ğŸ‘£ ë‚˜ê°€ê¸°</button>`;
}
function buyShopItem(el, type, name, cost) {
    if (el.classList.contains('sold-out')) return;
    if (player.gold < cost) { showPopup("êµ¬ë§¤ ì‹¤íŒ¨", "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", [{txt:"í™•ì¸", func: closePopup}]); return; }
    if (type === 'relic' && player.relics.includes(name)) { showPopup("êµ¬ë§¤ ë¶ˆê°€", "ì´ë¯¸ ë³´ìœ  ì¤‘ì…ë‹ˆë‹¤.", [{txt:"í™•ì¸", func: closePopup}]); return; }
    player.gold -= cost; el.classList.add('sold-out');
    if (type === 'card') { player.deck.push(name); showPopup("ì„±ê³µ", `[${name}] êµ¬ë§¤ ì™„ë£Œ.`, [{txt:"í™•ì¸", func: closePopup}]); }
    else { addItem(name); showPopup("ì„±ê³µ", `[${name}] êµ¬ë§¤ ì™„ë£Œ.`, [{txt:"í™•ì¸", func: closePopup}]); }
    updateUI();
}

/* --- ìœ í‹¸ë¦¬í‹° ë° ê³„ì‚° --- */
function getStat(entity, type) {
    let val = (type==='atk')? entity.baseAtk : (type==='def')? entity.baseDef : entity.baseSpd;
    if (entity === player) { if (type === 'atk' && player.relics.includes("ì¿ ë³´íƒ„")) val += 1; if (type === 'def' && player.relics.includes("ê°•ì¸í•¨ì˜ ë¶€ì ")) val += 1; if (type === 'spd' && player.relics.includes("ì¢‹ì€ ìš´ë™í™”")) val += 1; }
    if (type==='atk') { if (entity.buffs["ì•½í™”"]) val /= 2; if (entity.buffs["ê°•í™”"]) val *= 2; } else if (type==='def') { if (entity.buffs["ì·¨ì•½"]) val /= 2; if (entity.buffs["ê±´ê°•"]) val *= 2; } else if (type==='spd') { if (entity.buffs["ë§ˆë¹„"]) val /= 2; if (entity.buffs["ì¾Œì†"]) val *= 2; }
    return Math.floor(val);
}
function applyBuff(entity, name, dur) { if (name === "ë…" || name === "í™œë ¥") entity.buffs[name] = (entity.buffs[name] || 0) + dur; else entity.buffs[name] = dur; log(`âœ¨ ${entity===player?"ë‚˜":"ì "}ì—ê²Œ [${name}] ì ìš©`); }
function tickBuffs(entity) {
    if (entity.buffs["ë…"]) { let dmg = entity.buffs["ë…"]; log(`â˜ ï¸ ë… í”¼í•´ ${dmg}!`); takeDamage(entity, dmg); }
    if (entity.buffs["í™œë ¥"]) { let heal = entity.buffs["í™œë ¥"]; entity.hp = Math.min(entity.maxHp, entity.hp + heal); log(`ğŸŒ¿ í™œë ¥ íšŒë³µ +${heal}`); updateUI(); }
}
function decrementBuffs(entity) { for (let k in entity.buffs) { entity.buffs[k]--; if (entity.buffs[k] <= 0) delete entity.buffs[k]; } }
function addRandomCard(rank) { let pool = Object.keys(CARD_DATA).filter(k => CARD_DATA[k].rank === rank); player.deck.push(pool[Math.floor(Math.random() * pool.length)]); }
function getRandomCard() { let r = Math.random()*100; let rank = (r<70)?1:(r<95)?2:3; let pool = Object.keys(CARD_DATA).filter(k => CARD_DATA[k].rank === rank); return pool[Math.floor(Math.random()*pool.length)]; }
function getRandomItem(typeFilter) { let pool = Object.keys(ITEM_DATA); if (typeFilter) pool = pool.filter(k => ITEM_DATA[k].type === typeFilter); let r=Math.random()*100; let rank=(r<70)?1:(r<90)?2:3; let rankPool=pool.filter(k=>ITEM_DATA[k].rank===rank); if(rankPool.length===0) rankPool=pool; return rankPool[Math.floor(Math.random()*rankPool.length)]; }

/* --- UI Render Helpers --- */
function drawCards(n) {
    player.hand = [];
    for(let i=0; i<n; i++) {
        if (player.drawPile.length === 0) {
            if (player.discardPile.length > 0) { log("ğŸ”„ ë± ë¦¬í•„!"); player.drawPile = [...player.discardPile]; player.discardPile = []; shuffle(player.drawPile); }
            else break;
        }
        if (player.drawPile.length > 0) player.hand.push(player.drawPile.pop());
    }
    renderHand(); updateUI();
}

function updateUI() {
   // 1. ìƒë‹¨ ì •ë³´ (ë ˆë²¨ | ê²½í—˜ì¹˜ | ê³¨ë“œ)
    // ê²½í—˜ì¹˜ í¼ì„¼íŠ¸ ê³„ì‚°
    let xpPercent = Math.floor((player.xp / player.maxXp) * 100);
    
    document.getElementById('game-info').innerHTML = 
        `Lv.${game.level} <span style="font-size:0.8em; color:#aaa;">(${player.xp}/${player.maxXp})</span> | ğŸ’° ${player.gold}ì›
         <div style="width:100%; height:4px; background:#444; margin-top:5px; border-radius:2px;">
            <div style="width:${xpPercent}%; height:100%; background:#3498db; transition: width 0.3s;"></div>
         </div>`;
    document.getElementById('p-hp').innerText = player.hp; document.getElementById('p-max-hp').innerText = player.maxHp; document.getElementById('p-block').innerText = player.block; document.getElementById('p-hp-bar').style.width = Math.max(0, (player.hp/player.maxHp)*100) + "%"; document.getElementById('p-stats').innerText = `ê³µ${getStat(player,'atk')} ë°©${getStat(player,'def')} ì†${getStat(player,'spd')}`;
    document.getElementById('p-buffs').innerHTML = applyTooltip(Object.entries(player.buffs).map(([k,v])=>`${k}(${v})`).join(', '));
    document.getElementById('e-hp').innerText = enemy.hp; document.getElementById('e-max-hp').innerText = enemy.maxHp; document.getElementById('e-block').innerText = enemy.block; document.getElementById('e-hp-bar').style.width = Math.max(0, (enemy.hp/enemy.maxHp)*100) + "%"; document.getElementById('e-stats').innerText = `ê³µ${getStat(enemy,'atk')} ë°©${getStat(enemy,'def')} ì†${getStat(enemy,'spd')}`;
    document.getElementById('e-buffs').innerHTML = applyTooltip(Object.entries(enemy.buffs).map(([k,v])=>`${k}(${v})`).join(', '));
    
    document.getElementById('btn-draw-pile').innerText = `ë± (${player.drawPile.length})`;
    document.getElementById('btn-discard-pile').innerText = `ë²„ë¦¼ (${player.discardPile.length})`;
    // [NEW] ì†Œë©¸ UI ì—…ë°ì´íŠ¸
    /* [ìˆ˜ì •] updateUI í•¨ìˆ˜ ì•ˆì—ì„œ ì´ ì¤„ì„ ì°¾ì•„ êµì²´í•˜ì„¸ìš” (ì´ëª¨ì§€ ì œê±°) */
document.getElementById('btn-exhaust-pile').innerText = `ì†Œë©¸ (${player.exhaustPile.length})`;
    
    updateInventoryUI();
}

// [ìˆ˜ì •ë¨] renderHand: ì†Œë©¸ ì¹´ë“œë„ ì¼ë°˜ ì¹´ë“œì™€ ë˜‘ê°™ì´ ê·¸ë¦¼
function renderHand() {
    const container = document.getElementById('hand-container'); container.innerHTML = "";
    player.hand.forEach((cName, idx) => {
        let data = CARD_DATA[cName];
        let el = document.createElement('div'); el.className = 'card';
        if (player.ap < data.cost || game.turnOwner !== "player") el.className += " disabled";
el.innerHTML = `
            <div class="card-cost">${data.cost}</div>
            <div class="card-rank">${"â˜…".repeat(data.rank)}</div>
            <div class="card-name">${cName}</div>
            <div class="card-desc">${applyTooltip(data.desc)}</div>
        `;
        el.onclick = () => {
            if (game.turnOwner === "player" && player.ap >= data.cost) {
                player.ap -= data.cost; 
                let usedCard = player.hand.splice(idx, 1)[0];
                
                // [ë¡œì§ ìœ ì§€] ê²‰ëª¨ìŠµì€ ê°™ì§€ë§Œ, ì‚¬ìš©í•˜ë©´ ì—¬ì „íˆ ì†Œë©¸ ë”ë¯¸ë¡œ ê°
                if (data.isExhaust) {
                    player.exhaustPile.push(usedCard);
                    log(`ğŸš« [${cName}] ì¹´ë“œê°€ ì†Œë©¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } else {
                    player.discardPile.push(usedCard);
                }
                
                useCard(player, enemy, cName); renderHand(); document.getElementById('turn-info').innerText = `ë‚˜ì˜ í„´ (í–‰ë™ë ¥: ${player.ap})`; updateUI(); checkGameOver();
            } else if (player.ap < data.cost) log("ğŸš« í–‰ë™ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        }; container.appendChild(el);
    });
}

// [ìˆ˜ì •ë¨] openPileView: ëª©ë¡ ì°½ì—ì„œë„ ì¼ë°˜ ì¹´ë“œì²˜ëŸ¼ ë³´ì´ê²Œ ìˆ˜ì •
function openPileView(type) {
    const title = document.getElementById('popup-title'); const content = document.getElementById('popup-content'); const btns = document.getElementById('popup-buttons');
    content.innerHTML = ""; btns.innerHTML = "<button class='action-btn' onclick='closePopup()'>ë‹«ê¸°</button>";
    
    let sourceArray;
    if (type === 'draw') sourceArray = [...player.drawPile].sort();
    else if (type === 'discard') sourceArray = player.discardPile;
    else if (type === 'exhaust') sourceArray = player.exhaustPile;

    let typeText = (type==='draw')?'ë‚¨ì€ ë±':(type==='discard')?'ë²„ë¦° ì¹´ë“œ':'ì†Œë©¸ëœ ì¹´ë“œ';
    title.innerText = `${typeText} (${sourceArray.length}ì¥)`;
    document.getElementById('popup-desc').innerText = "ì¹´ë“œ ëª©ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤.";
    if (sourceArray.length === 0) content.innerHTML = "<div style='padding:20px; color:#777;'>ë¹„ì–´ìˆìŒ</div>";
    else {
        let listDiv = document.createElement('div'); listDiv.className = 'pile-list';
        sourceArray.forEach(cName => {
            let data = CARD_DATA[cName]; let el = document.createElement('div'); el.className = 'mini-card';
            
            // [ìˆ˜ì •] ë¯¸ë‹ˆ ì¹´ë“œì—ë„ ë³„ ì¶”ê°€
            el.innerHTML = `
                <div>${data.cost} <span style="color:#f1c40f">${"â˜…".repeat(data.rank)}</span></div>
                <b>${cName}</b>
                <div>${applyTooltip(data.desc)}</div>
            `; 
            listDiv.appendChild(el);
        }); content.appendChild(listDiv);
    }
    document.getElementById('popup-layer').style.display = 'flex';
}

function showPopup(title, desc, buttons, contentHTML = "") {
    const layer = document.getElementById('popup-layer'); document.getElementById('popup-title').innerText = title; document.getElementById('popup-desc').innerHTML = desc; document.getElementById('popup-content').innerHTML = contentHTML;
    const btnBox = document.getElementById('popup-buttons'); btnBox.innerHTML = "";
    buttons.forEach(b => { let btn = document.createElement('button'); btn.className = 'action-btn'; btn.style.fontSize = "1em"; btn.style.padding = "5px 15px"; btn.innerText = b.txt; btn.onclick = b.func; btnBox.appendChild(btn); });
    layer.style.display = "flex";
}
function showLevelUp() {
    // game.level++;  <-- [ì‚­ì œ] ì´ ì¤„ì„ ì°¾ì•„ì„œ ì§€ìš°ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”!
    
    showPopup("ğŸ†™ ë ˆë²¨ ì—…!", "ì˜¬ë¦´ ìŠ¤íƒ¯ì„ ì„ íƒí•˜ì„¸ìš”.", [
        {txt: "ê³µê²©ë ¥ +1", func: ()=> { player.baseAtk++; getCardReward(); }},
        {txt: "ë°©ì–´ë ¥ +1", func: ()=> { player.baseDef++; getCardReward(); }},
        {txt: "ì†ë„ +1", func: ()=> { player.baseSpd++; getCardReward(); }}
    ]);
}
function getCardReward() {
    let newCard = getRandomCard(); 
    let data = CARD_DATA[newCard];
    
    // [ìˆ˜ì •] ë³´ìƒ ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸°ì—ë„ ë³„ ì¶”ê°€
    let cardHTML = `
    <div style="display:flex; justify-content:center; margin:10px;">
        <div class="card">
            <div class="card-cost">${data.cost}</div>
            <div class="card-rank">${"â˜…".repeat(data.rank)}</div>
            <div class="card-name">${newCard}</div>
            <div class="card-desc">${applyTooltip(data.desc)}</div>
        </div>
    </div>`;
    
    showPopup("ğŸ ì¹´ë“œ ë³´ìƒ", "íšë“í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [{txt: "ë°›ê¸°", func: ()=>{player.deck.push(newCard); runRandomEvent();}}, {txt: "ê±´ë„ˆë›°ê¸°", func: runRandomEvent}], cardHTML);
}
function closePopup() { document.getElementById('popup-layer').style.display = "none"; }

initGame();

/* [ì¶”ê°€] script íƒœê·¸ ë§¨ ì•„ë˜ìª½ì´ë‚˜ ì ì ˆí•œ ê³³ì— ì¶”ê°€í•˜ì„¸ìš” */

// ë ˆë²¨ì—… ì²˜ë¦¬ ë¡œì§
function processLevelUp() {
    player.xp -= player.maxXp; // ê²½í—˜ì¹˜ ì°¨ê° (ì˜¤ë²„í”Œë¡œìš° ëœ ê²½í—˜ì¹˜ëŠ” ìœ ì§€ë¨)
    game.level++;
    
    // [NEW] ë‹¤ìŒ ë ˆë²¨ í•„ìš” ê²½í—˜ì¹˜ ê³µì‹ (ë ˆë²¨ * 100)
    // ì˜ˆ: 1->2 (100xp), 2->3 (200xp), 3->4 (300xp) ...
    player.maxXp = game.level * 100;
    
    // ê¸°ì¡´ ìŠ¤íƒ¯ ì„ íƒ íŒì—… í˜¸ì¶œ
    showLevelUp(); 
}

// ìŠ¹ë¦¬ í›„ (ë ˆë²¨ì—… ì—†ì„ ë•Œ) ì´ë™ ë¡œì§
function nextStepAfterWin() {
    // ë ˆë²¨ì—…ì„ ì•ˆ í–ˆìœ¼ë©´ ë°”ë¡œ ëœë¤ ì´ë²¤íŠ¸ë¡œ ì´ë™
    runRandomEvent();
}
/* [ì¶”ê°€] ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ í•¨ìˆ˜ */
function playAnim(elementId, animClass) {
    const el = document.getElementById(elementId);
    
    // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±° (ì—°ì† ì¬ìƒì„ ìœ„í•´)
    el.classList.remove('anim-atk-p', 'anim-atk-e', 'anim-hit', 'anim-bounce');
    
    // ê°•ì œ ë¦¬í”Œë¡œìš° (ë¸Œë¼ìš°ì €ê°€ ë³€ê²½ì‚¬í•­ì„ ì¦‰ì‹œ ì¸ì‹í•˜ê²Œ í•¨)
    void el.offsetWidth;
    
    // ìƒˆ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì¶”ê°€
    el.classList.add(animClass);
    
    // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚˜ë©´ í´ë˜ìŠ¤ ì œê±° (ê¹”ë”í•˜ê²Œ)
    setTimeout(() => {
        el.classList.remove(animClass);
    }, 600); // ê°€ì¥ ê¸´ ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„(0.6s)ì— ë§ì¶¤
}
</script>
</body>
</html>